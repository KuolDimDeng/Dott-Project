try{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="48ed039f-a370-4833-80a0-a6d321021d68",e._sentryDebugIdIdentifier="sentry-dbid-48ed039f-a370-4833-80a0-a6d321021d68")}catch(e){}(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[69566],{14469:(e,t,n)=>{Promise.resolve().then(n.bind(n,819400))},819400:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>q});var s=n(695155),a=n(212115),i=n(135695),o=n(42749);async function r(){console.log("[ClientSessionHelper] Getting session...");try{let e=await fetch("/api/auth/session-v2",{method:"GET",credentials:"include",cache:"no-store"});if(console.log("[ClientSessionHelper] Response status:",e.status),!e.ok){if(401===e.status)return console.log("[ClientSessionHelper] No valid session"),{authenticated:!1,user:null};throw Error("Session fetch failed: ".concat(e.status))}let t=await e.json();return console.log("[ClientSessionHelper] Session data:",t),{authenticated:t.authenticated||!1,user:t.user||null}}catch(e){return console.error("[ClientSessionHelper] Error fetching session:",e),{authenticated:!1,user:null}}}async function l(e){return console.warn("[ClientSessionHelper] updateClientSession is deprecated in session-v2 system"),console.warn("[ClientSessionHelper] Session updates are handled server-side automatically"),console.log("[ClientSessionHelper] Requested updates were:",e),await r()}var c=n(455166),d=n(768387);let u={NOT_STARTED:"not_started",BUSINESS_INFO:"business_info",SUBSCRIPTION_SELECTION:"subscription_selection",PAYMENT_PENDING:"payment_pending",PAYMENT_PROCESSING:"payment_processing",COMPLETED:"completed",ERROR:"error"},m={[u.NOT_STARTED]:[u.BUSINESS_INFO],[u.BUSINESS_INFO]:[u.SUBSCRIPTION_SELECTION],[u.SUBSCRIPTION_SELECTION]:[u.PAYMENT_PENDING,u.COMPLETED],[u.PAYMENT_PENDING]:[u.PAYMENT_PROCESSING,u.SUBSCRIPTION_SELECTION],[u.PAYMENT_PROCESSING]:[u.COMPLETED,u.PAYMENT_PENDING],[u.COMPLETED]:[u.SUBSCRIPTION_SELECTION],[u.ERROR]:[u.BUSINESS_INFO]};class g{async initialize(){try{let e=await r();if(!(null==e?void 0:e.authenticated)){this.currentState=null;return}let t=e.user;(null==t?void 0:t.onboardingCompleted)||(null==t?void 0:t.tenantId)?this.currentState=u.COMPLETED:this.currentState=u.NOT_STARTED,this.stateData={businessName:(null==t?void 0:t.businessName)||null,selectedPlan:(null==t?void 0:t.subscriptionPlan)||null,onboardingCompleted:(null==t?void 0:t.onboardingCompleted)||!1},o.vF.info("[OnboardingStateMachine] Initialized",{currentState:this.currentState,stateData:this.stateData})}catch(e){o.vF.error("[OnboardingStateMachine] Initialization error",e),this.currentState=u.ERROR}}getCurrentState(){return this.currentState}canTransitionTo(e){return(m[this.currentState]||[]).includes(e)}async transitionTo(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.canTransitionTo(e))throw Error("Invalid transition from ".concat(this.currentState," to ").concat(e));o.vF.info("[OnboardingStateMachine] Transitioning",{from:this.currentState,to:e,data:t});let n=this.currentState;this.currentState=e,this.stateData=(0,c._)({},this.stateData,t);try{await this.saveProgress()}catch(e){throw o.vF.error("[OnboardingStateMachine] Failed to save progress",e),this.currentState=n,e}return this.currentState}async saveProgress(){let e=(0,d._)((0,c._)({currentStep:this.currentState},this.stateData),{lastUpdated:new Date().toISOString()});await l({onboardingProgress:e,currentStep:this.currentState}),o.vF.info("[OnboardingStateMachine] Progress saved",e)}async submitBusinessInfo(e){if(o.vF.debug("[OnboardingStateMachine] submitBusinessInfo called",{currentState:this.currentState,businessData:e}),this.currentState!==u.NOT_STARTED&&this.currentState!==u.BUSINESS_INFO)throw Error("Invalid state for business info submission");if(!e.businessName||!e.businessType)throw Error("Business name and type are required");this.currentState===u.NOT_STARTED&&await this.transitionTo(u.BUSINESS_INFO,{startedAt:new Date().toISOString()}),await this.transitionTo(u.SUBSCRIPTION_SELECTION,{businessName:e.businessName,businessType:e.businessType,country:e.country,legalStructure:e.legalStructure,dateFounded:e.dateFounded,completedSteps:["business_info"]})}async selectSubscription(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"monthly";if(this.currentState!==u.SUBSCRIPTION_SELECTION&&this.currentState!==u.COMPLETED)throw Error("Invalid state for subscription selection");this.currentState===u.COMPLETED&&(o.vF.info("[OnboardingStateMachine] Re-selecting subscription from completed state"),await this.transitionTo(u.SUBSCRIPTION_SELECTION,{reselecting:!0,previousPlan:this.stateData.selectedPlan}));let n="free"===e?u.COMPLETED:u.PAYMENT_PENDING;await this.transitionTo(n,{selectedPlan:e,billingCycle:t,paymentPending:"free"!==e,completedSteps:[...this.stateData.completedSteps||[],"subscription"]})}async initiatePayment(){if(this.currentState!==u.PAYMENT_PENDING)throw Error("Invalid state for payment initiation");await this.transitionTo(u.PAYMENT_PROCESSING,{paymentStartedAt:new Date().toISOString()})}async completePayment(e){if(this.currentState!==u.PAYMENT_PROCESSING)throw Error("Invalid state for payment completion");await this.transitionTo(u.COMPLETED,{paymentCompleted:!0,paymentId:e.paymentId,subscriptionId:e.subscriptionId,completedSteps:[...this.stateData.completedSteps||[],"payment"],onboardingCompletedAt:new Date().toISOString()})}async handlePaymentFailure(e){this.currentState===u.PAYMENT_PROCESSING&&await this.transitionTo(u.PAYMENT_PENDING,{lastPaymentError:e.message,paymentFailedAt:new Date().toISOString()})}getNextAction(){switch(this.currentState){case u.NOT_STARTED:return{action:"start",url:"/onboarding"};case u.BUSINESS_INFO:return{action:"complete_business_info",url:"/onboarding"};case u.SUBSCRIPTION_SELECTION:return{action:"select_plan",url:"/onboarding"};case u.PAYMENT_PENDING:return{action:"complete_payment",url:"/onboarding/payment"};case u.PAYMENT_PROCESSING:return{action:"wait",message:"Processing payment..."};case u.COMPLETED:return{action:"access_dashboard",url:"/".concat(this.stateData.tenantId,"/dashboard")};case u.ERROR:return{action:"retry",url:"/onboarding"};default:return{action:"unknown",url:"/onboarding"}}}isComplete(){return this.currentState===u.COMPLETED}reset(){this.currentState=u.NOT_STARTED,this.stateData={}}constructor(){this.currentState=null,this.stateData={}}}let b=new g;var p=n(293070);let h={AUTH:"authentication",NETWORK:"network",VALIDATION:"validation",PAYMENT:"payment",SESSION:"session",ONBOARDING:"onboarding",SYSTEM:"system"},y={invalid_credentials:{message:"Invalid email or password",action:"Please check your credentials and try again",category:h.AUTH},email_not_verified:{message:"Email not verified",action:"Please check your email for a verification link",category:h.AUTH},account_locked:{message:"Account temporarily locked",action:"Too many failed attempts. Please try again in 15 minutes",category:h.AUTH},session_expired:{message:"Your session has expired",action:"Please sign in again to continue",category:h.SESSION},network_error:{message:"Connection error",action:"Please check your internet connection and try again",category:h.NETWORK},timeout:{message:"Request timed out",action:"The server is taking too long to respond. Please try again",category:h.NETWORK},ssl_error:{message:"Secure connection failed",action:"There was a problem establishing a secure connection. Please refresh and try again",category:h.NETWORK},missing_required_fields:{message:"Required information missing",action:"Please fill in all required fields",category:h.VALIDATION},invalid_email:{message:"Invalid email address",action:"Please enter a valid email address",category:h.VALIDATION},password_too_weak:{message:"Password too weak",action:"Password must be at least 8 characters with a mix of letters and numbers",category:h.VALIDATION},payment_failed:{message:"Payment failed",action:"Please check your payment details and try again",category:h.PAYMENT},card_declined:{message:"Card declined",action:"Your card was declined. Please try a different payment method",category:h.PAYMENT},insufficient_funds:{message:"Insufficient funds",action:"Please ensure sufficient funds and try again",category:h.PAYMENT},onboarding_incomplete:{message:"Onboarding not complete",action:"Please complete all onboarding steps to access the dashboard",category:h.ONBOARDING},invalid_state_transition:{message:"Invalid action",action:"This action cannot be performed at this time",category:h.ONBOARDING},rate_limit:{message:"Too many requests",action:"Please wait a moment before trying again",category:h.SYSTEM},server_error:{message:"Something went wrong",action:"An unexpected error occurred. Please try again later",category:h.SYSTEM},maintenance:{message:"System maintenance",action:"We're performing maintenance. Please try again in a few minutes",category:h.SYSTEM}};class f{handle(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o.vF.error("[ErrorHandler] Error occurred",{error:e.message||e,context:t,stack:e.stack});let n=this.identifyError(e),s=this.getRecoverySuggestions(n,t);return(0,d._)((0,c._)({},n),{recovery:s,timestamp:new Date().toISOString(),reference:this.generateErrorReference()})}identifyError(e){var t;if(e.code&&y[e.code])return y[e.code];let n=(null==(t=e.message)?void 0:t.toLowerCase())||"";return n.includes("unauthorized")||n.includes("401")?y.session_expired:n.includes("invalid")&&n.includes("password")?y.invalid_credentials:n.includes("network")||n.includes("fetch")?y.network_error:n.includes("timeout")?y.timeout:n.includes("ssl")||n.includes("certificate")?y.ssl_error:n.includes("payment")||n.includes("stripe")?y.payment_failed:n.includes("declined")?y.card_declined:n.includes("rate limit")||n.includes("429")?y.rate_limit:y.server_error}getRecoverySuggestions(e,t){let n=[];switch(e.category){case h.AUTH:n.push({action:"retry_login",label:"Try signing in again"}),n.push({action:"reset_password",label:"Reset your password"});break;case h.SESSION:n.push({action:"refresh",label:"Refresh the page"}),n.push({action:"login",label:"Sign in again"});break;case h.NETWORK:n.push({action:"retry",label:"Try again"}),n.push({action:"check_connection",label:"Check your connection"});break;case h.PAYMENT:n.push({action:"update_payment",label:"Update payment method"}),n.push({action:"contact_support",label:"Contact support"});break;case h.ONBOARDING:n.push({action:"continue_onboarding",label:"Continue setup"}),n.push({action:"restart_onboarding",label:"Start over"});break;default:n.push({action:"retry",label:"Try again"}),n.push({action:"contact_support",label:"Get help"})}return n}generateErrorReference(){return"ERR-".concat(Date.now().toString(36).toUpperCase())}toComponentProps(e,t){let n=this.handle(e,t);return{title:n.message,description:n.action,suggestions:n.recovery,reference:n.reference,severity:this.getSeverity(n.category),showContactSupport:n.category===h.SYSTEM}}getSeverity(e){switch(e){case h.AUTH:case h.SESSION:return"warning";case h.PAYMENT:case h.SYSTEM:return"error";default:return"info"}}isRetryable(e){let t=this.identifyError(e);return[h.NETWORK,h.SYSTEM].includes(t.category)&&t.message!==y.rate_limit.message}getRetryDelay(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this.identifyError(e).message===y.rate_limit.message?6e4:Math.min(1e3*Math.pow(2,t-1),3e4)}}let S=new f;class x{async request(e){let t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o.vF.debug("[ApiClient] Request started",{url:e,method:n.method||"GET",hasBody:!!n.body});let s=new AbortController,a=setTimeout(()=>s.abort(),this.timeout),i=(0,d._)((0,c._)({},n),{credentials:"include",signal:s.signal,headers:(0,c._)({"Content-Type":"application/json"},n.headers)}),r=await p.sessionManagerEnhanced.getSession();o.vF.debug("[ApiClient] Session check:",{hasSession:!!r,authenticated:null==r?void 0:r.authenticated,hasSessionToken:!!(null==r?void 0:r.sessionToken),hasAccessToken:!!(null==r?void 0:r.accessToken),sessionTokenType:(null==r?void 0:r.sessionToken)?typeof r.sessionToken:"none",sessionTokenPreview:(null==r?void 0:r.sessionToken)?r.sessionToken.substring(0,20)+"...":"none"}),(null==r?void 0:r.authenticated)&&(r.sessionToken?(i.headers.Authorization="Session ".concat(r.sessionToken),o.vF.debug("[ApiClient] Added session token to Authorization header")):r.accessToken?(i.headers.Authorization="Bearer ".concat(r.accessToken),o.vF.debug("[ApiClient] Added access token to Authorization header (fallback)")):o.vF.debug("[ApiClient] Session is authenticated, relying on cookies (no session/access token available)")),o.vF.debug("[ApiClient] Final request headers:",(0,d._)((0,c._)({},i.headers),{credentials:i.credentials}));let l=0;for(;l<this.maxRetries;)try{l++,o.vF.debug("[ApiClient] Request attempt ".concat(l),{url:e,method:n.method});let s=await fetch(e,i);if(clearTimeout(a),!s.ok){let e=s.clone(),n=await this.parseErrorResponse(e);if(s.status>=400&&s.status<500)throw n;if(t=n,l<this.maxRetries){let e=S.getRetryDelay(n,l);o.vF.warn("[ApiClient] Retrying after ".concat(e,"ms due to:"),n.message),await this.delay(e);continue}}let r=s.clone();return await this.parseResponse(r)}catch(e){if(clearTimeout(a),"AbortError"===e.name?(t=Error("Request timeout")).code="timeout":t=e,l<this.maxRetries&&S.isRetryable(t)){let e=S.getRetryDelay(t,l);o.vF.warn("[ApiClient] Retrying after ".concat(e,"ms due to:"),t.message),await this.delay(e);continue}break}throw t}async parseErrorResponse(e){let t;try{t=await e.json()}catch(n){t={message:"HTTP ".concat(e.status,": ").concat(e.statusText)}}let n=Error(t.message||t.error||"Request failed");return n.status=e.status,n.code=t.code||this.getErrorCode(e.status),n.details=t,n}async parseResponse(e){let t=e.headers.get("content-type");return(null==t?void 0:t.includes("application/json"))?await e.json():await e.text()}getErrorCode(e){switch(e){case 401:return"unauthorized";case 403:return"forbidden";case 404:return"not_found";case 429:return"rate_limit";case 500:return"server_error";case 503:return"maintenance";default:return"unknown_error"}}delay(e){return new Promise(t=>setTimeout(t,e))}async get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(e,(0,d._)((0,c._)({},t),{method:"GET"}))}async post(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return o.vF.info("[ApiClient] POST request:",{url:e,data:t}),console.log("\uD83D\uDEA8 [ApiClient] POST data being sent:",JSON.stringify(t,null,2)),this.request(e,(0,d._)((0,c._)({},n),{method:"POST",body:JSON.stringify(t)}))}async put(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.request(e,(0,d._)((0,c._)({},n),{method:"PUT",body:JSON.stringify(t)}))}async delete(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(e,(0,d._)((0,c._)({},t),{method:"DELETE"}))}async updateSession(e){throw console.warn("[ApiClient] updateSession is deprecated in session-v2 system"),console.warn("[ApiClient] Session updates are handled server-side automatically"),console.log("[ApiClient] Requested updates were:",e),Error("updateSession is deprecated - session updates are handled server-side in session-v2 system")}async completeOnboarding(e){return this.post("/api/onboarding/complete-all",e)}async createPaymentSession(e,t){return this.post("/api/payments/create-session",{plan:e,billingCycle:t})}async verifyPayment(e){return this.post("/api/payments/verify",{sessionId:e})}constructor(){this.baseURL="https://dott-api-y26w.onrender.com",this.maxRetries=3,this.retryDelay=1e3,this.timeout=3e4}}let N=new x;var v=n(177657),w=n(80735),T=n(678007),E=n(114719);function _(e){let{initialData:t={},onSubmit:n,submitting:i,error:r}=e,{t:l}=(0,w.Bd)("onboarding"),[u,m]=(0,a.useState)({businessName:t.businessName||"",businessType:t.businessType||"",legalStructure:t.legalStructure||"",country:t.country||"US",dateFounded:t.dateFounded||new Date().toISOString().split("T")[0]}),[g,b]=(0,a.useState)({}),[p,h]=(0,a.useState)({}),y=(0,a.useMemo)(()=>Object.entries(T.Xr).map(e=>{let[t,n]=e;return{value:t,label:n.name,code:t}}).sort((e,t)=>e.label.localeCompare(t.label)),[]),f=(0,a.useMemo)(()=>E.AH.map(e=>({value:e,label:e})),[]),S=(0,a.useMemo)(()=>E.AP.map(e=>({value:e,label:e})),[]);(0,a.useEffect)(()=>{t&&m(e=>(0,c._)({},e,t))},[t]);let x=(e,t)=>{console.log("\uD83D\uDEA8 [BusinessInfoForm] Field change: ".concat(e,' = "').concat(t,'"')),m(n=>{let s=(0,d._)((0,c._)({},n),{[e]:t});return console.log("\uD83D\uDEA8 [BusinessInfoForm] Updated form data:",s),s}),g[e]&&b(t=>(0,d._)((0,c._)({},t),{[e]:null}))},N=e=>{h(t=>(0,d._)((0,c._)({},t),{[e]:!0})),v(e)},v=e=>{let t={};switch(e){case"businessName":u.businessName.trim()?u.businessName.length<2&&(t.businessName=l("businessInfo.errors.businessNameTooShort",{defaultValue:"Business name must be at least 2 characters"})):t.businessName=l("businessInfo.errors.businessNameRequired");break;case"businessType":u.businessType||(t.businessType=l("businessInfo.errors.businessTypeRequired"));break;case"legalStructure":u.legalStructure||(t.legalStructure=l("businessInfo.errors.legalStructureRequired"));break;case"country":u.country||(t.country=l("businessInfo.errors.countryRequired"))}return b(e=>(0,c._)({},e,t)),0===Object.keys(t).length},_=()=>{let e={};return u.businessName.trim()||(e.businessName=l("businessInfo.errors.businessNameRequired")),u.businessType||(e.businessType=l("businessInfo.errors.businessTypeRequired")),u.legalStructure||(e.legalStructure=l("businessInfo.errors.legalStructureRequired")),u.country||(e.country=l("businessInfo.errors.countryRequired")),b(e),h({businessName:!0,businessType:!0,legalStructure:!0,country:!0}),0===Object.keys(e).length},P=async e=>{if(e.preventDefault(),!_()){o.vF.warn("[BusinessInfoForm] Validation failed",g),console.log("\uD83D\uDEA8 [BusinessInfoForm] Validation errors:",g);return}o.vF.info("[BusinessInfoForm] Submitting business info",u),console.log("\uD83D\uDEA8 [BusinessInfoForm] Form data being submitted:",JSON.stringify(u,null,2)),console.log("\uD83D\uDEA8 [BusinessInfoForm] Individual fields:",{businessName:u.businessName,businessType:u.businessType,country:u.country,legalStructure:u.legalStructure,dateFounded:u.dateFounded}),await n(u)};return(0,s.jsxs)("form",{onSubmit:P,className:"bg-white rounded-lg shadow p-6",children:[(0,s.jsx)("h2",{className:"text-2xl font-bold mb-6",children:l("businessInfo.subtitle")}),r&&(0,s.jsx)("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded text-red-700",children:r}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[l("businessInfo.businessNameLabel")," *"]}),(0,s.jsx)("input",{type:"text",value:u.businessName,onChange:e=>x("businessName",e.target.value),onBlur:()=>N("businessName"),placeholder:l("businessInfo.businessNamePlaceholder"),className:"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ".concat(g.businessName&&p.businessName?"border-red-500":"border-gray-300"),disabled:i}),g.businessName&&p.businessName&&(0,s.jsx)("p",{className:"mt-1 text-sm text-red-600",children:g.businessName})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[l("businessInfo.businessTypeLabel")," *"]}),(0,s.jsxs)("select",{value:u.businessType,onChange:e=>x("businessType",e.target.value),onBlur:()=>N("businessType"),className:"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ".concat(g.businessType&&p.businessType?"border-red-500":"border-gray-300"),disabled:i,children:[(0,s.jsx)("option",{value:"",children:l("businessInfo.businessTypePlaceholder")}),f.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))]}),g.businessType&&p.businessType&&(0,s.jsx)("p",{className:"mt-1 text-sm text-red-600",children:g.businessType})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[l("businessInfo.legalStructureLabel")," *"]}),(0,s.jsxs)("select",{value:u.legalStructure,onChange:e=>x("legalStructure",e.target.value),onBlur:()=>N("legalStructure"),className:"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ".concat(g.legalStructure&&p.legalStructure?"border-red-500":"border-gray-300"),disabled:i,children:[(0,s.jsx)("option",{value:"",children:l("businessInfo.legalStructurePlaceholder")}),S.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))]}),g.legalStructure&&p.legalStructure&&(0,s.jsx)("p",{className:"mt-1 text-sm text-red-600",children:g.legalStructure})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[l("businessInfo.countryLabel")," *"]}),(0,s.jsxs)("select",{value:u.country,onChange:e=>x("country",e.target.value),onBlur:()=>N("country"),className:"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ".concat(g.country&&p.country?"border-red-500":"border-gray-300"),disabled:i,children:[(0,s.jsx)("option",{value:"",children:l("businessInfo.countryPlaceholder")}),y.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.code))]}),g.country&&p.country&&(0,s.jsx)("p",{className:"mt-1 text-sm text-red-600",children:g.country})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:l("businessInfo.dateFoundedLabel")}),(0,s.jsx)("input",{type:"date",value:u.dateFounded,onChange:e=>x("dateFounded",e.target.value),max:new Date().toISOString().split("T")[0],className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:i})]})]}),(0,s.jsx)("div",{className:"mt-6",children:(0,s.jsx)("button",{type:"submit",disabled:i,className:"w-full py-3 px-4 font-medium rounded-md transition-colors ".concat(i?"bg-gray-400 text-gray-200 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"),children:i?l("businessInfo.saving",{defaultValue:"Saving..."}):l("businessInfo.nextButton")})})]})}var P=n(148585),I=n(29670);let O={USD:1,EUR:.85,GBP:.73,CAD:1.25,AUD:1.35,JPY:110,CNY:6.45,INR:74.5,BRL:5.2,MXN:20.1,ZAR:14.8,NGN:411,KES:108,GHS:6.1,EGP:15.7,MAD:9,TND:2.8,DZD:134,XOF:558,XAF:558};async function C(e){try{if("USD"===e)return 1;let t="exchange_rate_USD_".concat(e),n=(0,I.gd)(t);if(n)return console.log("✅ Using cached exchange rate USD to ".concat(e,": ").concat(n)),n;let s=await F(e);return s||((s=O[e])?console.log("⚠️ Using fallback exchange rate USD to ".concat(e,": ").concat(s)):(console.warn("❌ No exchange rate available for ".concat(e,", using 1.0")),s=1)),(0,I.mm)(t,s,{ttl:36e5}),s}catch(t){return console.error("❌ Error getting exchange rate for ".concat(e,":"),t),O[e]||1}}async function F(e){try{let t=await fetch("https://api.exchangerate-api.com/v4/latest/USD");if(t.ok){let n=(await t.json()).rates[e];if(n)return console.log("✅ Fetched exchange rate USD to ".concat(e,": ").concat(n)),n}let n=await fetch("https://api.fxratesapi.com/latest?base=USD&symbols=".concat(e));if(n.ok){let t=(await n.json()).rates[e];if(t)return console.log("✅ Fetched exchange rate USD to ".concat(e,": ").concat(t)),t}}catch(t){console.warn("⚠️ Failed to fetch exchange rate from API for ".concat(e,":"),t.message)}return null}async function R(e,t){return e*await C(t)}let D={KE:{name:"Kenya",discount:50},NG:{name:"Nigeria",discount:50},GH:{name:"Ghana",discount:50},ZA:{name:"South Africa",discount:50},TZ:{name:"Tanzania",discount:50},UG:{name:"Uganda",discount:50},ET:{name:"Ethiopia",discount:50},RW:{name:"Rwanda",discount:50},ZM:{name:"Zambia",discount:50},ZW:{name:"Zimbabwe",discount:50},MW:{name:"Malawi",discount:50},MZ:{name:"Mozambique",discount:50},BW:{name:"Botswana",discount:50},NA:{name:"Namibia",discount:50},SN:{name:"Senegal",discount:50},CI:{name:"C\xf4te d'Ivoire",discount:50},CM:{name:"Cameroon",discount:50},AO:{name:"Angola",discount:50},GA:{name:"Gabon",discount:50},CG:{name:"Congo",discount:50},CD:{name:"Democratic Republic of Congo",discount:50},SD:{name:"Sudan",discount:50},EG:{name:"Egypt",discount:50},MA:{name:"Morocco",discount:50},TN:{name:"Tunisia",discount:50},DZ:{name:"Algeria",discount:50},LY:{name:"Libya",discount:50},IN:{name:"India",discount:50},BD:{name:"Bangladesh",discount:50},PK:{name:"Pakistan",discount:50},ID:{name:"Indonesia",discount:50},PH:{name:"Philippines",discount:50},VN:{name:"Vietnam",discount:50},TH:{name:"Thailand",discount:50},MM:{name:"Myanmar",discount:50},KH:{name:"Cambodia",discount:50},LA:{name:"Laos",discount:50},NP:{name:"Nepal",discount:50},LK:{name:"Sri Lanka",discount:50},AF:{name:"Afghanistan",discount:50},BR:{name:"Brazil",discount:50},MX:{name:"Mexico",discount:50},AR:{name:"Argentina",discount:50},CO:{name:"Colombia",discount:50},PE:{name:"Peru",discount:50},VE:{name:"Venezuela",discount:50},EC:{name:"Ecuador",discount:50},BO:{name:"Bolivia",discount:50},PY:{name:"Paraguay",discount:50},UY:{name:"Uruguay",discount:50},GT:{name:"Guatemala",discount:50},HN:{name:"Honduras",discount:50},SV:{name:"El Salvador",discount:50},NI:{name:"Nicaragua",discount:50},CR:{name:"Costa Rica",discount:50},PA:{name:"Panama",discount:50},DO:{name:"Dominican Republic",discount:50},HT:{name:"Haiti",discount:50},JM:{name:"Jamaica",discount:50},IQ:{name:"Iraq",discount:50},YE:{name:"Yemen",discount:50},SY:{name:"Syria",discount:50},JO:{name:"Jordan",discount:50},LB:{name:"Lebanon",discount:50},PS:{name:"Palestine",discount:50},UA:{name:"Ukraine",discount:50},MD:{name:"Moldova",discount:50},AL:{name:"Albania",discount:50},BA:{name:"Bosnia and Herzegovina",discount:50},RS:{name:"Serbia",discount:50},ME:{name:"Montenegro",discount:50},MK:{name:"North Macedonia",discount:50},XK:{name:"Kosovo",discount:50},PG:{name:"Papua New Guinea",discount:50},FJ:{name:"Fiji",discount:50},WS:{name:"Samoa",discount:50},TO:{name:"Tonga",discount:50},VU:{name:"Vanuatu",discount:50},SB:{name:"Solomon Islands",discount:50}},j=[{id:"free",name:"Basic",description:"Perfect for small businesses just getting started",price:"Free",monthlyPrice:0,sixMonthPrice:0,yearlyPrice:0,features:["Income and expense tracking","Invoice creation & reminders","Stripe & PayPal payments","Mobile money (M-Pesa, etc.)","Basic inventory tracking","Barcode scanning","3GB storage limit","1 user only"],buttonText:"Start for Free"},{id:"professional",name:"Professional",description:"Everything growing businesses need to thrive",price:"$15/mo",monthlyPrice:15,sixMonthPrice:75,yearlyPrice:144,features:["Everything in Basic","Up to 3 users","Unlimited storage","Priority support","All features included","17% discount on 6-month","20% discount on annual"],popular:!0,buttonText:"Choose Professional"},{id:"enterprise",name:"Enterprise",description:"Unlimited scale for ambitious organizations",price:"$45/mo",monthlyPrice:45,sixMonthPrice:225,yearlyPrice:432,features:["Everything in Professional","Unlimited users","Custom onboarding","Dedicated support","All features included","17% discount on 6-month","20% discount on annual"],premium:!0,buttonText:"Choose Enterprise"}];function A(e){let{initialData:t={},onSelect:n,submitting:i,error:r,onBack:l}=e,{t:c}=(0,w.Bd)("onboarding"),[d,u]=(0,a.useState)(t.selectedPlan||""),[m,g]=(0,a.useState)(t.billingCycle||"monthly"),[b,p]=(0,a.useState)(null),[h,y]=(0,a.useState)(!0),[f,S]=(0,a.useState)([]),[x,N]=(0,a.useState)(null),[v,T]=(0,a.useState)(null);(0,a.useEffect)(()=>{(async()=>{if(console.log("\uD83C\uDFAF [SubscriptionSelection] === START PRICING FETCH ==="),console.log("\uD83C\uDFAF [SubscriptionSelection] Initial data received:",t),console.log("\uD83C\uDFAF [SubscriptionSelection] Country value:",t.country),console.log("\uD83C\uDFAF [SubscriptionSelection] All initial data keys:",Object.keys(t)),!t.country){console.log("\uD83C\uDFAF [SubscriptionSelection] No country data, using default US pricing"),y(!1);return}try{var e,n;o.vF.info("[SubscriptionSelection] Fetching regional pricing for:",t.country);let s=(0,P.gI)(t.country)||t.country;o.vF.info("[SubscriptionSelection] Converting country:",{input:t.country,output:s,isCode:(null==(e=t.country)?void 0:e.length)===2});let a={US:"USD",GB:"GBP",CA:"CAD",AU:"AUD",NZ:"NZD",EU:"EUR",FR:"EUR",DE:"EUR",IT:"EUR",ES:"EUR",NL:"EUR",BE:"EUR",AT:"EUR",PT:"EUR",IE:"EUR",JP:"JPY",CN:"CNY",IN:"INR",BR:"BRL",MX:"MXN",ZA:"ZAR",NG:"NGN",KE:"KES",GH:"GHS",EG:"EGP",MA:"MAD",TN:"TND",DZ:"DZD",RU:"RUB",TR:"TRY",ID:"IDR",MY:"MYR",TH:"THB",VN:"VND",PH:"PHP",SG:"SGD",HK:"HKD",KR:"KRW",TW:"TWD",SN:"XOF",CI:"XOF",BF:"XOF",ML:"XOF",NE:"XOF",TG:"XOF",BJ:"XOF",GW:"XOF",CM:"XAF",CF:"XAF",TD:"XAF",CG:"XAF",GQ:"XAF",GA:"XAF"}[s]||"USD";if(N(a),console.log("\uD83C\uDFAF [SubscriptionSelection] Local currency:",a),"USD"!==a)try{let e=await R(1,a);T(e),console.log("\uD83C\uDFAF [SubscriptionSelection] Exchange rate: 1 USD =",e,a)}catch(e){console.error("\uD83C\uDFAF [SubscriptionSelection] Error getting exchange rate:",e)}let i="/api/pricing/by-country?country=".concat(encodeURIComponent(s));console.log("\uD83C\uDFAF [SubscriptionSelection] Fetching pricing from URL:",i),console.log("\uD83C\uDFAF [SubscriptionSelection] Country parameter:",s);let r=await fetch(i,{headers:{"X-Country-Override":s}});console.log("\uD83C\uDFAF [SubscriptionSelection] Response status:",r.status),console.log("\uD83C\uDFAF [SubscriptionSelection] Response headers:",Object.fromEntries(r.headers.entries()));let l=await r.json();if(console.log("\uD83C\uDFAF [SubscriptionSelection] === PRICING RESPONSE ==="),console.log("\uD83C\uDFAF [SubscriptionSelection] Regional pricing data:",l),console.log("\uD83C\uDFAF [SubscriptionSelection] Country code returned:",l.country_code),console.log("\uD83C\uDFAF [SubscriptionSelection] Discount percentage:",l.discount_percentage),console.log("\uD83C\uDFAF [SubscriptionSelection] Pricing object:",l.pricing),s&&D.hasOwnProperty(s.toUpperCase())&&0===l.discount_percentage){let e=function(e){if(!e)return 0;let t=D[e.toUpperCase()];return t?t.discount:0}(s);console.warn("\uD83C\uDFAF [SubscriptionSelection] ⚠️ WARNING: ".concat(s," should have ").concat(e,"% discount but got 0%")),console.warn("\uD83C\uDFAF [SubscriptionSelection] Backend may not be processing country correctly"),console.warn("\uD83C\uDFAF [SubscriptionSelection] Applying client-side discount for ".concat(s)),l.country_code=s,l.discount_percentage=e;let t=1-e/100;l.pricing&&(l.pricing.professional={monthly:15*t,six_month:78*t,yearly:144*t,monthly_display:"$".concat((15*t).toFixed(2)),six_month_display:"$".concat((78*t).toFixed(2)),yearly_display:"$".concat((144*t).toFixed(2))},l.pricing.enterprise={monthly:45*t,six_month:234*t,yearly:432*t,monthly_display:"$".concat((45*t).toFixed(2)),six_month_display:"$".concat((234*t).toFixed(2)),yearly_display:"$".concat((432*t).toFixed(2))})}p(l);let c=await fetch("/api/payment-methods/available?country=".concat(encodeURIComponent(s))),d=await c.json();console.log("\uD83C\uDFAF [SubscriptionSelection] Available payment methods:",d),console.log("\uD83C\uDFAF [SubscriptionSelection] M-Pesa available?",null==(n=d.methods)?void 0:n.includes("mpesa")),S(d.methods||[])}catch(e){o.vF.error("[SubscriptionSelection] Error fetching regional pricing:",e),console.error("\uD83C\uDFAF [SubscriptionSelection] Full error:",e)}finally{y(!1),console.log("\uD83C\uDFAF [SubscriptionSelection] === END PRICING FETCH ===")}})()},[t.country]);let E=async e=>{u(e),o.vF.info("[SubscriptionSelection] Plan selected",{planId:e,billingCycle:m}),await n(e,m)},_=e=>{g(e),o.vF.info("[SubscriptionSelection] Billing cycle changed",{cycle:e})},I=function(e){if(arguments.length>1&&void 0!==arguments[1]&&arguments[1],!e||0===e)return c("subscription.plans.basic.price");let t="$".concat(e);if(x&&"USD"!==x&&v){let n=function(e,t){try{return new Intl.NumberFormat("en-US",{style:"currency",currency:t,minimumFractionDigits:2*("JPY"!==t),maximumFractionDigits:2*("JPY"!==t)}).format(e)}catch(n){return console.warn("⚠️ Failed to format currency ".concat(t,":"),n),"".concat(t," ").concat(e.toFixed(2))}}(Math.round(e*v),x);t+=" (".concat(n,")")}return t};return(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsx)("h2",{className:"text-2xl font-bold mb-2",children:c("subscription.title")}),(0,s.jsx)("p",{className:"text-gray-600",children:c("subscription.subtitle")})]}),r&&(0,s.jsx)("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded text-red-700",children:r}),b&&b.discount_percentage>0&&(0,s.jsx)("div",{className:"mb-4 p-4 bg-green-50 border border-green-200 rounded",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("span",{className:"text-2xl mr-2",children:"\uD83C\uDF89"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-green-800 font-semibold",children:c("subscription.regionalDiscount.badge",{percentage:b.discount_percentage})}),(0,s.jsx)("p",{className:"text-green-700 text-sm",children:c("subscription.regionalDiscount.description",{country:(0,P.qQ)(t.country)||t.country||c("subscription.regionalDiscount.yourRegion")})})]})]})}),f.length>0&&f.includes("mpesa")&&(0,s.jsx)("div",{className:"mb-4 p-4 bg-blue-50 border border-blue-200 rounded",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("svg",{className:"w-6 h-6 text-green-600 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-green-800 font-semibold",children:c("subscription.paymentMethods.mpesa.title")}),(0,s.jsx)("p",{className:"text-green-700 text-sm",children:c("subscription.paymentMethods.mpesa.description")}),x&&"USD"!==x&&(0,s.jsx)("p",{className:"text-green-600 text-xs mt-1",children:c("subscription.paymentMethods.mpesa.payInCurrency",{currency:x})})]})]})}),(0,s.jsx)("div",{className:"flex justify-center mb-8",children:(0,s.jsxs)("div",{className:"flex items-center space-x-2 bg-gray-100 rounded-lg p-1",children:[(0,s.jsx)("button",{onClick:()=>_("monthly"),className:"px-4 py-2 rounded-md text-sm font-medium transition-colors ".concat("monthly"===m?"bg-white text-gray-900 shadow":"text-gray-600 hover:text-gray-900"),disabled:i,children:c("subscription.billingCycle.monthly")}),(0,s.jsxs)("button",{onClick:()=>_("6month"),className:"px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center ".concat("6month"===m?"bg-white text-gray-900 shadow":"text-gray-600 hover:text-gray-900"),disabled:i,children:[c("subscription.billingCycle.sixMonth"),(0,s.jsx)("span",{className:"ml-1 bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-full",children:c("subscription.billingCycle.popular")})]}),(0,s.jsxs)("button",{onClick:()=>_("yearly"),className:"px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center ".concat("yearly"===m?"bg-white text-gray-900 shadow":"text-gray-600 hover:text-gray-900"),disabled:i,children:[c("subscription.billingCycle.yearly"),(0,s.jsx)("span",{className:"ml-1 text-xs text-green-600 font-normal",children:c("subscription.billingCycle.save",{percentage:20})})]})]})}),h?(0,s.jsx)("div",{className:"flex justify-center items-center py-12",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):(0,s.jsx)("div",{className:"grid gap-6 md:grid-cols-3",children:j.map(e=>{var t,n,a;return(0,s.jsxs)("div",{className:"relative rounded-lg border-2 p-6 overflow-hidden ".concat(e.popular?"border-blue-500 shadow-lg":e.premium?"border-purple-500":"border-gray-200"," ").concat(d===e.id?"ring-2 ring-blue-500":""),children:[e.popular&&"6month"===m&&(0,s.jsx)("div",{className:"absolute -top-4 left-1/2 transform -translate-x-1/2",children:(0,s.jsx)("span",{className:"bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-full",children:c("subscription.plans.professional.popularBadge")})}),e.premium&&(0,s.jsx)("div",{className:"absolute -top-4 left-1/2 transform -translate-x-1/2",children:(0,s.jsx)("span",{className:"bg-purple-500 text-white text-xs font-bold px-3 py-1 rounded-full",children:c("subscription.plans.enterprise.premiumBadge")})}),(0,s.jsxs)("div",{className:"text-center mb-4",children:[(0,s.jsx)("h3",{className:"text-xl font-bold mb-2 break-words",children:c("subscription.plans.".concat(e.id,".name"))}),(0,s.jsx)("p",{className:"text-sm text-gray-600 mb-4 break-words",children:c("subscription.plans.".concat(e.id,".description"))}),(0,s.jsx)("div",{className:"mb-4",children:"free"===e.id?(0,s.jsx)("div",{className:"text-3xl font-bold",children:c("subscription.plans.basic.price")}):(0,s.jsxs)("div",{children:[b&&b.discount_percentage>0?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"text-3xl font-bold",children:I("monthly"===m?null==(t=b.pricing[e.id])?void 0:t.monthly:"6month"===m?null==(n=b.pricing[e.id])?void 0:n.six_month:null==(a=b.pricing[e.id])?void 0:a.yearly,!1)}),(0,s.jsxs)("div",{className:"text-sm text-gray-500 line-through",children:["$","monthly"===m?e.monthlyPrice:"6month"===m?e.sixMonthPrice:e.yearlyPrice]}),(0,s.jsx)("div",{className:"text-sm text-green-600 font-semibold",children:c("subscription.regionalDiscount.percentOff",{percentage:b.discount_percentage})})]}):(0,s.jsx)("div",{className:"text-3xl font-bold",children:I("monthly"===m?e.monthlyPrice:"6month"===m?e.sixMonthPrice:e.yearlyPrice,!1)}),"6month"===m&&"free"!==e.id&&(0,s.jsx)("div",{className:"text-sm text-orange-600 mt-1",children:c("subscription.savings.sixMonth",{amount:6*e.monthlyPrice-e.sixMonthPrice,monthly:(e.sixMonthPrice/6).toFixed(2)})}),"yearly"===m&&"free"!==e.id&&(0,s.jsx)("div",{className:"text-sm text-green-600 mt-1",children:c("subscription.savings.yearly",{amount:12*e.monthlyPrice-e.yearlyPrice})})]})})]}),(0,s.jsx)("ul",{className:"space-y-2 mb-6",children:e.features.map((t,n)=>{let a=t;try{if(t.includes("{{"))a=c("subscription.plans.".concat(e.id,".features.").concat(n),{discount:17,yearlyDiscount:20});else{let s="subscription.plans.".concat(e.id,".features.").concat(n);a=c(s,{defaultValue:t})}}catch(e){a=t}return(0,s.jsxs)("li",{className:"flex items-start",children:[(0,s.jsx)("svg",{className:"w-5 h-5 text-green-500 mr-2 flex-shrink-0 mt-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),(0,s.jsx)("span",{className:"text-sm text-gray-700",children:a})]},n)})}),(0,s.jsx)("button",{onClick:()=>E(e.id),disabled:i,className:"w-full py-2 px-4 rounded-md font-medium transition-colors ".concat(i?"bg-gray-400 text-gray-200 cursor-not-allowed":e.popular&&"6month"===m?"bg-orange-600 text-white hover:bg-orange-700":e.popular?"bg-blue-600 text-white hover:bg-blue-700":e.premium?"bg-purple-600 text-white hover:bg-purple-700":"bg-gray-800 text-white hover:bg-gray-900"),children:i&&d===e.id?c("subscription.processing"):c("subscription.plans.".concat(e.id,".buttonText"))})]},e.id)})}),l&&(0,s.jsx)("div",{className:"mt-8 text-center",children:(0,s.jsx)("button",{onClick:l,disabled:i,className:"text-gray-600 hover:text-gray-800 underline",children:c("subscription.backButton")})}),(0,s.jsx)("div",{className:"mt-8 text-center text-sm text-gray-600",children:(0,s.jsx)("p",{children:c("subscription.note")})})]})}var M=n(849160),k=n(183731),U=n(231022);function B(e){let{initialStep:t,initialCountry:n}=e,r=(0,i.useRouter)(),l=(0,k.sf)(),[m,g]=(0,a.useState)(!0),[h,y]=(0,a.useState)(null),[f,x]=(0,a.useState)({}),[w,T]=(0,a.useState)(null),[E,_]=(0,a.useState)(!1);(0,a.useEffect)(()=>{P()},[t,n]);let P=async()=>{try{g(!0),await b.initialize();let e=b.getCurrentState();if(y(e),(0,M.r)("onboarding_flow_initialized",{state:e,has_saved_progress:!!f}),e===u.COMPLETED){await p.sessionManagerEnhanced.getSession();let e=await p.sessionManagerEnhanced.getTenantId();e?r.push("/".concat(e,"/dashboard")):(await b.reset(),y(u.NOT_STARTED))}let s=await p.sessionManagerEnhanced.getOnboardingProgress(),a=(0,c._)({},s,n&&{country:n});x(a),"subscription"===t&&e===u.BUSINESS_INFO&&(null==s?void 0:s.businessName)&&(o.vF.info("[OnboardingFlow] Navigating to subscription step from URL"),await b.transitionTo(u.SUBSCRIPTION_SELECTION),y(u.SUBSCRIPTION_SELECTION))}catch(e){o.vF.error("[OnboardingFlow] Initialization error",e),T(S.toComponentProps(e,{context:"onboarding_init"}))}finally{g(!1)}},I=async e=>{try{_(!0),T(null),o.vF.info("[OnboardingFlow] Received data from BusinessInfoForm:",e),console.log("\uD83D\uDEA8 [OnboardingFlow] Raw data from form:",JSON.stringify(e,null,2));let t=(0,c._)({},f,e);x(t);let n={business_name:e.businessName,business_type:e.businessType,country:e.country||"US",legal_structure:e.legalStructure,date_founded:e.dateFounded};o.vF.info("[OnboardingFlow] Sending to backend:",n),console.log("\uD83D\uDEA8 [OnboardingFlow] Backend data:",JSON.stringify(n,null,2));let s=await N.post("/api/onboarding/business-info",n);(0,M.r)("onboarding_business_info_submitted",{business_type:e.businessType,country:e.country,legal_structure:e.legalStructure,has_tenant_id:!!s.tenant_id}),(0,U.sx)(l,U.qY.ONBOARDING_STEP_COMPLETED,{step:"business_info",businessName:e.businessName,businessType:e.businessType,country:e.country,legalStructure:e.legalStructure}),await b.submitBusinessInfo(e),s.tenant_id&&p.sessionManagerEnhanced.clearCache(),y(u.SUBSCRIPTION_SELECTION)}catch(e){o.vF.error("[OnboardingFlow] Business info error",e),T(S.toComponentProps(e,{context:"business_info"}))}finally{_(!1)}},O=async(e,t)=>{try{_(!0),T(null);let n=(0,d._)((0,c._)({},f),{selectedPlan:e,billingCycle:t});if(x(n),await N.post("/api/onboarding/subscription",{selected_plan:e,billing_cycle:t}),(0,M.r)("onboarding_subscription_selected",{plan:e,billing_cycle:t,is_free_plan:"free"===e}),(0,U.sx)(l,U.qY.SUBSCRIPTION_SELECTED,{plan:e,billingCycle:t,isFreePlan:"free"===e}),(0,U.sx)(l,U.qY.ONBOARDING_STEP_COMPLETED,{step:"subscription_selection",plan:e,billingCycle:t}),await b.selectSubscription(e,t),"free"===e)await C(n);else{y(u.PAYMENT_PENDING);let n=f.country||"US";r.push("/onboarding/payment?plan=".concat(e,"&billing=").concat(t,"&country=").concat(encodeURIComponent(n)))}}catch(e){o.vF.error("[OnboardingFlow] Subscription selection error",e),T(S.toComponentProps(e,{context:"subscription"}))}finally{_(!1)}},C=async e=>{try{var t,n,s,a,i,r;o.vF.info("[OnboardingFlow] Completing onboarding with data:",{businessName:e.businessName,businessType:e.businessType,selectedPlan:e.selectedPlan,country:e.country,legalStructure:e.legalStructure,dateFounded:e.dateFounded});let c=await N.completeOnboarding({businessName:e.businessName,businessType:e.businessType,selectedPlan:e.selectedPlan,billingCycle:e.billingCycle||"monthly",country:e.country||"US",legalStructure:e.legalStructure||"",dateFounded:e.dateFounded||""});o.vF.info("[OnboardingFlow] Complete onboarding response:",c),console.log("\uD83C\uDFAF [OnboardingFlow] Response tenantId:",c.tenantId),console.log("\uD83C\uDFAF [OnboardingFlow] Response tenant_id:",c.tenant_id);let d=c.tenantId||c.tenant_id||(null==(t=c.data)?void 0:t.tenantId)||(null==(n=c.data)?void 0:n.tenant_id);if(!d&&(null==(a=c.data)||null==(s=a.schemaSetup)?void 0:s.schema_name)){let e=c.data.schemaSetup.schema_name;console.log("[OnboardingFlow] Extracting tenant ID from schema name:",e);let t=e.match(/tenant_([a-f0-9]{8}_[a-f0-9]{4}_[a-f0-9]{4}_[a-f0-9]{4}_[a-f0-9]{12})/);t&&(d=t[1].replace(/_/g,"-"),console.log("[OnboardingFlow] Extracted full tenant ID from schema:",d))}if(c.success&&d){(0,M.r)("onboarding_completed",{plan:e.selectedPlan,billing_cycle:e.billingCycle,business_type:e.businessType,country:e.country,tenant_id:d}),(0,U.sx)(l,U.qY.ONBOARDING_COMPLETED,{plan:e.selectedPlan,billingCycle:e.billingCycle,businessType:e.businessType,businessName:e.businessName,country:e.country,legalStructure:e.legalStructure,tenantId:d}),p.sessionManagerEnhanced.clearCache(),console.log("\uD83C\uDFAF [OnboardingFlow] Onboarding completed successfully"),console.log("\uD83D\uDD25 [OnboardingFlow] Ensuring onboarding completion is saved...");let t=[];t.push(fetch("/api/onboarding/ensure-complete",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({tenantId:d,businessName:e.businessName,selectedPlan:e.selectedPlan})}));let n=document.cookie,s=(null==(i=n.match(/(?:^|; )sid=([^;]*)/))?void 0:i[1])||(null==(r=n.match(/(?:^|; )session_token=([^;]*)/))?void 0:r[1]);if(s){let e="https://api.dottapps.com";t.push(fetch("".concat(e,"/api/onboarding/progress/update/"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Session ".concat(s)},body:JSON.stringify({setup_completed:!0,needs_onboarding:!1,tenant_id:d})})),t.push(fetch("".concat(e,"/api/sessions/refresh/"),{method:"POST",headers:{Authorization:"Session ".concat(s)}}))}try{(await Promise.allSettled(t)).forEach((e,t)=>{"fulfilled"===e.status&&e.value.ok?console.log("✅ [OnboardingFlow] Backend update ".concat(t+1," succeeded")):console.error("❌ [OnboardingFlow] Backend update ".concat(t+1," failed"))})}catch(e){console.error("❌ [OnboardingFlow] Error ensuring completion:",e)}console.log("\uD83D\uDD0D [OnboardingFlow] Verifying session before redirect..."),await new Promise(e=>setTimeout(e,1e3));try{let e=await fetch("/api/auth/session-verify",{credentials:"include",cache:"no-store"});if(e.ok){let t=await e.json();if(console.log("✅ [OnboardingFlow] Session verified:",t),!t.valid)throw console.error("❌ [OnboardingFlow] Session invalid after completion:",t.reason),Error("Session not properly established")}else console.error("❌ [OnboardingFlow] Session verification failed")}catch(e){console.error("❌ [OnboardingFlow] Session verification error:",e)}console.log("\uD83C\uDFAF [OnboardingFlow] Using window.location for redirect to ensure cookies are preserved"),window.location.href="/".concat(d,"/dashboard");return}if(c.redirect_url&&c.redirect_url.includes("session_lost")){o.vF.error("[OnboardingFlow] Session lost during onboarding"),window.location.href=c.redirect_url;return}if(c.requiresAuth){o.vF.error("[OnboardingFlow] Session lost during onboarding:",c),window.location.href="/auth/signin?message=session_expired&returnTo=/onboarding";return}else if(c.success&&c.redirectUrl){o.vF.warn("[OnboardingFlow] Onboarding completed but no tenant ID yet, redirecting to:",c.redirectUrl),window.location.href=c.redirectUrl;return}else if(c.success&&!d){o.vF.warn("[OnboardingFlow] Onboarding completed but tenant ID not immediately available, redirecting to dashboard"),p.sessionManagerEnhanced.clearCache(),window.location.href="/dashboard";return}else throw o.vF.error("[OnboardingFlow] Missing tenant ID in response:",c),Error("Unable to complete onboarding: missing tenant ID")}catch(e){throw o.vF.error("[OnboardingFlow] Completion error",e),e}};if(m)return(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,s.jsx)(v.A,{size:"large",text:"Loading onboarding..."})});if(w&&!h){var F;return(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,s.jsxs)("div",{className:"max-w-md w-full p-6 bg-white rounded-lg shadow-lg",children:[(0,s.jsx)("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:w.title}),(0,s.jsx)("p",{className:"text-gray-600 mb-6",children:w.description}),(0,s.jsx)("div",{className:"space-y-2",children:null==(F=w.suggestions)?void 0:F.map((e,t)=>(0,s.jsx)("button",{onClick:()=>window.location.reload(),className:"w-full py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-700",children:e.label},t))}),w.reference&&(0,s.jsxs)("p",{className:"text-xs text-gray-500 mt-4",children:["Reference: ",w.reference]})]})})}return(0,s.jsx)("div",{className:"min-h-screen bg-gray-50",children:(0,s.jsxs)("div",{className:"max-w-4xl mx-auto py-12 px-4",children:[(0,s.jsx)(L,{currentState:h}),w&&(0,s.jsx)("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:(0,s.jsxs)("p",{className:"text-red-600",children:[w.title,": ",w.description]})}),(h===u.NOT_STARTED||h===u.BUSINESS_INFO)&&(0,s.jsx)(G,{data:f,onSubmit:I,submitting:E,error:w}),h===u.SUBSCRIPTION_SELECTION&&(0,s.jsx)(Y,{data:f,onSelect:O,onBack:()=>{y(u.BUSINESS_INFO),b.transitionTo(u.BUSINESS_INFO)},submitting:E,error:w}),h===u.PAYMENT_PENDING&&(0,s.jsxs)("div",{className:"text-center py-12",children:[(0,s.jsx)("h2",{className:"text-2xl font-bold mb-4",children:"Payment Required"}),(0,s.jsxs)("p",{className:"text-gray-600 mb-6",children:["You'll be redirected to complete payment for your ",f.selectedPlan," plan."]}),(0,s.jsx)(v.A,{text:"Redirecting to payment..."})]})]})})}function L(e){let{currentState:t}=e,n=[{state:u.BUSINESS_INFO,label:"Business Info"},{state:u.SUBSCRIPTION_SELECTION,label:"Choose Plan"},{state:u.PAYMENT_PENDING,label:"Payment"},{state:u.COMPLETED,label:"Complete"}],a=n.findIndex(e=>e.state===t);return(0,s.jsx)("div",{className:"mb-12",children:(0,s.jsx)("div",{className:"relative",children:(0,s.jsx)("div",{className:"flex items-center justify-between",children:n.map((e,t)=>(0,s.jsxs)("div",{className:"flex-1 flex items-center",children:[(0,s.jsxs)("div",{className:"relative flex flex-col items-center",children:[(0,s.jsx)("div",{className:"\n                  w-10 h-10 rounded-full flex items-center justify-center z-10\n                  ".concat(t<=a?"bg-blue-600 text-white":"bg-gray-300 text-gray-600","\n                "),children:t+1}),(0,s.jsx)("div",{className:"mt-2 text-xs text-gray-600 whitespace-nowrap text-center",children:e.label})]}),t<n.length-1&&(0,s.jsx)("div",{className:"\n                  flex-1 h-1 -mt-6\n                  ".concat(t<a?"bg-blue-600":"bg-gray-300","\n                ")})]},e.state))})})})}function G(e){let{data:t,onSubmit:n,submitting:a,error:i}=e;return(0,s.jsx)(_,{initialData:t,onSubmit:n,submitting:a,error:i})}function Y(e){let{data:t,onSelect:n,onBack:a,submitting:i,error:o}=e;return(0,s.jsx)(A,{initialData:t,onSelect:n,onBack:a,submitting:i,error:o})}function q(){let e=(0,i.useRouter)(),t=(0,k.sf)(),{i18n:n}=(0,w.Bd)(),[l,c]=(0,a.useState)(!0),[d,u]=(0,a.useState)(null),[m,g]=(0,a.useState)(null),[p,h]=(0,a.useState)(null);(0,a.useEffect)(()=>{let e=new URLSearchParams(window.location.search),t=e.get("lang"),s=e.get("step"),a=e.get("country");t&&(console.log("\uD83C\uDF10 [Onboarding] Language parameter detected:",t),n.changeLanguage(t),localStorage.setItem("preferredLanguage",t)),y(s,a)},[n]);let y=async(n,s)=>{try{var a,i,l,d,m,p,y,f,S,x,N,v,w,T,E,_,P;o.vF.info("[OnboardingPage.v2] Checking authentication...",{requestedStep:n,requestedCountry:s});let u=new URLSearchParams(window.location.search),I="true"===u.get("fromAuth");I&&(o.vF.info("[OnboardingPage.v2] Coming from auth, waiting for cookies to propagate..."),await new Promise(e=>setTimeout(e,1e3)));let O=await r();if(!O.authenticated&&I){o.vF.info("[OnboardingPage.v2] Session not found, retrying...");for(let e=0;e<3;e++)if(await new Promise(e=>setTimeout(e,1e3)),(O=await r()).authenticated){o.vF.info("[OnboardingPage.v2] Session found on retry",e+1);break}}if(!O.authenticated){o.vF.warn("[OnboardingPage.v2] Not authenticated, redirecting to login"),e.push("/auth/signin");return}if(o.vF.info("[OnboardingPage.v2] Session authenticated:",{email:null==(a=O.user)?void 0:a.email,needsOnboarding:null==(i=O.user)?void 0:i.needsOnboarding,onboardingCompleted:null==(l=O.user)?void 0:l.onboardingCompleted,tenantId:null==(d=O.user)?void 0:d.tenantId}),(0,M.r)("onboarding_page_viewed",{needs_onboarding:null==(m=O.user)?void 0:m.needsOnboarding,onboarding_completed:null==(p=O.user)?void 0:p.onboardingCompleted,has_tenant_id:!!(null==(y=O.user)?void 0:y.tenantId)}),(null==(f=O.user)?void 0:f.needsOnboarding)===!0&&(0,U.sx)(t,U.qY.ONBOARDING_STARTED,{email:null==(N=O.user)?void 0:N.email,userId:(null==(v=O.user)?void 0:v.sub)||(null==(w=O.user)?void 0:w.id)}),(null==(S=O.user)?void 0:S.needsOnboarding)===!1||(null==(x=O.user)?void 0:x.onboardingCompleted)===!0){let t=(null==(T=O.user)?void 0:T.tenantId)||(null==(E=O.user)?void 0:E.tenant_id);if(t){o.vF.info("[OnboardingPage.v2] Backend says onboarding completed, redirecting to dashboard"),e.push("/".concat(t,"/dashboard"));return}{o.vF.warn("[OnboardingPage.v2] Onboarding completed but no tenant ID yet, checking for updates...");let t=0;for(;t<5;){await new Promise(e=>setTimeout(e,2e3));let n=await r(),s=(null==(_=n.user)?void 0:_.tenantId)||(null==(P=n.user)?void 0:P.tenant_id);if(s){o.vF.info("[OnboardingPage.v2] Tenant ID found after refresh:",s),e.push("/".concat(s,"/dashboard"));return}t++,o.vF.info("[OnboardingPage.v2] Still no tenant ID, retry",t,"of",5)}o.vF.error("[OnboardingPage.v2] No tenant ID after retries, redirecting to general dashboard"),e.push("/dashboard");return}}o.vF.info("[OnboardingPage.v2] User needs onboarding, showing onboarding flow"),await b.initialize();let C=b.getCurrentState();o.vF.info("[OnboardingPage.v2] Onboarding state:",{currentState:C,isComplete:b.isComplete()}),g(n),h(s),c(!1)}catch(e){o.vF.error("[OnboardingPage.v2] Error during initialization:",e),u(e.message),c(!1)}};return l?(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,s.jsx)(v.A,{size:"large",text:"Loading..."})}):d?(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,s.jsxs)("div",{className:"max-w-md w-full p-6 bg-white rounded-lg shadow-lg",children:[(0,s.jsx)("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Error"}),(0,s.jsx)("p",{className:"text-gray-600 mb-6",children:d}),(0,s.jsx)("button",{onClick:()=>e.push("/auth/signin"),className:"w-full py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Return to Sign In"})]})}):(0,s.jsx)(B,{initialStep:m,initialCountry:p})}n(136867)}},e=>{var t=t=>e(e.s=t);e.O(0,[41113,34223,78007,85885,98197,42459,77358],()=>t(14469)),_N_E=e.O()}]);