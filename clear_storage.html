<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear Browser Storage</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        .warning {
            background-color: #f44336;
        }
        .info {
            color: #0059b3;
            margin-top: 20px;
            font-style: italic;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Clear Browser Storage Tool</h1>
    
    <div class="container">
        <h2>Tenant Information</h2>
        <div id="tenantInfo">
            <p>Current tenant ID: <strong id="currentTenantId">Not found</strong></p>
            <p>Business ID: <strong id="businessId">Not found</strong></p>
        </div>
    </div>

    <div class="container">
        <h2>Clear Storage Options</h2>
        <button id="clearCognitoBtn">Clear Cognito Attributes</button>
        <button id="clearAppCacheBtn">Clear AppCache</button>
        <button id="clearSessionStorageBtn">Clear SessionStorage</button>
        <button id="clearAllBtn" class="warning">Clear All Storage</button>
        
        <div id="successMessage" class="success">
            Storage cleared successfully!
        </div>
        
        <div class="info">
            <p>After clearing storage, you should:</p>
            <ol>
                <li>Restart your Next.js development server</li>
                <li>Log out and log in again</li>
                <li>Create a new tenant through the normal flow</li>
            </ol>
        </div>
    </div>
    
    <div class="container">
        <h2>Current Storage Contents</h2>
        <h3>AppCache</h3>
        <pre id="appCacheContent">Loading...</pre>
        
        <h3>Cognito Attributes</h3>
        <pre id="cognitoContent">Loading...</pre>
        
        <h3>SessionStorage</h3>
        <pre id="sessionStorageContent">Loading...</pre>
    </div>

    <script>
        // Display current tenant information
        async function displayTenantInfo() {
            // Get tenant info from AppCache
            const tenantId = window.__APP_CACHE?.['user_pref_custom:tenant_ID']?.value || 'Not found';
            const businessId = window.__APP_CACHE?.['user_pref_custom:businessid']?.value || 'Not found';
            
            document.getElementById('currentTenantId').textContent = tenantId;
            document.getElementById('businessId').textContent = businessId;
            
            // Alternative way is to fetch from Cognito via API
            try {
                const response = await fetch('/api/auth/user-attributes');
                if (response.ok) {
                    const userData = await response.json();
                    if (userData.attributes && userData.attributes['custom:tenant_ID']) {
                        document.getElementById('currentTenantId').textContent = userData.attributes['custom:tenant_ID'];
                    }
                    if (userData.attributes && userData.attributes['custom:businessid']) {
                        document.getElementById('businessId').textContent = userData.attributes['custom:businessid'];
                    }
                }
            } catch (error) {
                console.error('Error fetching Cognito attributes:', error);
            }
        }
        
        // Display current storage contents
        async function displayStorageContents() {
            // Display AppCache
            try {
                if (window.__APP_CACHE) {
                    const appCacheItems = Object.entries(window.__APP_CACHE)
                        .map(([key, value]) => {
                            const displayValue = typeof value === 'object' 
                                ? `${key}: ${JSON.stringify(value).substring(0, 100)}...` 
                                : `${key}: ${value}`;
                            return displayValue;
                        })
                        .join('\n');
                    document.getElementById('appCacheContent').textContent = appCacheItems || 'Empty';
                } else {
                    document.getElementById('appCacheContent').textContent = 'AppCache not initialized';
                }
            } catch (e) {
                document.getElementById('appCacheContent').textContent = `Error: ${e.message}`;
            }
            
            // Display Cognito attributes
            try {
                const response = await fetch('/api/auth/user-attributes');
                if (response.ok) {
                    const userData = await response.json();
                    const cognitoItems = Object.entries(userData.attributes || {})
                        .map(([key, value]) => `${key}: ${value}`)
                        .join('\n');
                    document.getElementById('cognitoContent').textContent = cognitoItems || 'No attributes found';
                } else {
                    document.getElementById('cognitoContent').textContent = 'Failed to fetch Cognito attributes';
                }
            } catch (e) {
                document.getElementById('cognitoContent').textContent = `Error: ${e.message}`;
            }
            
            // Display sessionStorage
            try {
                const sessionStorageItems = Object.entries(sessionStorage)
                    .map(([key, value]) => `${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}`)
                    .join('\n');
                document.getElementById('sessionStorageContent').textContent = sessionStorageItems || 'Empty';
            } catch (e) {
                document.getElementById('sessionStorageContent').textContent = `Error: ${e.message}`;
            }
        }
        
        // Clear Cognito attributes
        async function clearCognitoAttributes() {
            try {
                const response = await fetch('/api/auth/clear-attributes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showSuccessMessage();
                    await displayStorageContents();
                    await displayTenantInfo();
                } else {
                    console.error('Failed to clear Cognito attributes');
                }
            } catch (e) {
                console.error('Error clearing Cognito attributes:', e);
            }
        }
        
        // Clear AppCache
        function clearAppCache() {
            try {
                if (window.__APP_CACHE) {
                    // Reset the AppCache object while preserving the reference
                    Object.keys(window.__APP_CACHE).forEach(key => {
                        delete window.__APP_CACHE[key];
                    });
                    
                    showSuccessMessage();
                    displayStorageContents();
                    displayTenantInfo();
                }
            } catch (e) {
                console.error('Error clearing AppCache:', e);
            }
        }
        
        // Clear sessionStorage
        function clearSessionStorage() {
            try {
                sessionStorage.clear();
                showSuccessMessage();
                displayStorageContents();
                displayTenantInfo();
            } catch (e) {
                console.error('Error clearing sessionStorage:', e);
            }
        }
        
        // Clear all storage
        async function clearAllStorage() {
            await clearCognitoAttributes();
            clearAppCache();
            clearSessionStorage();
        }
        
        // Show success message
        function showSuccessMessage() {
            const successMessage = document.getElementById('successMessage');
            successMessage.style.display = 'block';
            
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }
        
        // Add event listeners
        document.getElementById('clearCognitoBtn').addEventListener('click', clearCognitoAttributes);
        document.getElementById('clearAppCacheBtn').addEventListener('click', clearAppCache);
        document.getElementById('clearSessionStorageBtn').addEventListener('click', clearSessionStorage);
        document.getElementById('clearAllBtn').addEventListener('click', clearAllStorage);
        
        // Initialize
        displayTenantInfo();
        displayStorageContents();
    </script>
</body>
</html> 