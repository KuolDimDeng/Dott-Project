version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Installing dependencies for Next.js static export..."
        - npm install -g pnpm@8.10.0 || npm install -g yarn
        - cd frontend/pyfactor_next && pnpm install --no-frozen-lockfile
    build:
      commands:
        - echo "Building Next.js static export for AWS Amplify..."
        - "echo 'DEBUG: Build phase - Current directory:' $(pwd)"
        - "if [[ $(pwd) == *'pyfactor_next'* ]]; then echo '✅ Already in pyfactor_next directory, building static export...' && export NODE_ENV=production && export NEXT_PUBLIC_API_URL=https://api.dottapps.com && export BACKEND_API_URL=https://api.dottapps.com && export USE_DATABASE=true && export MOCK_DATA_DISABLED=true && export PROD_MODE=true && export NODE_OPTIONS='--max-old-space-size=4096' && pnpm run build && echo 'Static export completed successfully' && ls -la out/ | head -10 && echo 'Checking index.html...' && ls -la out/index.html 2>/dev/null || echo 'No index.html found'; else echo '🔍 Searching for pyfactor_next directory...' && FRONTEND_DIR=$(find . -name 'pyfactor_next' -type d | head -1) && if [ -z \"$FRONTEND_DIR\" ]; then echo 'ERROR: Could not find pyfactor_next directory' && exit 1; fi && echo \"Found frontend directory at: $FRONTEND_DIR\" && cd \"$FRONTEND_DIR\" && export NODE_ENV=production && export NEXT_PUBLIC_API_URL=https://api.dottapps.com && export BACKEND_API_URL=https://api.dottapps.com && export USE_DATABASE=true && export MOCK_DATA_DISABLED=true && export PROD_MODE=true && export NODE_OPTIONS='--max-old-space-size=4096' && pnpm run build && echo 'Static export completed successfully' && ls -la out/ | head -10 && echo 'Checking index.html...' && ls -la out/index.html 2>/dev/null || echo 'No index.html found'; fi"
        - "echo 'DEBUG: Verifying static export output...'"
        - "echo 'Output directory contents:' && ls -la out/ 2>/dev/null | head -10 || echo 'No out directory found'"
  artifacts:
    baseDirectory: frontend/pyfactor_next/out
    files:
      - '**/*'
  cache:
    paths:
      - frontend/pyfactor_next/node_modules/**/*
      - frontend/pyfactor_next/.next/cache/**/* 