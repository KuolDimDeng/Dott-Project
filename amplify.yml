version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Installing dependencies..."
        - npm install -g pnpm@8.10.0 || npm install -g yarn
        - cd frontend/pyfactor_next && pnpm install --no-frozen-lockfile
    build:
      commands:
        - echo "Building Next.js application..."
        - "echo 'DEBUG: Build phase - Current directory:' $(pwd)"
        - "echo 'DEBUG: Searching for frontend directory...'"
        - "find . -name 'pyfactor_next' -type d | head -5"
        - "echo 'DEBUG: Searching for package.json files...'"
        - "find . -name 'package.json' | grep pyfactor_next | head -3"
        - |
          # Find the frontend directory wherever it is
          FRONTEND_DIR=$(find . -name 'pyfactor_next' -type d | head -1)
          if [ -z "$FRONTEND_DIR" ]; then
            echo "ERROR: Could not find pyfactor_next directory"
            exit 1
          fi
          echo "Found frontend directory at: $FRONTEND_DIR"
          cd "$FRONTEND_DIR"
          export NODE_ENV=production
          export NEXT_PUBLIC_API_URL=https://api.dottapps.com
          export BACKEND_API_URL=https://api.dottapps.com
          export USE_DATABASE=true
          export MOCK_DATA_DISABLED=true
          export PROD_MODE=true
          export NODE_OPTIONS="--max-old-space-size=4096"
          pnpm run build
  artifacts:
    baseDirectory: frontend/pyfactor_next/.next
    files:
      - '**/*'
  cache:
    paths:
      - frontend/pyfactor_next/node_modules/**/*
      - frontend/pyfactor_next/.next/cache/**/* 