version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Installing dependencies..."
        - npm install -g pnpm@8.10.0 || npm install -g yarn
        - cd frontend/pyfactor_next && pnpm install --no-frozen-lockfile
    build:
      commands:
        - echo "Building Next.js application..."
        - "echo 'DEBUG: Build phase - Current directory:' $(pwd)"
        - "echo 'DEBUG: Checking if we are in pyfactor_next directory...'"
        - |
          # Check if we're already in the pyfactor_next directory
          if [[ $(pwd) == *"pyfactor_next"* ]]; then
            echo "‚úÖ Already in pyfactor_next directory, building directly..."
            export NODE_ENV=production
            export NEXT_PUBLIC_API_URL=https://api.dottapps.com
            export BACKEND_API_URL=https://api.dottapps.com
            export USE_DATABASE=true
            export MOCK_DATA_DISABLED=true
            export PROD_MODE=true
            export NODE_OPTIONS="--max-old-space-size=4096"
            pnpm run build
          else
            echo "üîç Searching for pyfactor_next directory..."
            FRONTEND_DIR=$(find . -name 'pyfactor_next' -type d | head -1)
            if [ -z "$FRONTEND_DIR" ]; then
              echo "ERROR: Could not find pyfactor_next directory"
              exit 1
            fi
            echo "Found frontend directory at: $FRONTEND_DIR"
            cd "$FRONTEND_DIR"
            export NODE_ENV=production
            export NEXT_PUBLIC_API_URL=https://api.dottapps.com
            export BACKEND_API_URL=https://api.dottapps.com
            export USE_DATABASE=true
            export MOCK_DATA_DISABLED=true
            export PROD_MODE=true
            export NODE_OPTIONS="--max-old-space-size=4096"
            pnpm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/* 