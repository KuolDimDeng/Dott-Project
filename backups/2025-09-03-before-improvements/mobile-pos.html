<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dott POS - Connected</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        :root {
            --primary: #0d4f8a; /* Primary navy blue from web app */
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --navy-900: #0f172a;
            --navy-800: #1e293b;
            --navy-700: #334155;
            --navy-600: #475569;
            --navy-500: #64748b;
            --navy-400: #94a3b8;
            --navy-300: #cbd5e1;
            --navy-200: #e2e8f0;
            --navy-100: #f1f5f9;
            --navy-50: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--navy-50);
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Header - Minimal with just back button */
        .pos-header {
            background: transparent;
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 100;
        }


        .back-button {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--navy-200);
            color: var(--navy-900);
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            width: 44px;
            height: 44px;
        }

        .back-button:hover {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .back-button:active {
            transform: scale(0.95);
        }


        /* Tab Navigation */
        .tab-nav {
            background: white;
            display: flex;
            border-bottom: 1px solid var(--navy-200);
            position: sticky;
            top: 0;
            z-index: 90;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: var(--navy-600);
            font-size: 14px;
            cursor: pointer;
            position: relative;
        }

        .tab-btn.active {
            color: var(--navy-900);
            font-weight: 600;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }

        /* POS Container */
        .pos-container {
            padding: 16px;
            display: none;
        }

        .pos-container.active {
            display: block;
        }

        /* Search Bar */
        .search-section {
            background: white;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .search-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .stock-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: var(--navy-50);
            border-radius: 8px;
            border: 1px solid var(--navy-200);
        }

        .toggle-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--navy-700);
        }

        .toggle-switch {
            position: relative;
            width: 42px;
            height: 24px;
            background: var(--navy-300);
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-switch.active {
            background: var(--primary);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(18px);
        }

        .search-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--navy-200);
            border-radius: 8px;
            font-size: 14px;
        }

        .scan-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }

        .product-card:active {
            transform: scale(0.95);
        }

        .product-icon {
            font-size: 32px;
            margin-bottom: 4px;
        }

        .product-name {
            font-size: 12px;
            color: var(--navy-700);
            margin-bottom: 4px;
        }

        .product-price {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }

        /* Cart Section */
        .cart-section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--navy-200);
        }

        .cart-title {
            font-weight: 600;
            color: var(--navy-900);
        }

        .cart-clear {
            color: var(--error);
            font-size: 12px;
            cursor: pointer;
        }

        #cartItems {
            min-height: 60px;
            max-height: 200px;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--navy-100);
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-size: 14px;
            color: var(--navy-900);
        }

        .cart-item-price {
            font-size: 12px;
            color: var(--navy-500);
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qty-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid var(--navy-300);
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-item-qty {
            min-width: 20px;
            text-align: center;
            font-weight: 600;
        }

        /* Payment Section */
        .payment-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .payment-btn {
            background: white;
            border: 2px solid var(--navy-200);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-btn:hover {
            border-color: var(--primary);
            background: var(--navy-50);
        }

        .payment-icon {
            width: 24px;
            height: 24px;
            display: block;
            margin: 0 auto;
        }
        
        .product-icon svg {
            display: block;
            margin: 0 auto;
        }

        .payment-label {
            font-size: 14px;
            font-weight: 500;
        }

        /* Processing Overlay */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .processing-overlay.active {
            display: flex;
        }

        .processing-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--navy-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Loading State */
        .loading-products {
            text-align: center;
            padding: 40px;
            color: var(--navy-500);
        }

        /* Paystubs Tab */
        .paystub-container {
            display: none;
            padding: 16px;
        }

        .paystub-container.active {
            display: block;
        }

        .paystub-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* Stripe Payment Modal Styles */
        .stripe-payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .stripe-modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .stripe-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .stripe-modal-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--navy-900);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--navy-400);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stripe-amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin-bottom: 24px;
        }
        
        .stripe-element-container {
            margin-bottom: 20px;
        }
        
        .stripe-card-element {
            padding: 12px;
            border: 1px solid var(--navy-300);
            border-radius: 8px;
            background: white;
            min-height: 44px;
        }
        
        .stripe-error {
            color: var(--error);
            font-size: 14px;
            margin-top: 8px;
            min-height: 20px;
        }
        
        .stripe-submit-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .stripe-submit-btn:hover:not(:disabled) {
            background: #0a3d6e;
        }
        
        .stripe-submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .stripe-test-info {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--navy-200);
            text-align: center;
        }
        
        .stripe-test-info p {
            font-size: 12px;
            color: var(--navy-500);
            margin: 4px 0;
        }
        
        /* Tap to Pay Styles */
        .tap-to-pay-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }
        
        .tap-to-pay-modal {
            background: white;
            border-radius: 24px;
            padding: 32px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .tap-animation {
            margin: 0 auto 24px;
        }
        
        .tap-to-pay-modal h2 {
            font-size: 24px;
            color: var(--navy-900);
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .tap-amount {
            font-size: 36px;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 8px;
        }
        
        .tap-instruction {
            font-size: 16px;
            color: var(--navy-600);
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        .cancel-tap-btn {
            background: var(--navy-100);
            color: var(--navy-700);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cancel-tap-btn:hover {
            background: var(--navy-200);
        }
        
        .cancel-tap-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- Minimal header with just back button -->
    <div class="pos-header">
        <button class="back-button" onclick="navigateBack()" title="Back to Main Menu">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M15 18l-6-6 6-6"/>
            </svg>
        </button>
    </div>


    <!-- POS Tab -->
    <div class="pos-container active" id="posTab">
        <div class="search-section">
            <div class="search-row">
                <input type="text" class="search-input" placeholder="Search products..." id="searchInput" onkeyup="searchProducts()">
                <button class="scan-btn" onclick="openScanner()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                    <span>Scan</span>
                </button>
            </div>
            <div class="stock-toggle-container">
                <span class="toggle-label">Show out of stock products</span>
                <button class="toggle-switch" id="stockToggle" onclick="toggleOutOfStock()">
                    <span class="toggle-slider"></span>
                </button>
            </div>
        </div>

        <div id="productsGrid" class="products-grid">
            <div class="loading-products">Loading products...</div>
        </div>

        <div class="cart-section">
            <div class="cart-header">
                <span class="cart-title">Current Order</span>
                <span class="cart-clear" onclick="clearCart()">Clear All</span>
            </div>
            <div id="cartItems"></div>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid var(--navy-200);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Subtotal</span>
                    <span id="subtotal">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Tax</span>
                    <span id="tax">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 600;">
                    <span>Total</span>
                    <span id="total" style="color: var(--primary);">$0.00</span>
                </div>
            </div>
        </div>

        <div class="payment-section">
            <button class="payment-btn" onclick="processPayment('cash')">
                <svg class="payment-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="5" width="20" height="14" rx="2"/>
                    <path d="M12 11v6"/>
                    <path d="M9 14h6"/>
                </svg>
                <span class="payment-label">Cash</span>
            </button>
            <button class="payment-btn" onclick="processPayment('card')">
                <svg class="payment-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                    <line x1="1" y1="10" x2="23" y2="10"/>
                </svg>
                <span class="payment-label">Card</span>
            </button>
            <button class="payment-btn" onclick="processPayment('mpesa')">
                <svg class="payment-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                    <line x1="12" y1="18" x2="12" y2="18"/>
                </svg>
                <span class="payment-label">M-Pesa</span>
            </button>
            <button class="payment-btn" onclick="processPayment('mtnmomo')">
                <svg class="payment-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z" fill="#ffcc00"/>
                </svg>
                <span class="payment-label">MTN MoMo</span>
            </button>
        </div>
    </div>

    <!-- Removed Pay Stubs section - available in main menu -->

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-content">
            <div class="spinner"></div>
            <p>Processing payment...</p>
        </div>
    </div>

    <script>
        // Global State
        const AppState = {
            isOnline: navigator.onLine,
            cart: [],
            products: [],
            paystubs: [],
            user: null,
            sessionToken: null,
            tenantId: null,
            taxRate: 0,
            taxJurisdiction: 'Unknown',
            taxSource: 'none',
            apiUrl: 'https://staging.dottapps.com',
            currencyCode: 'USD',
            currencySymbol: '$',
            showOutOfStock: false  // Toggle for showing out of stock products
        };

        // Currency mapping
        const COUNTRY_CURRENCY_MAP = {
            'US': { code: 'USD', symbol: '$' },
            'GB': { code: 'GBP', symbol: '£' },
            'EU': { code: 'EUR', symbol: '€' },
            'KE': { code: 'KES', symbol: 'KSh' },
            'NG': { code: 'NGN', symbol: '₦' },
            'ZA': { code: 'ZAR', symbol: 'R' },
            'SS': { code: 'SSP', symbol: 'SSP' },
            'UG': { code: 'UGX', symbol: 'USh' },
            'TZ': { code: 'TZS', symbol: 'TSh' },
            'GH': { code: 'GHS', symbol: '₵' },
            'IN': { code: 'INR', symbol: '₹' },
            'AE': { code: 'AED', symbol: 'د.إ' }
        };

        function getCurrencyForCountry(countryCode) {
            return COUNTRY_CURRENCY_MAP[countryCode] || { code: 'USD', symbol: '$' };
        }

        function formatPrice(amount) {
            return `${AppState.currencySymbol}${amount.toFixed(2)}`;
        }

        // Mobile Stripe Payment Modal
        function showMobileStripePayment(clientSecret, amount, currency) {
            // Create payment modal
            const modal = document.createElement('div');
            modal.className = 'stripe-payment-modal';
            modal.innerHTML = `
                <div class="stripe-modal-content">
                    <div class="stripe-modal-header">
                        <h2>Card Payment</h2>
                        <button class="close-btn" onclick="cancelStripePayment()">×</button>
                    </div>
                    <div class="stripe-amount">${AppState.currencySymbol}${amount.toFixed(2)}</div>
                    <form id="stripe-payment-form">
                        <div class="stripe-element-container">
                            <div id="card-element" class="stripe-card-element"></div>
                            <div id="card-errors" class="stripe-error"></div>
                        </div>
                        <button type="submit" id="submit-payment" class="stripe-submit-btn">
                            <span id="button-text">Pay Now</span>
                            <span id="spinner" class="spinner hidden"></span>
                        </button>
                    </form>
                    <div class="stripe-test-info">
                        <p>Test Card: 4242 4242 4242 4242</p>
                        <p>Exp: Any future date | CVC: Any 3 digits</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Initialize Stripe Elements
            const stripe = Stripe('pk_live_51OzCtC074uTqvtCMx8jRAx9PvdQJhg9HuKJvxA7XwV6VMFhzQ9oAhCOCJP7G10vw4Xwu20pxRHJ6hINKQwm84Dps00mxqZAf5Z');
            const elements = stripe.elements();
            
            // Create card element with mobile-friendly styling
            const cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#32325d',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                        '::placeholder': {
                            color: '#aab7c4'
                        }
                    },
                    invalid: {
                        color: '#fa755a',
                        iconColor: '#fa755a'
                    }
                }
            });
            
            // Mount card element
            cardElement.mount('#card-element');
            
            // Handle form submission
            const form = document.getElementById('stripe-payment-form');
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const submitButton = document.getElementById('submit-payment');
                const buttonText = document.getElementById('button-text');
                const spinner = document.getElementById('spinner');
                
                // Disable button and show spinner
                submitButton.disabled = true;
                buttonText.classList.add('hidden');
                spinner.classList.remove('hidden');
                
                // Confirm payment
                const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: cardElement
                    }
                });
                
                if (error) {
                    // Show error to customer
                    const errorElement = document.getElementById('card-errors');
                    errorElement.textContent = error.message;
                    
                    // Re-enable button
                    submitButton.disabled = false;
                    buttonText.classList.remove('hidden');
                    spinner.classList.add('hidden');
                } else {
                    // Payment succeeded
                    modal.remove();
                    completeStripePayment(true);
                }
            });
            
            // Handle card errors
            cardElement.on('change', (event) => {
                const displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });
            
            // Store modal reference for cleanup
            window.stripePaymentModal = modal;
        }
        
        function cancelStripePayment() {
            if (window.stripePaymentModal) {
                window.stripePaymentModal.remove();
                window.stripePaymentModal = null;
            }
            document.getElementById('processingOverlay').classList.remove('active');
        }
        
        // Tap to Pay Helper Functions
        async function checkTapToPaySupport() {
            try {
                // Check if we're on iOS and have the native bridge
                if (!window.webkit?.messageHandlers?.tapToPay) {
                    return { supported: false, reason: 'Not running in iOS app' };
                }
                
                // Call native iOS to check device compatibility
                const response = await window.webkit.messageHandlers.tapToPay.postMessage({
                    action: 'checkSupport'
                });
                
                return response;
            } catch (error) {
                console.error('[Tap to Pay] Support check failed:', error);
                return { supported: false, reason: 'Support check failed' };
            }
        }
        
        async function processTapToPayPayment(amount) {
            return new Promise((resolve, reject) => {
                // Show Tap to Pay UI
                const tapUI = document.createElement('div');
                tapUI.className = 'tap-to-pay-overlay';
                tapUI.innerHTML = `
                    <div class="tap-to-pay-modal">
                        <div class="tap-animation">
                            <svg width="120" height="120" viewBox="0 0 120 120">
                                <rect x="20" y="30" width="80" height="60" rx="8" fill="#2563eb" opacity="0.2"/>
                                <path d="M30 50 L90 50" stroke="#2563eb" stroke-width="3" stroke-linecap="round">
                                    <animate attributeName="opacity" values="0;1;0" dur="2s" repeatCount="indefinite"/>
                                </path>
                                <circle cx="60" cy="70" r="8" fill="#2563eb">
                                    <animate attributeName="r" values="8;12;8" dur="2s" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                        </div>
                        <h2>Ready for Payment</h2>
                        <p class="tap-amount">${AppState.currencySymbol}${amount.toFixed(2)}</p>
                        <p class="tap-instruction">Tap or insert card on the back of this iPhone</p>
                        <button class="cancel-tap-btn" onclick="cancelTapToPay()">Cancel</button>
                    </div>
                `;
                document.body.appendChild(tapUI);
                
                // Store resolve/reject for later use
                window.tapToPayResolve = resolve;
                window.tapToPayReject = reject;
                window.tapToPayUI = tapUI;
                
                // Send message to native iOS to start accepting payment
                window.webkit.messageHandlers.tapToPay.postMessage({
                    action: 'acceptPayment',
                    amount: amount,
                    currency: AppState.currencyCode || 'USD'
                });
                
                // Set timeout for payment (60 seconds)
                window.tapToPayTimeout = setTimeout(() => {
                    cancelTapToPay();
                    reject(new Error('Payment timeout'));
                }, 60000);
            });
        }
        
        function cancelTapToPay() {
            // Clear timeout
            if (window.tapToPayTimeout) {
                clearTimeout(window.tapToPayTimeout);
            }
            
            // Remove UI
            if (window.tapToPayUI) {
                window.tapToPayUI.remove();
            }
            
            // Cancel native payment
            if (window.webkit?.messageHandlers?.tapToPay) {
                window.webkit.messageHandlers.tapToPay.postMessage({
                    action: 'cancelPayment'
                });
            }
            
            // Reject promise
            if (window.tapToPayReject) {
                window.tapToPayReject(new Error('Payment cancelled'));
            }
            
            // Clean up
            window.tapToPayResolve = null;
            window.tapToPayReject = null;
            window.tapToPayUI = null;
            window.tapToPayTimeout = null;
        }
        
        // Handle native iOS callbacks
        window.handleTapToPayResult = function(result) {
            // Clear timeout
            if (window.tapToPayTimeout) {
                clearTimeout(window.tapToPayTimeout);
            }
            
            // Remove UI  
            if (window.tapToPayUI) {
                window.tapToPayUI.remove();
            }
            
            // Resolve or reject based on result
            if (result.success && window.tapToPayResolve) {
                window.tapToPayResolve(result);
            } else if (window.tapToPayReject) {
                window.tapToPayReject(new Error(result.error || 'Payment failed'));
            }
            
            // Clean up
            window.tapToPayResolve = null;
            window.tapToPayReject = null;
            window.tapToPayUI = null;
            window.tapToPayTimeout = null;
        };
        
        // Initialize App
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing POS system...');
            
            // Check if running in Capacitor
            if (window.Capacitor) {
                console.log('Running in Capacitor environment');
                await initializeCapacitor();
            }
            
            // Initialize offline support
            await initializeOfflineSupport();
            
            // Load user session
            await loadUserSession();
            
            // Update UI
            updateConnectionStatus();
            updateUserInfo();
            
            // Check Apple Pay availability (non-blocking)
            setTimeout(() => {
                try {
                    // Apple Pay removed - was causing issues
                } catch (e) {
                    console.log('[Apple Pay] Error during check:', e);
                }
            }, 100);
            
            // Load data from backend
            console.log('[POS] Loading products and data...');
            if (AppState.sessionToken || AppState.user) {
                try {
                    await fetchProducts();
                    console.log('[POS] Products loaded');
                    
                    // Load other data in parallel but don't block on them
                    Promise.all([
                        fetchPaystubs().catch(e => console.log('[POS] Paystubs error:', e)),
                        fetchTaxSettings().catch(e => console.log('[POS] Tax settings error:', e))
                    ]);
                } catch (error) {
                    console.error('[POS] Error loading products:', error);
                    loadDemoData();
                }
            } else {
                // Load demo data if not logged in
                loadDemoData();
            }
            
            updateCart();
        });

        async function initializeCapacitor() {
            try {
                const { Network } = Capacitor.Plugins;
                const status = await Network.getStatus();
                AppState.isOnline = status.connected;
                
                Network.addListener('networkStatusChange', (status) => {
                    AppState.isOnline = status.connected;
                    updateConnectionStatus();
                    if (status.connected) {
                        syncOfflineData();
                    }
                });
            } catch (error) {
                console.error('Capacitor initialization error:', error);
            }
        }

        async function initializeOfflineSupport() {
            window.addEventListener('online', () => {
                AppState.isOnline = true;
                updateConnectionStatus();
                syncOfflineData();
            });
            
            window.addEventListener('offline', () => {
                AppState.isOnline = false;
                updateConnectionStatus();
            });
        }

        async function verifySession() {
            try {
                if (!AppState.sessionToken) return;
                
                console.log('[POS] Verifying session token...');
                
                let response;
                if (window.Capacitor && window.Capacitor.Plugins.Http) {
                    // Use Capacitor HTTP plugin for native requests
                    const { Http } = Capacitor.Plugins;
                    const result = await Http.request({
                        url: `${AppState.apiUrl}/api/auth/session-verify`,
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${AppState.sessionToken}`,
                            'Cookie': `sid=${AppState.sessionToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    response = {
                        ok: result.status >= 200 && result.status < 300,
                        status: result.status,
                        json: async () => result.data
                    };
                } else {
                    // Fallback to fetch for web
                    response = await fetch(`${AppState.apiUrl}/api/auth/session-verify`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${AppState.sessionToken}`,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                }
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[POS] Session verified:', data);
                    
                    if (data.user) {
                        AppState.user = data.user;
                        AppState.tenantId = data.user.tenant_id || data.tenant_id || AppState.tenantId;
                        console.log('[POS] Session valid - Updated Tenant ID:', AppState.tenantId);
                        
                        // Store updated tenant ID
                        if (window.Capacitor && window.Capacitor.Plugins.SecureStoragePlugin && AppState.tenantId) {
                            try {
                                await window.Capacitor.Plugins.SecureStoragePlugin.set({
                                    key: 'tenant_id',
                                    value: String(AppState.tenantId)
                                });
                            } catch (e) {
                                console.log('[POS] Could not store tenant ID');
                            }
                        }
                    }
                } else {
                    console.error('[POS] Session invalid:', response.status);
                    // Clear invalid session
                    AppState.sessionToken = null;
                    AppState.user = null;
                    AppState.tenantId = null;
                    
                    // Redirect to login
                    alert('Session expired. Please sign in again.');
                    setTimeout(() => {
                        window.location.href = 'mobile-auth.html';
                    }, 1500);
                }
            } catch (error) {
                console.error('[POS] Error verifying session:', error.message || error);
                console.error('[POS] Full verify error:', JSON.stringify(error));
            }
        }
        
        async function loadUserSession() {
            try {
                console.log('[POS] Attempting to load session...');
                
                // First try secure storage for Capacitor
                if (window.Capacitor && window.Capacitor.Plugins.SecureStoragePlugin) {
                    try {
                        // Try multiple keys for session token
                        let sessionToken = null;
                        let tenantId = null;
                        let user = null;
                        
                        // Try session_token key (from mobile-auth.html)
                        try {
                            const tokenResult = await window.Capacitor.Plugins.SecureStoragePlugin.get({ key: 'session_token' });
                            if (tokenResult?.value) {
                                sessionToken = tokenResult.value;
                                console.log('[POS] Found session_token in secure storage');
                            }
                        } catch (e) {}
                        
                        // Try user_data key
                        try {
                            const userResult = await window.Capacitor.Plugins.SecureStoragePlugin.get({ key: 'user_data' });
                            if (userResult?.value) {
                                user = JSON.parse(userResult.value);
                                tenantId = user.tenant_id;
                                console.log('[POS] Found user_data in secure storage');
                            }
                        } catch (e) {}
                        
                        // Try tenant_id key
                        if (!tenantId) {
                            try {
                                const tenantResult = await window.Capacitor.Plugins.SecureStoragePlugin.get({ key: 'tenant_id' });
                                if (tenantResult?.value) {
                                    tenantId = tenantResult.value;
                                    console.log('[POS] Found tenant_id in secure storage');
                                }
                            } catch (e) {}
                        }
                        
                        // Try legacy session key
                        if (!sessionToken) {
                            try {
                                const result = await window.Capacitor.Plugins.SecureStoragePlugin.get({ key: 'session' });
                                if (result?.value) {
                                    const session = JSON.parse(result.value);
                                    sessionToken = sessionToken || session.token || session.session_token;
                                    tenantId = tenantId || session.tenantId || session.tenant_id;
                                    user = user || session.user;
                                    console.log('[POS] Found legacy session in secure storage');
                                }
                            } catch (e) {}
                        }
                        
                        // Set AppState if we found anything
                        if (sessionToken) {
                            AppState.sessionToken = sessionToken;
                            AppState.tenantId = tenantId;
                            AppState.user = user;
                            
                            // Set currency based on user's country
                            if (user && user.country) {
                                const currency = getCurrencyForCountry(user.country);
                                AppState.currencyCode = currency.code;
                                AppState.currencySymbol = currency.symbol;
                                console.log('[POS] Currency set to:', currency.code, currency.symbol);
                            }
                            
                            console.log('[POS] Session loaded - Token:', !!sessionToken, 'Tenant:', tenantId);
                            
                            // Verify the session
                            await verifySession();
                            return;
                        }
                    } catch (e) {
                        console.log('[POS] SecureStorage error:', e);
                    }
                }
                
                // Try Preferences plugin
                if (window.Capacitor && window.Capacitor.Plugins.Preferences) {
                    const { Preferences } = Capacitor.Plugins;
                    const { value } = await Preferences.get({ key: 'user_session' });
                    if (value) {
                        const session = JSON.parse(value);
                        AppState.user = session.user || session;
                        AppState.sessionToken = session.token || session.sid || session.session_token;
                        AppState.tenantId = session.tenantId || session.tenant_id;
                        console.log('[POS] Session loaded from Preferences - Tenant:', AppState.tenantId);
                        
                        if (AppState.sessionToken) {
                            await verifySession();
                        }
                    }
                } else {
                    // Fallback to localStorage for browser testing
                    const session = localStorage.getItem('session');
                    if (session) {
                        try {
                            const parsed = JSON.parse(session);
                            AppState.sessionToken = parsed.token || parsed.sid;
                            AppState.tenantId = parsed.tenantId || parsed.tenant_id;
                            AppState.user = parsed.user;
                            console.log('[POS] Session loaded from localStorage - Tenant:', AppState.tenantId);
                        } catch (e) {
                            console.error('[POS] Error parsing localStorage session:', e);
                        }
                    }
                }
                
                console.log('[POS] Final session state - Token:', !!AppState.sessionToken, 'Tenant:', AppState.tenantId);
            } catch (error) {
                console.error('Error loading session:', error);
            }
        }

        async function fetchProducts() {
            try {
                const cachedProducts = await loadFromCache('products');
                
                if (!AppState.isOnline && cachedProducts) {
                    AppState.products = cachedProducts;
                    renderProducts();
                    return;
                }

                console.log('[POS] Fetching products with session:', AppState.sessionToken ? 'Yes' : 'No');
                console.log('[POS] API URL:', `${AppState.apiUrl}/api/inventory/products/`);
                
                const headers = {};
                if (AppState.sessionToken) {
                    headers['Authorization'] = `Bearer ${AppState.sessionToken}`;
                }
                if (AppState.tenantId) {
                    headers['X-Tenant-ID'] = AppState.tenantId;
                }
                headers['Content-Type'] = 'application/json';

                // Add Cookie header for mobile app
                if (AppState.sessionToken) {
                    headers['Cookie'] = `sid=${AppState.sessionToken}`;
                }

                let response;
                if (window.Capacitor && window.Capacitor.Plugins.Http) {
                    // Use Capacitor HTTP plugin for native requests
                    console.log('[POS] Using Http plugin for products request');
                    const { Http } = Capacitor.Plugins;
                    const result = await Http.request({
                        url: `${AppState.apiUrl}/api/inventory/products/`,
                        method: 'GET',
                        headers: headers
                    });
                    response = {
                        ok: result.status >= 200 && result.status < 300,
                        status: result.status,
                        statusText: result.statusText || '',
                        json: async () => result.data,
                        text: async () => JSON.stringify(result.data)
                    };
                } else {
                    // Fallback to fetch for web
                    response = await fetch(`${AppState.apiUrl}/api/inventory/products/`, {
                        headers: headers,
                        credentials: 'include'
                    });
                }

                console.log('[POS] Products API Response:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('[POS] Products data received:', data);
                    
                    // Handle different response formats from the API
                    let products = [];
                    if (data.results) {
                        products = data.results;
                    } else if (data.products) {
                        products = data.products;
                    } else if (Array.isArray(data)) {
                        products = data;
                    }
                    
                    console.log(`[POS] Found ${products.length} products`);
                    
                    if (products.length === 0) {
                        console.log('[POS] No products in inventory, showing demo data');
                        loadDemoData();
                        return;
                    }
                    
                    AppState.products = products.map(p => ({
                        id: p.id,
                        name: p.name || p.product_name || 'Unknown Product',
                        price: parseFloat(p.selling_price || p.price || 0),
                        category: p.category || 'General',
                        sku: p.sku || '',
                        barcode: p.barcode || '',
                        quantity: p.quantity_on_hand || p.quantity || 0,
                        icon: getCategoryIcon(p.category)
                    }));
                    
                    console.log('[POS] Mapped products:', AppState.products);
                    await saveToCache('products', AppState.products);
                    renderProducts();
                } else {
                    console.error('[POS] Failed to fetch products:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('[POS] Error details:', errorText);
                    
                    // Check for specific error conditions
                    if (response.status === 401) {
                        console.error('[POS] Authentication failed - redirecting to login');
                        alert('Session expired. Please sign in again.');
                        setTimeout(() => {
                            window.location.href = 'mobile-auth.html';
                        }, 1500);
                    } else {
                        console.log('[POS] Loading demo data due to API error');
                        loadDemoData();
                    }
                }
            } catch (error) {
                console.error('[POS] Error fetching products:', error.message || error);
                console.error('[POS] Full error:', JSON.stringify(error));
                const cached = await loadFromCache('products');
                if (cached) {
                    AppState.products = cached;
                } else {
                    loadDemoData();
                }
                renderProducts();
            }
        }

        async function fetchPaystubs() {
            try {
                if (!AppState.sessionToken) return;

                const cachedPaystubs = await loadFromCache('paystubs');
                
                if (!AppState.isOnline && cachedPaystubs) {
                    AppState.paystubs = cachedPaystubs;
                    renderPaystubs();
                    return;
                }

                const response = await fetch(`${AppState.apiUrl}/api/hr/payroll/pay-stubs/`, {
                    headers: {
                        'Authorization': `Bearer ${AppState.sessionToken}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    AppState.paystubs = data.results || data || [];
                    await saveToCache('paystubs', AppState.paystubs);
                    renderPaystubs();
                }
            } catch (error) {
                console.error('Error fetching paystubs:', error);
            }
        }

        async function fetchTaxSettings() {
            try {
                if (!AppState.sessionToken || !AppState.user) return;
                
                const country = AppState.user.country || 'US';
                console.log('[POS] ✅ NEW TAX ENDPOINT - Fetching tax rate for country:', country);
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (AppState.sessionToken) {
                    headers['Authorization'] = `Bearer ${AppState.sessionToken}`;
                    headers['Cookie'] = `sid=${AppState.sessionToken}`;
                }
                
                let response;
                // Use the Next.js proxy endpoint for POS tax rate
                const taxEndpoint = `${AppState.apiUrl}/api/pos/tax-rate`;
                console.log('[POS] ✅ Using NEW endpoint:', taxEndpoint);
                
                if (window.Capacitor && window.Capacitor.Plugins.Http) {
                    const { Http } = Capacitor.Plugins;
                    const result = await Http.request({
                        url: taxEndpoint,
                        method: 'GET',
                        headers: headers
                    });
                    response = {
                        ok: result.status >= 200 && result.status < 300,
                        json: async () => typeof result.data === 'string' ? JSON.parse(result.data) : result.data
                    };
                } else {
                    response = await fetch(taxEndpoint, {
                        method: 'GET',
                        headers: headers,
                        credentials: 'include'
                    });
                }
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[POS] Tax data received:', data);
                    
                    // Handle the response format from the Next.js API
                    if (data.estimated_rate !== undefined) {
                        // estimated_rate is returned as percentage (e.g., 18 for 18%)
                        // Convert to decimal for calculations
                        AppState.taxRate = parseFloat(data.estimated_rate) / 100 || 0;
                        
                        // Build jurisdiction string from country and region
                        let jurisdiction = data.country_name || data.country || 'Unknown';
                        if (data.region_name || data.region) {
                            jurisdiction += `, ${data.region_name || data.region}`;
                        }
                        AppState.taxJurisdiction = jurisdiction;
                        AppState.taxSource = data.source || 'none';
                        
                        console.log(`[POS] Tax rate: ${(AppState.taxRate * 100).toFixed(2)}% for ${AppState.taxJurisdiction}`);
                        console.log(`[POS] Tax source: ${AppState.taxSource} (cached: ${data.cached})`);
                        
                        // Show warning if no tax configured
                        if (AppState.taxRate === 0 && data.message) {
                            console.warn('[POS] Tax warning:', data.message);
                        }
                        
                        // Update cart display to show the tax rate
                        updateCart();
                    } else {
                        // Default to 0% if no tax rate found
                        AppState.taxRate = 0;
                        console.log('[POS] No tax rate configured for business location');
                        
                        // Update cart display even with 0% tax
                        updateCart();
                    }
                } else {
                    console.warn('[POS] Failed to fetch tax rate, defaulting to 0%');
                    AppState.taxRate = 0;
                }
            } catch (error) {
                console.error('Error fetching tax settings:', error);
            }
        }

        function loadDemoData() {
            AppState.products = [
                { id: 1, name: 'Coffee', price: 4.99, category: 'Beverages', icon: getCategoryIcon('Beverages') },
                { id: 2, name: 'Sandwich', price: 8.99, category: 'Food', icon: getCategoryIcon('Food') },
                { id: 3, name: 'Salad', price: 12.99, category: 'Food', icon: getCategoryIcon('Food') },
                { id: 4, name: 'Tea', price: 3.99, category: 'Beverages', icon: getCategoryIcon('Beverages') },
                { id: 5, name: 'Juice', price: 5.99, category: 'Beverages', icon: getCategoryIcon('Beverages') },
                { id: 6, name: 'Burger', price: 14.99, category: 'Food', icon: getCategoryIcon('Food') }
            ];
            renderProducts();
        }

        function getCategoryIcon(category) {
            const icons = {
                'Beverages': `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                    <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                    <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                    <line x1="6" y1="1" x2="6" y2="4"/>
                    <line x1="10" y1="1" x2="10" y2="4"/>
                    <line x1="14" y1="1" x2="14" y2="4"/>
                </svg>`,
                'Food': `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                    <path d="M2 2l20 20"/>
                    <path d="M9.5 2v8.5"/>
                    <path d="M14.5 2v8.5"/>
                    <path d="M12 2v8.5"/>
                    <path d="M7 22h10"/>
                    <path d="M5 16h14"/>
                </svg>`,
                'Electronics': `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                    <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                    <line x1="12" y1="18" x2="12" y2="18"/>
                </svg>`,
                'Clothing': `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                    <path d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/>
                </svg>`,
                'Books': `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>`,
                'Toys': `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                </svg>`,
                'General': `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                    <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/>
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                </svg>`
            };
            return icons[category] || icons['General'];
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            
            // Filter products based on stock toggle
            let productsToShow = AppState.products;
            if (!AppState.showOutOfStock) {
                productsToShow = AppState.products.filter(p => p.quantity > 0);
            }
            
            if (productsToShow.length === 0) {
                grid.innerHTML = '<div class="loading-products">' + (AppState.showOutOfStock ? 'No products available' : 'No products in stock (enable "Show out of stock" to see all)') + '</div>';
                return;
            }
            
            grid.innerHTML = productsToShow.map(product => `
                <div class="product-card" onclick="addToCart('${product.id}')" style="position: relative;">
                    <div class="product-icon">${product.icon || getCategoryIcon('General')}</div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">${formatPrice(product.price)}</div>
                    <div style="
                        font-size: 11px;
                        color: ${product.quantity > 10 ? '#6b7280' : product.quantity > 0 ? '#f59e0b' : '#ef4444'};
                        margin-top: 4px;
                        font-weight: 500;
                    ">
                        ${product.quantity > 0 ? `Stock: ${product.quantity}` : 'Out of Stock'}
                    </div>
                    ${product.quantity === 0 ? `<div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(255, 255, 255, 0.7);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 12px;
                        pointer-events: none;
                    ">
                        <span style="
                            background: #ef4444;
                            color: white;
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 10px;
                            font-weight: 600;
                        ">BACKORDER</span>
                    </div>` : ''}
                </div>
            `).join('');
        }

        function renderPaystubs() {
            const list = document.getElementById('paystubsList');
            
            if (AppState.paystubs.length === 0) {
                list.innerHTML = '<div class="loading-products">No paystubs available</div>';
                return;
            }
            
            list.innerHTML = AppState.paystubs.map(paystub => `
                <div class="paystub-card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: 600;">${new Date(paystub.pay_date).toLocaleDateString()}</span>
                        <span style="color: var(--primary); font-weight: 600;">$${paystub.net_pay || '0.00'}</span>
                    </div>
                    <div style="color: var(--navy-500); font-size: 14px;">
                        ${paystub.employee_name || 'Employee'} • Period: ${paystub.pay_period || 'N/A'}
                    </div>
                </div>
            `).join('');
        }

        function navigateBack() {
            console.log('[POS] Navigating back to main menu...');
            
            // Save any pending data
            if (AppState.cart && AppState.cart.length > 0) {
                const confirmLeave = confirm('You have items in your cart. Are you sure you want to leave? Your cart will be cleared.');
                if (!confirmLeave) {
                    return;
                }
            }
            
            // Clear the cart
            AppState.cart = [];
            
            // Navigate back to business menu
            window.location.href = 'mobile-business-menu.html';
        }

        function updateUserInfo() {
            // User info display removed - header simplified
        }

        function updateConnectionStatus() {
            // Connection status removed from header
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('[id$="Tab"]').forEach(container => container.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function addToCart(productId) {
            const product = AppState.products.find(p => p.id === productId);
            if (!product) return;
            
            // Check if product is in stock and handle backorder
            const isBackorder = product.quantity <= 0;
            
            if (isBackorder && !confirm('This product is out of stock. Do you want to place a backorder?')) {
                return;
            }
            
            const existingItem = AppState.cart.find(item => item.id === productId);
            
            if (existingItem) {
                // Check if adding more would exceed stock
                if (!isBackorder && existingItem.quantity >= product.quantity) {
                    if (!confirm(`Only ${product.quantity} units available. Additional units will be backordered. Continue?`)) {
                        return;
                    }
                    existingItem.isPartialBackorder = true;
                    existingItem.backorderQuantity = (existingItem.quantity + 1) - product.quantity;
                }
                existingItem.quantity += 1;
            } else {
                AppState.cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    maxStock: product.quantity,  // Track max available stock
                    isBackorder: isBackorder,
                    availableStock: product.quantity
                });
            }
            
            updateCart();
            
            // Haptic feedback if available
            if (window.Capacitor && Capacitor.Plugins.Haptics) {
                Capacitor.Plugins.Haptics.impact({ style: 'light' });
            }
        }

        function updateCart() {
            const cartContainer = document.getElementById('cartItems');
            
            if (AppState.cart.length === 0) {
                cartContainer.innerHTML = '<p style="text-align: center; color: var(--navy-400); padding: 20px;">Cart is empty</p>';
                document.getElementById('subtotal').textContent = '$0.00';
                document.getElementById('tax').textContent = '$0.00';
                document.getElementById('total').textContent = '$0.00';
                return;
            }
            
            let subtotal = 0;
            
            cartContainer.innerHTML = AppState.cart.map((item, index) => {
                subtotal += item.price * item.quantity;
                return `
                    <div class="cart-item" style="${item.isBackorder || item.isPartialBackorder ? 'background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 8px;' : ''}">
                        <div class="cart-item-info">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="cart-item-name">${item.name}</div>
                                ${item.isBackorder ? '<span style="background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">BACKORDER</span>' : ''}
                                ${item.isPartialBackorder ? `<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">PARTIAL (${item.backorderQuantity} backordered)</span>` : ''}
                            </div>
                            <div class="cart-item-price">${formatPrice(item.price)} each</div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="qty-btn" onclick="updateQuantity(${index}, -1)">−</button>
                            <span class="cart-item-qty">${item.quantity}</span>
                            <button class="qty-btn" onclick="updateQuantity(${index}, 1)">+</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            const tax = subtotal * AppState.taxRate;
            const total = subtotal + tax;
            
            document.getElementById('subtotal').textContent = formatPrice(subtotal);
            document.getElementById('tax').textContent = formatPrice(tax);
            document.getElementById('total').textContent = formatPrice(total);
            
            // Update tax label with rate and jurisdiction
            const taxLabel = document.getElementById('taxLabel');
            if (taxLabel) {
                const taxPercent = (AppState.taxRate * 100).toFixed(1);
                if (AppState.taxJurisdiction && AppState.taxJurisdiction !== 'Unknown') {
                    taxLabel.textContent = `Tax (${taxPercent}% - ${AppState.taxJurisdiction})`;
                } else {
                    taxLabel.textContent = `Tax (${taxPercent}%)`;
                }
            }
        }

        function updateQuantity(index, change) {
            AppState.cart[index].quantity += change;
            if (AppState.cart[index].quantity <= 0) {
                AppState.cart.splice(index, 1);
            }
            updateCart();
        }

        function clearCart() {
            AppState.cart = [];
            updateCart();
        }

        // List of currencies not supported by Stripe
        const UNSUPPORTED_CURRENCIES = [
            'SSP', 'SYP', 'IRR', 'KPW', 'VES', 'CUP', 'SDG', 'LYD', 'YER', 
            'SOS', 'HTG', 'MMK', 'BYN', 'TMT', 'ZWL', 'RSD', 'IQD', 'AFN',
            'TJS', 'UZS', 'KGS', 'GNF', 'XAF', 'XOF', 'BIF', 'DJF', 'ERN',
            'MRU', 'STN', 'SLE'
        ];

        async function getExchangeRate(fromCurrency, toCurrency = 'USD') {
            try {
                console.log(`[POS] Fetching exchange rate from ${fromCurrency} to ${toCurrency}`);
                
                const headers = {
                    'Authorization': `Bearer ${AppState.sessionToken}`,
                    'Cookie': `sid=${AppState.sessionToken}`
                };
                
                let response;
                if (window.Capacitor && window.Capacitor.Plugins.Http) {
                    const { Http } = Capacitor.Plugins;
                    const result = await Http.request({
                        url: `${AppState.apiUrl}/api/exchange-rate?from=${fromCurrency}&to=${toCurrency}`,
                        method: 'GET',
                        headers: headers
                    });
                    response = {
                        ok: result.status >= 200 && result.status < 300,
                        json: async () => result.data
                    };
                } else {
                    response = await fetch(`${AppState.apiUrl}/api/exchange-rate?from=${fromCurrency}&to=${toCurrency}`, {
                        headers: headers
                    });
                }
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[POS] Exchange rate:', data.rate);
                    return data.rate;
                }
                
                // Fallback exchange rates for common currencies
                const fallbackRates = {
                    'SSP': 600,  // Approximate SSP to USD
                    'UGX': 3800, // Approximate UGX to USD
                    'KES': 150,  // Approximate KES to USD
                };
                
                return fallbackRates[fromCurrency] || 1;
            } catch (error) {
                console.error('[POS] Error fetching exchange rate:', error);
                return 1; // Default to 1:1 if error
            }
        }

        async function initializeStripePayment(totalAmount) {
            try {
                console.log('[POS] Initializing Stripe payment for amount:', formatPrice(totalAmount));
                
                let paymentCurrency = AppState.currencyCode.toLowerCase();
                let paymentAmount = totalAmount;
                let exchangeRate = null;
                let originalAmount = null;
                let originalCurrency = null;
                
                // Check if currency needs conversion
                if (UNSUPPORTED_CURRENCIES.includes(AppState.currencyCode.toUpperCase())) {
                    console.log(`[POS] Currency ${AppState.currencyCode} not supported by Stripe, converting to USD`);
                    
                    // Get exchange rate
                    exchangeRate = await getExchangeRate(AppState.currencyCode, 'USD');
                    
                    // Store original amount and currency
                    originalAmount = totalAmount;
                    originalCurrency = AppState.currencyCode;
                    
                    // Convert to USD
                    paymentAmount = totalAmount / exchangeRate;
                    paymentCurrency = 'usd';
                    
                    console.log(`[POS] Converted ${formatPrice(originalAmount)} to $${paymentAmount.toFixed(2)} USD (rate: ${exchangeRate})`);
                    
                    // Show conversion info to user
                    if (confirm(`Your currency (${AppState.currencyCode}) requires conversion to USD for card payment.\n\nOriginal: ${formatPrice(originalAmount)}\nCharged: $${paymentAmount.toFixed(2)} USD\nExchange Rate: ${exchangeRate}\n\nContinue?`) === false) {
                        document.getElementById('processingOverlay').classList.remove('active');
                        return;
                    }
                }
                
                // Create payment intent
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AppState.sessionToken}`,
                    'Cookie': `sid=${AppState.sessionToken}`
                };
                
                const saleData = {
                    items: AppState.cart.map(item => ({
                        product_id: item.id,
                        product_name: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        total: item.price * item.quantity,
                        is_backorder: item.isBackorder || false,
                        is_partial_backorder: item.isPartialBackorder || false,
                        backorder_quantity: item.backorderQuantity || 0,
                        available_stock: item.availableStock || 0
                    })),
                    original_amount: originalAmount,
                    original_currency: originalCurrency,
                    exchange_rate: exchangeRate,
                    has_backorders: AppState.cart.some(item => item.isBackorder || item.isPartialBackorder)
                };
                
                let response;
                if (window.Capacitor && window.Capacitor.Plugins.Http) {
                    const { Http } = Capacitor.Plugins;
                    const result = await Http.request({
                        url: `${AppState.apiUrl}/api/payments/create-intent/`,
                        method: 'POST',
                        headers: headers,
                        data: {
                            amount: Math.round(paymentAmount * 100), // Convert to cents
                            currency: paymentCurrency,
                            sale_data: saleData,
                            customer_name: 'Walk-In Customer'
                        }
                    });
                    response = {
                        ok: result.status >= 200 && result.status < 300,
                        json: async () => result.data
                    };
                } else {
                    response = await fetch(`${AppState.apiUrl}/api/payments/create-intent/`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            amount: Math.round(paymentAmount * 100), // Convert to cents
                            currency: paymentCurrency,
                            sale_data: saleData,
                            customer_name: 'Walk-In Customer'
                        })
                    });
                }
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[POS] Payment intent created:', data.client_secret);
                    
                    // Initialize Stripe
                    const stripe = Stripe('pk_live_51OzCtC074uTqvtCMx8jRAx9PvdQJhg9HuKJvxA7XwV6VMFhzQ9oAhCOCJP7G10vw4Xwu20pxRHJ6hINKQwm84Dps00mxqZAf5Z');
                    
                    // For mobile, we need to use a different flow
                    // Open Stripe checkout or use native payment sheet
                    if (window.Capacitor) {
                        // Mobile native payment - Show card input modal
                        showMobileStripePayment(data.client_secret, paymentAmount, paymentCurrency);
                    } else {
                        // Web fallback
                        const { error } = await stripe.confirmCardPayment(data.client_secret);
                        if (!error) {
                            completeStripePayment(true);
                        } else {
                            console.error('[POS] Stripe payment error:', error);
                            completeStripePayment(false, error.message);
                        }
                    }
                } else {
                    const error = await response.json();
                    console.error('[POS] Failed to create payment intent:', error);
                    
                    // Check for minimum amount error
                    let userMessage = 'Payment initialization failed';
                    if (error.details && error.details.includes('at least $0.50')) {
                        const minAmountInLocalCurrency = Math.ceil(0.50 * exchangeRate);
                        userMessage = `Payment amount too small.\n\n` +
                            `Due to high exchange rate (${AppState.currencyCode} ${exchangeRate.toFixed(2)} = $1 USD), ` +
                            `the minimum charge is ${AppState.currencySymbol}${minAmountInLocalCurrency}.\n\n` +
                            `Your amount: ${AppState.currencySymbol}${totalAmount.toFixed(2)}\n` +
                            `Converted to: $${paymentAmount.toFixed(2)} USD\n\n` +
                            `Please add more items or use a different payment method.`;
                    } else if (error.details) {
                        userMessage = error.details;
                    } else if (error.error) {
                        userMessage = error.error;
                    }
                    
                    alert(userMessage);
                    document.getElementById('processingOverlay').classList.remove('active');
                }
            } catch (error) {
                console.error('[POS] Stripe initialization error:', error);
                alert('Payment error: ' + error.message);
                document.getElementById('processingOverlay').classList.remove('active');
            }
        }

        async function processMTNMoMoPayment(amount) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 24px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                ">
                    <h2 style="margin: 0 0 20px 0; color: #ffcc00;">MTN MoMo Payment</h2>
                    <p style="margin-bottom: 20px; color: #666;">Enter the customer's MTN MoMo number to request payment of <strong>${formatPrice(amount)}</strong></p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Phone Number</label>
                        <input type="tel" id="momoPhone" placeholder="e.g., 256700000000" style="
                            width: 100%;
                            padding: 12px;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            font-size: 16px;
                        ">
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="this.closest('.modal-overlay').remove(); document.getElementById('processingOverlay').classList.remove('active');" style="
                            flex: 1;
                            padding: 12px;
                            background: #f5f5f5;
                            border: none;
                            border-radius: 8px;
                            font-size: 16px;
                            cursor: pointer;
                        ">Cancel</button>
                        <button id="momoSubmitBtn" style="
                            flex: 1;
                            padding: 12px;
                            background: #ffcc00;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        ">Request Payment</button>
                    </div>
                </div>
            `;
            
            modal.classList.add('modal-overlay');
            document.body.appendChild(modal);
            
            // Focus on phone input
            setTimeout(() => {
                document.getElementById('momoPhone').focus();
            }, 100);
            
            // Handle submit
            document.getElementById('momoSubmitBtn').onclick = async function() {
                const phone = document.getElementById('momoPhone').value.trim();
                
                if (!phone) {
                    alert('Please enter a phone number');
                    return;
                }
                
                // Auto-initialize MoMo if not configured
                let momoToken = localStorage.getItem('momo_access_token');
                if (!momoToken) {
                    // Show initializing message
                    modal.innerHTML = `
                        <div style="
                            background: white;
                            border-radius: 16px;
                            padding: 40px;
                            text-align: center;
                            max-width: 400px;
                            width: 90%;
                        ">
                            <div class="spinner" style="margin: 0 auto 20px;"></div>
                            <h3 style="margin: 0 0 10px 0;">Initializing MoMo</h3>
                            <p style="color: #666;">Setting up payment system...</p>
                        </div>
                    `;
                    
                    try {
                        // Initialize MoMo through backend
                        const initResponse = await fetch(`${AppState.apiUrl}/api/payments/momo/initialize/`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${AppState.sessionToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (initResponse.ok) {
                            const initData = await initResponse.json();
                            momoToken = initData.access_token;
                            localStorage.setItem('momo_access_token', momoToken);
                            localStorage.setItem('momo_api_user', initData.api_user);
                            console.log('[POS] MoMo initialized successfully');
                        } else {
                            throw new Error('Failed to initialize MoMo');
                        }
                    } catch (error) {
                        console.error('[POS] MoMo initialization error:', error);
                        alert('Failed to initialize MTN MoMo. Please try again later.');
                        modal.remove();
                        document.getElementById('processingOverlay').classList.remove('active');
                        return;
                    }
                }
                
                try {
                    // Show processing
                    modal.innerHTML = `
                        <div style="
                            background: white;
                            border-radius: 16px;
                            padding: 40px;
                            text-align: center;
                            max-width: 400px;
                            width: 90%;
                        ">
                            <div class="spinner" style="margin: 0 auto 20px;"></div>
                            <h3 style="margin: 0 0 10px 0;">Processing MoMo Payment</h3>
                            <p style="color: #666;">Requesting payment from ${phone}...</p>
                            <p style="color: #666; font-size: 14px; margin-top: 10px;">Customer will receive a payment prompt on their phone</p>
                        </div>
                    `;
                    
                    // Make API call to request payment
                    const referenceId = generateUUID();
                    const response = await fetch(`${AppState.apiUrl}/api/payments/mobile-money/initialize/`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${AppState.sessionToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            phone_number: phone,
                            amount: amount,
                            currency: AppState.currencyCode,
                            reference: referenceId,
                            provider: 'mtn_momo',
                            message: `Payment for order at ${AppState.user?.business_name || 'Store'}`
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const paymentReference = result.reference_id || referenceId;
                        
                        // Show processing status
                        modal.innerHTML = `
                            <div style="
                                background: white;
                                border-radius: 16px;
                                padding: 40px;
                                text-align: center;
                                max-width: 400px;
                                width: 90%;
                            ">
                                <div style="
                                    width: 60px;
                                    height: 60px;
                                    border: 3px solid #f3f4f6;
                                    border-top: 3px solid #ffcc00;
                                    border-radius: 50%;
                                    margin: 0 auto 20px;
                                    animation: spin 1s linear infinite;
                                "></div>
                                <h3 style="margin: 0 0 10px 0; color: #333;">Payment Request Sent</h3>
                                <p style="color: #666;">Waiting for customer approval...</p>
                                <p style="color: #999; font-size: 14px; margin-top: 10px;">Reference: ${paymentReference.substring(0, 8)}</p>
                            </div>
                        `;
                        
                        // Poll for payment status
                        let attempts = 0;
                        const maxAttempts = 24; // 2 minutes with 5-second intervals
                        
                        const checkStatus = async () => {
                            try {
                                const statusResponse = await fetch(`${AppState.apiUrl}/api/payments/mobile-money/status/${paymentReference}/`, {
                                    headers: {
                                        'Authorization': `Bearer ${AppState.sessionToken}`,
                                        'Content-Type': 'application/json'
                                    }
                                });
                                
                                if (statusResponse.ok) {
                                    const statusData = await statusResponse.json();
                                    console.log('[POS] MTN MoMo status:', statusData);
                                    
                                    if (statusData.status === 'SUCCESSFUL' || statusData.status === 'COMPLETED') {
                                        // Payment successful
                                        modal.innerHTML = `
                                            <div style="
                                                background: white;
                                                border-radius: 16px;
                                                padding: 40px;
                                                text-align: center;
                                                max-width: 400px;
                                                width: 90%;
                                            ">
                                                <div style="
                                                    width: 60px;
                                                    height: 60px;
                                                    background: #16a34a;
                                                    border-radius: 50%;
                                                    margin: 0 auto 20px;
                                                    display: flex;
                                                    align-items: center;
                                                    justify-content: center;
                                                ">
                                                    <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                                                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                                    </svg>
                                                </div>
                                                <h3 style="margin: 0 0 10px 0; color: #16a34a;">Payment Successful!</h3>
                                                <p style="color: #666;">Transaction completed</p>
                                                <button onclick="window.location.reload();" style="
                                                    margin-top: 20px;
                                                    padding: 12px 24px;
                                                    background: #ffcc00;
                                                    color: white;
                                                    border: none;
                                                    border-radius: 8px;
                                                    font-size: 16px;
                                                    font-weight: 600;
                                                    cursor: pointer;
                                                ">Complete Sale</button>
                                            </div>
                                        `;
                                        
                                        // Clear cart
                                        AppState.cart = [];
                                        await saveOfflineData();
                                        
                                        // Record transaction
                                        const transaction = {
                                            id: paymentReference,
                                            timestamp: new Date().toISOString(),
                                            items: [...AppState.cart],
                                            total: amount,
                                            payment_method: 'mtnmomo',
                                            status: 'completed'
                                        };
                                        AppState.lastTransaction = transaction;
                                        
                                        return true;
                                    } else if (statusData.status === 'FAILED' || statusData.status === 'REJECTED') {
                                        throw new Error('Payment was declined');
                                    }
                                }
                            } catch (error) {
                                console.error('[POS] Error checking status:', error);
                            }
                            return false;
                        };
                        
                        // Start polling
                        const pollInterval = setInterval(async () => {
                            attempts++;
                            const success = await checkStatus();
                            
                            if (success || attempts >= maxAttempts) {
                                clearInterval(pollInterval);
                                
                                if (attempts >= maxAttempts) {
                                    modal.innerHTML = `
                                        <div style="
                                            background: white;
                                            border-radius: 16px;
                                            padding: 40px;
                                            text-align: center;
                                            max-width: 400px;
                                            width: 90%;
                                        ">
                                            <div style="
                                                width: 60px;
                                                height: 60px;
                                                background: #ef4444;
                                                border-radius: 50%;
                                                margin: 0 auto 20px;
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                            ">
                                                <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                                </svg>
                                            </div>
                                            <h3 style="margin: 0 0 10px 0; color: #ef4444;">Payment Timeout</h3>
                                            <p style="color: #666;">Please check with customer</p>
                                            <button onclick="document.body.removeChild(window.currentMoMoModal); window.currentMoMoModal = null;" style="
                                                margin-top: 20px;
                                                padding: 12px 24px;
                                                background: #6b7280;
                                                color: white;
                                                border: none;
                                                border-radius: 8px;
                                                font-size: 16px;
                                                font-weight: 600;
                                                cursor: pointer;
                                            ">Close</button>
                                        </div>
                                    `;
                                }
                            }
                        }, 5000);
                        
                        // Check immediately as well
                        checkStatus();
                        
                    } else {
                        throw new Error('Payment request failed');
                    }
                    
                } catch (error) {
                    console.error('[POS] MTN MoMo payment error:', error);
                    modal.innerHTML = `
                        <div style="
                            background: white;
                            border-radius: 16px;
                            padding: 40px;
                            text-align: center;
                            max-width: 400px;
                            width: 90%;
                        ">
                            <div style="
                                width: 60px;
                                height: 60px;
                                background: #dc2626;
                                border-radius: 50%;
                                margin: 0 auto 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
                                </svg>
                            </div>
                            <h3 style="margin: 0 0 10px 0; color: #dc2626;">Payment Failed</h3>
                            <p style="color: #666;">${error.message}</p>
                            <button onclick="this.closest('.modal-overlay').remove(); document.getElementById('processingOverlay').classList.remove('active');" style="
                                margin-top: 20px;
                                padding: 12px 24px;
                                background: #f5f5f5;
                                border: none;
                                border-radius: 8px;
                                font-size: 16px;
                                cursor: pointer;
                            ">Close</button>
                        </div>
                    `;
                }
            };
        }
        
        async function processMpesaPayment(amount) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 24px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                ">
                    <h2 style="margin: 0 0 20px 0; color: #0d4f8a;">M-Pesa Payment</h2>
                    <p style="margin-bottom: 20px; color: #666;">Enter the customer's M-Pesa phone number to request payment of <strong>${formatPrice(amount)}</strong></p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Phone Number</label>
                        <input type="tel" id="mpesaPhone" placeholder="e.g., 254712345678" style="
                            width: 100%;
                            padding: 12px;
                            border: 2px solid #e5e7eb;
                            border-radius: 8px;
                            font-size: 16px;
                            box-sizing: border-box;
                        " />
                        <small style="color: #666; margin-top: 4px; display: block;">Include country code (e.g., 254 for Kenya)</small>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="cancelMpesaPayment()" style="
                            flex: 1;
                            padding: 12px;
                            border: 1px solid #d1d5db;
                            background: white;
                            border-radius: 8px;
                            font-size: 16px;
                            cursor: pointer;
                        ">Cancel</button>
                        <button onclick="confirmMpesaPayment(${amount})" style="
                            flex: 1;
                            padding: 12px;
                            border: none;
                            background: #10b981;
                            color: white;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 500;
                            cursor: pointer;
                        ">Send Payment Request</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentMpesaModal = modal;
            
            // Focus on phone input
            setTimeout(() => {
                document.getElementById('mpesaPhone').focus();
            }, 100);
        }
        
        function cancelMpesaPayment() {
            if (window.currentMpesaModal) {
                document.body.removeChild(window.currentMpesaModal);
                window.currentMpesaModal = null;
            }
            document.getElementById('processingOverlay').classList.remove('active');
        }
        
        async function confirmMpesaPayment(amount) {
            const phone = document.getElementById('mpesaPhone').value.trim();
            
            if (!phone) {
                alert('Please enter a phone number');
                return;
            }
            
            // Basic phone validation
            if (!/^\d{10,15}$/.test(phone)) {
                alert('Please enter a valid phone number with country code');
                return;
            }
            
            // Remove modal
            if (window.currentMpesaModal) {
                document.body.removeChild(window.currentMpesaModal);
                window.currentMpesaModal = null;
            }
            
            try {
                // Show processing status
                showMpesaProcessingStatus('Initiating M-Pesa payment...');
                
                // Prepare transaction data
                const subtotal = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const tax = subtotal * AppState.taxRate;
                const total = subtotal + tax;
                
                // Create POS transaction first
                const transaction = {
                    items: AppState.cart.map(item => ({
                        product_id: item.id,
                        product_name: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        total: item.price * item.quantity
                    })),
                    subtotal: subtotal,
                    tax: tax,
                    total: total,
                    payment_method: 'mpesa',
                    phone_number: phone,
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                };
                
                // Save transaction
                const transactionResponse = await sendTransactionToServer(transaction);
                const transactionId = transactionResponse.id || transactionResponse.transaction_id;
                
                // Initiate M-Pesa payment
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (AppState.sessionToken) {
                    headers['Authorization'] = `Bearer ${AppState.sessionToken}`;
                    headers['Cookie'] = `sid=${AppState.sessionToken}`;
                    headers['x-session-token'] = AppState.sessionToken;
                }
                
                if (AppState.tenantId) {
                    headers['X-Tenant-ID'] = AppState.tenantId;
                }
                
                console.log('[POS] Initiating M-Pesa payment:', { phone, amount: total });
                
                const mpesaResponse = await fetch(`${AppState.apiUrl}/api/payments/mobile-money/initialize/`, {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        phone_number: phone,
                        amount: total.toFixed(2),
                        reference: `POS-${transactionId}`,
                        provider: 'mpesa',
                        message: `POS Sale - ${AppState.cart.length} items`,
                        transaction_id: transactionId
                    })
                });
                
                if (!mpesaResponse.ok) {
                    const error = await mpesaResponse.json();
                    throw new Error(error.error || error.message || 'Failed to initiate M-Pesa payment');
                }
                
                const mpesaData = await mpesaResponse.json();
                console.log('[POS] M-Pesa initiation response:', mpesaData);
                
                // Update status
                showMpesaProcessingStatus('Payment request sent to your phone. Please enter your M-Pesa PIN to complete.');
                
                // Start polling for payment status
                const checkoutRequestId = mpesaData.checkout_request_id || mpesaData.CheckoutRequestID;
                if (checkoutRequestId) {
                    pollMpesaStatus(checkoutRequestId, transactionId, transaction);
                } else {
                    // If no checkout request ID, show success anyway (for testing)
                    setTimeout(() => {
                        completeMpesaPayment(transaction);
                    }, 3000);
                }
                
            } catch (error) {
                console.error('[POS] M-Pesa payment error:', error);
                alert('Failed to process M-Pesa payment: ' + error.message);
                document.getElementById('processingOverlay').classList.remove('active');
            }
        }
        
        function showMpesaProcessingStatus(message) {
            const overlay = document.getElementById('processingOverlay');
            const content = overlay.querySelector('.processing-content p');
            if (content) {
                content.textContent = message;
            }
        }
        
        async function pollMpesaStatus(checkoutRequestId, transactionId, transaction) {
            let attempts = 0;
            const maxAttempts = 30; // Poll for up to 30 seconds
            
            const pollInterval = setInterval(async () => {
                attempts++;
                
                try {
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    if (AppState.sessionToken) {
                        headers['Authorization'] = `Bearer ${AppState.sessionToken}`;
                        headers['Cookie'] = `sid=${AppState.sessionToken}`;
                        headers['x-session-token'] = AppState.sessionToken;
                    }
                    
                    const statusResponse = await fetch(`${AppState.apiUrl}/api/payments/mobile-money/status/${checkoutRequestId}/`, {
                        headers: headers,
                        credentials: 'include'
                    });
                    
                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        console.log('[POS] M-Pesa status:', statusData);
                        
                        if (statusData.status === 'completed' || statusData.ResultCode === '0') {
                            clearInterval(pollInterval);
                            completeMpesaPayment(transaction);
                        } else if (statusData.status === 'failed' || (statusData.ResultCode && statusData.ResultCode !== '0')) {
                            clearInterval(pollInterval);
                            alert('M-Pesa payment failed. Please try again.');
                            document.getElementById('processingOverlay').classList.remove('active');
                        } else if (attempts >= maxAttempts) {
                            clearInterval(pollInterval);
                            alert('M-Pesa payment timeout. Please check your phone and try again.');
                            document.getElementById('processingOverlay').classList.remove('active');
                        }
                    }
                } catch (error) {
                    console.error('[POS] Error polling M-Pesa status:', error);
                }
                
                if (attempts >= maxAttempts) {
                    clearInterval(pollInterval);
                    alert('M-Pesa payment timeout. Please check your phone and try again.');
                    document.getElementById('processingOverlay').classList.remove('active');
                }
            }, 1000); // Poll every second
        }
        
        function completeMpesaPayment(transaction) {
            // Clear cart
            AppState.cart = [];
            updateCart();
            
            // Store last transaction for receipt
            AppState.lastTransaction = transaction;
            transaction.status = 'completed';
            
            // Hide processing overlay
            document.getElementById('processingOverlay').classList.remove('active');
            
            // Show receipt modal
            showReceiptModal(transaction);
            
            // Success haptic feedback
            if (window.Haptics) {
                Haptics.impact({ style: 'medium' });
            }
        }
        // Duplicate M-Pesa functions removed - using the first implementation

        function completeStripePayment(success, errorMessage = null) {
            const overlay = document.getElementById('processingOverlay');
            overlay.classList.remove('active');
            
            if (success) {
                // Record successful transaction
                const transaction = {
                    items: AppState.cart.map(item => ({
                        product_id: item.id,
                        product_name: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        total: item.price * item.quantity
                    })),
                    subtotal: AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    tax: AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) * AppState.taxRate,
                    total: AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) * (1 + AppState.taxRate),
                    payment_method: 'card',
                    status: 'completed',
                    timestamp: new Date().toISOString()
                };
                
                // Store last transaction for receipt
                AppState.lastTransaction = transaction;
                
                // Save transaction (this triggers double-entry accounting in backend)
                if (navigator.onLine) {
                    sendTransactionToServer(transaction);
                } else {
                    queueTransaction(transaction);
                }
                
                // Clear cart
                clearCart();
                
                // Show receipt modal
                showReceiptModal(transaction);
            } else {
                alert('Payment failed: ' + (errorMessage || 'Unknown error'));
            }
        }
        
        function showReceiptModal(transaction) {
            // Create receipt modal HTML
            const modalHtml = `
                <div id="receiptModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                ">
                    <div style="
                        background: white;
                        border-radius: 16px;
                        padding: 24px;
                        max-width: 400px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                    ">
                        <h2 style="margin: 0 0 20px 0; color: #10b981;">✓ Payment Successful!</h2>
                        <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">
                            ${formatPrice(transaction.total)}
                        </p>
                        
                        <div style="border-top: 1px solid #e5e7eb; margin: 20px 0; padding-top: 20px;">
                            <h3 style="margin: 0 0 15px 0;">Send Receipt To Customer</h3>
                            
                            <input type="text" id="customerContact" placeholder="Enter email or phone number" style="
                                width: 100%;
                                padding: 12px;
                                border: 1px solid #d1d5db;
                                border-radius: 8px;
                                margin-bottom: 15px;
                                box-sizing: border-box;
                            ">
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <button onclick="sendReceipt('email')" style="
                                    padding: 12px;
                                    background: #3b82f6;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                ">
                                    📧 Email
                                </button>
                                <button onclick="sendReceipt('whatsapp')" style="
                                    padding: 12px;
                                    background: #25d366;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                ">
                                    💬 WhatsApp
                                </button>
                                <button onclick="sendReceipt('sms')" style="
                                    padding: 12px;
                                    background: #6b7280;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                ">
                                    📱 SMS
                                </button>
                            </div>
                            
                            <button onclick="closeReceiptModal()" style="
                                width: 100%;
                                padding: 12px;
                                background: #f3f4f6;
                                color: #374151;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                margin-top: 10px;
                            ">
                                Skip & Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeReceiptModal() {
            const modal = document.getElementById('receiptModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function sendReceipt(method) {
            const contact = document.getElementById('customerContact').value;
            if (!contact) {
                alert('Please enter customer email or phone number');
                return;
            }
            
            console.log(`[POS] Sending receipt via ${method} to ${contact}`);
            
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AppState.sessionToken}`,
                    'Cookie': `sid=${AppState.sessionToken}`
                };
                
                const receiptData = {
                    transaction: AppState.lastTransaction,
                    method: method,
                    contact: contact,
                    currency: AppState.currencyCode,
                    business_name: AppState.user?.tenant_name || 'Dott Business'
                };
                
                if (method === 'whatsapp') {
                    // Format WhatsApp message
                    const message = formatWhatsAppReceipt(AppState.lastTransaction);
                    const phoneNumber = contact.replace(/\D/g, ''); // Remove non-digits
                    
                    if (window.Capacitor) {
                        // On mobile, open WhatsApp directly
                        window.open(`whatsapp://send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`);
                    } else {
                        // On web, use WhatsApp Web
                        window.open(`https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`);
                    }
                    closeReceiptModal();
                    
                } else if (method === 'sms') {
                    // For SMS, we can use the device's native SMS app
                    const message = formatSMSReceipt(AppState.lastTransaction);
                    const phoneNumber = contact.replace(/\D/g, '');
                    
                    if (window.Capacitor) {
                        // On mobile, open native SMS app
                        window.open(`sms:${phoneNumber}?body=${encodeURIComponent(message)}`);
                    } else {
                        alert('SMS can only be sent from mobile devices');
                    }
                    closeReceiptModal();
                    
                } else if (method === 'email') {
                    // Send email receipt via backend API
                    let response;
                    if (window.Capacitor && window.Capacitor.Plugins.Http) {
                        const { Http } = Capacitor.Plugins;
                        const result = await Http.request({
                            url: `${AppState.apiUrl}/api/receipts/send/`,
                            method: 'POST',
                            headers: headers,
                            data: receiptData
                        });
                        response = { ok: result.status >= 200 && result.status < 300 };
                    } else {
                        response = await fetch(`${AppState.apiUrl}/api/receipts/send/`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(receiptData)
                        });
                    }
                    
                    if (response.ok) {
                        alert('Receipt sent successfully!');
                        closeReceiptModal();
                    } else {
                        alert('Failed to send receipt. Please try again.');
                    }
                }
            } catch (error) {
                console.error(`[POS] Error sending receipt:`, error);
                alert('Error sending receipt: ' + error.message);
            }
        }
        
        function formatWhatsAppReceipt(transaction) {
            const items = transaction.items.map(item => 
                `${item.quantity}x ${item.product_name} - ${formatPrice(item.total)}`
            ).join('\n');
            
            return `🧾 *RECEIPT*\n` +
                   `Business: ${AppState.user?.tenant_name || 'Dott Business'}\n` +
                   `Date: ${new Date(transaction.timestamp).toLocaleString()}\n\n` +
                   `*Items:*\n${items}\n\n` +
                   `Subtotal: ${formatPrice(transaction.subtotal)}\n` +
                   `Tax: ${formatPrice(transaction.tax)}\n` +
                   `*Total: ${formatPrice(transaction.total)}*\n\n` +
                   `Payment: ${transaction.payment_method.toUpperCase()}\n` +
                   `Thank you for your purchase!`;
        }
        
        function formatSMSReceipt(transaction) {
            return `Receipt: ${formatPrice(transaction.total)} paid. ` +
                   `${transaction.items.length} items. ` +
                   `Thank you for shopping at ${AppState.user?.tenant_name || 'Dott Business'}!`;
        }

        async function processPayment(method) {
            const overlay = document.getElementById('processingOverlay');
            overlay.classList.add('active');
            
            const subtotal = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * AppState.taxRate;
            const total = subtotal + tax;
            
            // Handle M-Pesa payment
            if (method === 'mpesa') {
                try {
                    await processMpesaPayment(total);
                } catch (error) {
                    console.error('[POS] M-Pesa payment error:', error);
                    alert('M-Pesa payment failed: ' + error.message);
                    overlay.classList.remove('active');
                }
                return;
            }
            
            // Handle MTN MoMo payment
            if (method === 'mtnmomo') {
                try {
                    await processMTNMoMoPayment(total);
                } catch (error) {
                    console.error('[POS] MTN MoMo payment error:', error);
                    alert('MTN MoMo payment failed: ' + error.message);
                    overlay.classList.remove('active');
                }
                return;
            }
            
            // If card payment, check for Tap to Pay support first
            if (method === 'card') {
                // Check if device supports Tap to Pay on iPhone
                if (window.webkit?.messageHandlers?.tapToPay) {
                    try {
                        // Check device compatibility
                        const supportCheck = await checkTapToPaySupport();
                        if (supportCheck.supported) {
                            // Use Tap to Pay
                            const result = await processTapToPayPayment(total);
                            if (result.success) {
                                completeTransaction(method, result.paymentIntentId);
                                return;
                            }
                        } else {
                            console.log('[POS] Tap to Pay not supported:', supportCheck.reason);
                            // Fall back to manual card entry
                        }
                    } catch (error) {
                        console.error('[POS] Tap to Pay error:', error);
                        // Fall back to manual card entry
                    }
                }
                
                // Check if currency needs conversion and validate minimum
                const UNSUPPORTED_CURRENCIES = ['SSP', 'SYP', 'IRR', 'VES', 'CUP', 'SDG', 'LYD', 'YER', 'SOS', 'HTG', 'MMK', 'BYN', 'ZWL', 'IQD', 'AFN'];
                
                if (UNSUPPORTED_CURRENCIES.includes(AppState.currencyCode.toUpperCase())) {
                    const exchangeRate = await getExchangeRate(AppState.currencyCode, 'USD');
                    const usdAmount = total / exchangeRate;
                    
                    // Check if amount meets Stripe minimum
                    if (usdAmount < 0.50) {
                        const minAmountInLocalCurrency = Math.ceil(0.50 * exchangeRate);
                        alert(`Payment amount too small for card processing.\n\n` +
                            `Due to exchange rate (${AppState.currencyCode} ${exchangeRate.toFixed(2)} = $1 USD), ` +
                            `minimum card payment is ${AppState.currencySymbol}${minAmountInLocalCurrency}.\n\n` +
                            `Your total: ${AppState.currencySymbol}${total.toFixed(2)}\n` +
                            `Converts to: $${usdAmount.toFixed(2)} USD\n\n` +
                            `Please add more items or use cash payment.`);
                        overlay.classList.remove('active');
                        return;
                    }
                }
                
                initializeStripePayment(total);
                return;
            }
            
            const transaction = {
                items: AppState.cart.map(item => ({
                    product_id: item.id,
                    product_name: item.name,
                    quantity: item.quantity,
                    price: item.price,
                    total: item.price * item.quantity,
                    is_backorder: item.isBackorder || false,
                    is_partial_backorder: item.isPartialBackorder || false,
                    backorder_quantity: item.backorderQuantity || 0
                })),
                subtotal: subtotal,
                tax: tax,
                total: total,
                payment_method: method,
                timestamp: new Date().toISOString(),
                status: 'completed',
                has_backorders: AppState.cart.some(item => item.isBackorder || item.isPartialBackorder)
            };
            
            // Store last transaction for receipt
            AppState.lastTransaction = transaction;
            
            try {
                // Save transaction (this triggers double-entry accounting in backend)
                if (AppState.isOnline && AppState.sessionToken) {
                    await sendTransactionToServer(transaction);
                } else {
                    await queueTransaction(transaction);
                }
                
                // Clear cart after successful payment
                AppState.cart = [];
                updateCart();
                overlay.classList.remove('active');
                
                // Show receipt modal
                showReceiptModal(transaction);
                
                // Success haptic feedback
                if (window.Haptics) {
                    Haptics.impact({ style: 'medium' });
                }
                
            } catch (error) {
                console.error('Payment error:', error);
                await queueTransaction(transaction);
                overlay.classList.remove('active');
                
                // Still show receipt modal even if offline
                showReceiptModal(transaction);
            }
        }

        // Apple Pay functions removed - was causing issues

        async function sendTransactionToServer(transaction) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AppState.sessionToken}`,
                    'Cookie': `sid=${AppState.sessionToken}`
                };
                
                let response;
                if (window.Capacitor && window.Capacitor.Plugins.Http) {
                    const { Http } = Capacitor.Plugins;
                    const result = await Http.request({
                        url: `${AppState.apiUrl}/api/sales/transactions/`,
                        method: 'POST',
                        headers: headers,
                        data: transaction
                    });
                    response = {
                        ok: result.status >= 200 && result.status < 300,
                        json: async () => result.data
                    };
                } else {
                    response = await fetch(`${AppState.apiUrl}/api/sales/transactions/`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(transaction)
                    });
                }
                
                if (response.ok) {
                    console.log('[POS] Transaction saved successfully');
                } else {
                    console.error('[POS] Failed to save transaction');
                    // Queue it for retry
                    queueTransaction(transaction);
                }
            } catch (error) {
                console.error('[POS] Error sending transaction:', error);
                queueTransaction(transaction);
            }
        }

        async function queueTransaction(transaction) {
            try {
                const queueKey = 'offline_queue';
                const queue = await loadFromCache(queueKey) || [];
                queue.push({
                    id: Date.now(),
                    type: 'sales/transactions',
                    data: transaction
                });
                await saveToCache(queueKey, queue);
            } catch (error) {
                console.error('Error queuing transaction:', error);
            }
        }

        async function syncOfflineData() {
            if (!AppState.isOnline || !AppState.sessionToken) return;
            
            try {
                const queue = await loadFromCache('offline_queue') || [];
                if (queue.length === 0) return;
                
                console.log(`Syncing ${queue.length} offline transactions...`);
                const synced = [];
                
                for (const item of queue) {
                    try {
                        const response = await fetch(`${AppState.apiUrl}/api/${item.type}/`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${AppState.sessionToken}`,
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify(item.data)
                        });
                        
                        if (response.ok) {
                            synced.push(item.id);
                        }
                    } catch (error) {
                        console.error(`Failed to sync transaction ${item.id}:`, error);
                    }
                }
                
                const remaining = queue.filter(item => !synced.includes(item.id));
                await saveToCache('offline_queue', remaining);
                
                if (synced.length > 0) {
                    console.log(`Successfully synced ${synced.length} transactions`);
                }
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        async function saveToCache(key, data) {
            try {
                if (window.Capacitor) {
                    const { Preferences } = Capacitor.Plugins;
                    await Preferences.set({
                        key: `cache_${key}`,
                        value: JSON.stringify(data)
                    });
                } else {
                    localStorage.setItem(`cache_${key}`, JSON.stringify(data));
                }
            } catch (error) {
                console.error('Cache save error:', error);
            }
        }

        async function loadFromCache(key) {
            try {
                if (window.Capacitor) {
                    const { Preferences } = Capacitor.Plugins;
                    const { value } = await Preferences.get({ key: `cache_${key}` });
                    return value ? JSON.parse(value) : null;
                } else {
                    const data = localStorage.getItem(`cache_${key}`);
                    return data ? JSON.parse(data) : null;
                }
            } catch (error) {
                console.error('Cache load error:', error);
                return null;
            }
        }

        function toggleOutOfStock() {
            AppState.showOutOfStock = !AppState.showOutOfStock;
            const toggle = document.getElementById('stockToggle');
            toggle.classList.toggle('active');
            
            // Re-render products with new filter
            renderProducts();
        }

        function searchProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let filtered = AppState.products.filter(p => 
                p.name.toLowerCase().includes(searchTerm) ||
                p.sku?.toLowerCase().includes(searchTerm) ||
                p.barcode?.includes(searchTerm)
            );
            
            // Apply stock filter if toggle is off
            if (!AppState.showOutOfStock) {
                filtered = filtered.filter(p => p.quantity > 0);
            }
            
            const grid = document.getElementById('productsGrid');
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="loading-products">No products found</div>';
                return;
            }
            
            grid.innerHTML = filtered.map(product => `
                <div class="product-card" onclick="addToCart('${product.id}')" style="position: relative;">
                    <div class="product-icon">${product.icon || getCategoryIcon('General')}</div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">${formatPrice(product.price)}</div>
                    <div style="
                        font-size: 11px;
                        color: ${product.quantity > 10 ? '#6b7280' : product.quantity > 0 ? '#f59e0b' : '#ef4444'};
                        margin-top: 4px;
                        font-weight: 500;
                    ">
                        ${product.quantity > 0 ? `Stock: ${product.quantity}` : 'Out of Stock'}
                    </div>
                    ${product.quantity === 0 ? `<div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(255, 255, 255, 0.7);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 12px;
                        pointer-events: none;
                    ">
                        <span style="
                            background: #ef4444;
                            color: white;
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 10px;
                            font-weight: 600;
                        ">BACKORDER</span>
                    </div>` : ''}
                </div>
            `).join('');
        }

        function searchPaystubs() {
            // Implement paystub search
        }

        // Scanner implementation
        let scannerActive = false;
        let scannerTimeout = null;
        let scannerBuffer = '';

        async function openScanner() {
            console.log('[POS] Opening scanner...');
            console.log('[POS] Capacitor available:', !!window.Capacitor);
            console.log('[POS] Capacitor.isNativePlatform:', window.Capacitor?.isNativePlatform?.());
            
            // Check if running in native Capacitor app
            if (window.Capacitor && window.Capacitor.isNativePlatform()) {
                console.log('[POS] Using native camera scanner');
                // Try to use the device's native camera directly
                startNativeCameraScanner();
            } else {
                console.log('[POS] Using web camera scanner');
                // Fallback to web camera scanner
                startWebScanner();
            }
        }

        async function startNativeCameraScanner() {
            console.log('[POS] Starting native camera scanner...');
            
            // Create scanner modal for native camera
            const scannerModal = document.createElement('div');
            scannerModal.id = 'native-scanner-modal';
            scannerModal.style.cssText = 'position: fixed; inset: 0; background: #000; z-index: 9999;';
            scannerModal.innerHTML = `
                <div style="position: relative; width: 100%; height: 100%;">
                    <video id="scanner-video" style="width: 100%; height: 100%; object-fit: cover;" playsinline autoplay></video>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none;">
                        <div style="width: 250px; height: 250px; border: 3px solid #10b981; border-radius: 20px;"></div>
                        <p style="color: white; text-align: center; margin-top: 20px; font-size: 16px;">Align barcode in frame</p>
                    </div>
                    <button onclick="stopNativeScanner()" style="position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; padding: 12px 32px; border: none; border-radius: 8px; font-size: 16px;">
                        Cancel
                    </button>
                </div>
            `;
            document.body.appendChild(scannerModal);
            
            try {
                // Request camera permission and start video stream
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                
                const video = document.getElementById('scanner-video');
                video.srcObject = stream;
                
                // Wait for video to be ready
                video.onloadedmetadata = () => {
                    video.play();
                    scannerActive = true;
                    
                    // Start scanning for barcodes
                    startBarcodeDetection(video);
                };
            } catch (error) {
                console.error('[POS] Camera error:', error);
                alert('Failed to access camera. Please check permissions in Settings > Dott > Camera');
                stopNativeScanner();
            }
        }

        function stopNativeScanner() {
            console.log('[POS] Stopping native scanner...');
            scannerActive = false;
            
            const video = document.getElementById('scanner-video');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            
            const modal = document.getElementById('native-scanner-modal');
            if (modal) {
                modal.remove();
            }
        }

        async function startBarcodeDetection(video) {
            if (!scannerActive) return;
            
            // Try to use BarcodeDetector if available (iOS 15.4+)
            if ('BarcodeDetector' in window) {
                console.log('[POS] Using native BarcodeDetector API');
                try {
                    const barcodeDetector = new BarcodeDetector({
                        formats: ['qr_code', 'code_128', 'code_39', 'ean_13', 'ean_8', 'upc_a', 'upc_e']
                    });
                    
                    const detectLoop = async () => {
                        if (!scannerActive) return;
                        
                        try {
                            const barcodes = await barcodeDetector.detect(video);
                            if (barcodes.length > 0) {
                                console.log('[POS] Barcode detected:', barcodes[0].rawValue);
                                handleScanResult(barcodes[0].rawValue);
                                stopNativeScanner();
                                return;
                            }
                        } catch (err) {
                            // Ignore frame errors
                        }
                        
                        if (scannerActive) {
                            requestAnimationFrame(detectLoop);
                        }
                    };
                    
                    detectLoop();
                } catch (error) {
                    console.error('[POS] BarcodeDetector error:', error);
                    // Fall back to jsQR library
                    startJsQRFallback(video);
                }
            } else {
                console.log('[POS] BarcodeDetector not available, using jsQR fallback');
                // Use jsQR library as fallback for older iOS versions
                startJsQRFallback(video);
            }
        }

        // Fallback scanner using jsQR library for older iOS versions
        function startJsQRFallback(video) {
            console.log('[POS] Starting jsQR fallback scanner...');
            
            // Load jsQR library dynamically if not already loaded
            if (typeof jsQR === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
                script.onload = () => {
                    console.log('[POS] jsQR library loaded');
                    startJsQRScanning(video);
                };
                script.onerror = () => {
                    console.error('[POS] Failed to load jsQR library');
                    showUpgradePrompt();
                };
                document.head.appendChild(script);
            } else {
                startJsQRScanning(video);
            }
        }

        function startJsQRScanning(video) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            const scan = () => {
                if (!scannerActive) return;
                
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    try {
                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "dontInvert"
                        });
                        
                        if (code) {
                            console.log('[POS] QR code detected by jsQR:', code.data);
                            handleScanResult(code.data);
                            stopNativeScanner();
                            return;
                        }
                    } catch (err) {
                        console.error('[POS] jsQR scan error:', err);
                    }
                }
                
                if (scannerActive) {
                    requestAnimationFrame(scan);
                }
            };
            
            // Show notice that this works best with QR codes
            const notice = document.createElement('p');
            notice.style.cssText = 'position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); color: #fbbf24; text-align: center; font-size: 14px; padding: 0 20px;';
            notice.textContent = 'Note: QR codes work best. For barcodes, consider upgrading iOS.';
            document.getElementById('native-scanner-modal').appendChild(notice);
            
            scan();
        }

        function showUpgradePrompt() {
            stopNativeScanner();
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; max-width: 350px; text-align: center;">
                    <svg style="width: 48px; height: 48px; margin: 0 auto 16px; color: #f59e0b;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <h3 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 600;">iOS Update Recommended</h3>
                    <p style="margin: 0 0 16px 0; color: #6b7280; font-size: 14px; line-height: 1.5;">
                        For the best scanning experience, please update to iOS 15.4 or later. 
                        You can still use manual entry or try QR codes which may work on your current version.
                    </p>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="this.closest('div[style*=\\"position: fixed\\"]').remove(); openScanner();" style="flex: 1; padding: 10px; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; font-weight: 500;">
                            Try Anyway
                        </button>
                        <button onclick="this.closest('div[style*=\\"position: fixed\\"]').remove();" style="flex: 1; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 500;">
                            Use Manual Entry
                        </button>
                    </div>
                    <p style="margin: 12px 0 0 0; color: #9ca3af; font-size: 12px;">
                        Go to Settings > General > Software Update
                    </p>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function startCapacitorScanner() {
            try {
                const { BarcodeScanner } = Capacitor.Plugins;
                
                // Check camera permission
                const status = await BarcodeScanner.checkPermission({ force: true });
                
                if (!status.granted) {
                    alert('Camera permission is required to scan barcodes');
                    return;
                }
                
                // Hide background content for scanner
                document.body.classList.add('scanner-active');
                
                // Create scanner UI overlay
                const scannerOverlay = document.createElement('div');
                scannerOverlay.id = 'scanner-overlay';
                scannerOverlay.innerHTML = `
                    <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            <div style="width: 250px; height: 250px; border: 2px solid #10b981; border-radius: 20px; position: relative;">
                                <div style="position: absolute; top: -40px; left: 50%; transform: translateX(-50%); color: white; text-align: center; width: 300px;">
                                    <p style="font-size: 18px; margin: 0;">Position barcode or QR code in frame</p>
                                    <p style="font-size: 14px; margin-top: 8px; opacity: 0.8;">Scanning automatically...</p>
                                </div>
                            </div>
                        </div>
                        <button onclick="stopCapacitorScanner()" style="position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; padding: 12px 32px; border: none; border-radius: 8px; font-size: 16px;">
                            Cancel Scan
                        </button>
                    </div>
                `;
                document.body.appendChild(scannerOverlay);
                
                scannerActive = true;
                
                // Start scanning
                const result = await BarcodeScanner.startScan();
                
                if (result.hasContent) {
                    console.log('[POS] Scanned:', result.content);
                    handleScanResult(result.content);
                }
                
                stopCapacitorScanner();
                
            } catch (error) {
                console.error('[POS] Scanner error:', error);
                alert('Failed to start scanner: ' + error.message);
                stopCapacitorScanner();
            }
        }

        function stopCapacitorScanner() {
            if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.BarcodeScanner) {
                const { BarcodeScanner } = Capacitor.Plugins;
                BarcodeScanner.stopScan();
            }
            
            document.body.classList.remove('scanner-active');
            const overlay = document.getElementById('scanner-overlay');
            if (overlay) {
                overlay.remove();
            }
            scannerActive = false;
        }

        function startWebScanner() {
            // Create video element for web camera
            const scannerModal = document.createElement('div');
            scannerModal.id = 'web-scanner-modal';
            scannerModal.innerHTML = `
                <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; padding: 20px; max-width: 90%; width: 400px;">
                        <h3 style="margin: 0 0 16px 0; color: var(--navy-900);">Scan Product</h3>
                        <video id="scanner-video" style="width: 100%; height: 300px; background: #000; border-radius: 8px;"></video>
                        <div style="margin-top: 16px; display: flex; gap: 12px;">
                            <button onclick="stopWebScanner()" style="flex: 1; background: var(--navy-200); color: var(--navy-900); padding: 10px; border: none; border-radius: 6px;">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(scannerModal);
            
            // Start video stream
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            }).then(stream => {
                const video = document.getElementById('scanner-video');
                video.srcObject = stream;
                video.play();
                
                // Try to use BarcodeDetector API if available
                if ('BarcodeDetector' in window) {
                    const barcodeDetector = new BarcodeDetector({
                        formats: ['qr_code', 'code_128', 'code_39', 'ean_13', 'ean_8', 'upc_a', 'upc_e']
                    });
                    
                    scannerActive = true;
                    
                    const detectLoop = async () => {
                        if (scannerActive && video.readyState === video.HAVE_ENOUGH_DATA) {
                            try {
                                const barcodes = await barcodeDetector.detect(video);
                                if (barcodes.length > 0) {
                                    console.log('[POS] Web scanner detected:', barcodes[0].rawValue);
                                    handleScanResult(barcodes[0].rawValue);
                                    stopWebScanner();
                                    return;
                                }
                            } catch (err) {
                                console.error('[POS] Detection error:', err);
                            }
                            
                            if (scannerActive) {
                                requestAnimationFrame(detectLoop);
                            }
                        } else if (scannerActive) {
                            requestAnimationFrame(detectLoop);
                        }
                    };
                    
                    detectLoop();
                } else {
                    alert('Barcode detection is not supported in this browser. Please use the search function or try a different browser.');
                    stopWebScanner();
                }
            }).catch(error => {
                console.error('[POS] Camera error:', error);
                alert('Failed to access camera. Please check permissions.');
                stopWebScanner();
            });
        }

        function stopWebScanner() {
            scannerActive = false;
            
            const video = document.getElementById('scanner-video');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            
            const modal = document.getElementById('web-scanner-modal');
            if (modal) {
                modal.remove();
            }
        }

        function handleScanResult(scannedCode) {
            console.log('[POS] Processing scan result:', scannedCode);
            
            try {
                // Try to parse as JSON (for QR codes with product data)
                if (scannedCode.trim().startsWith('{') || scannedCode.trim().startsWith('[')) {
                    const productData = JSON.parse(scannedCode);
                    console.log('[POS] Parsed QR code data:', productData);
                    
                    // Check if it's a valid product QR code
                    if (productData.type === 'DOTT_PRODUCT' || (productData.id && productData.name && productData.price)) {
                        // Add to cart directly
                        const cartItem = {
                            id: productData.id,
                            name: productData.name,
                            price: parseFloat(productData.price || 0),
                            quantity: 1,
                            sku: productData.sku || '',
                            barcode: productData.barcode || ''
                        };
                        
                        addToCart(cartItem);
                        showToast(`${cartItem.name} added to cart`, 'success');
                        return;
                    }
                }
            } catch (e) {
                // Not JSON, treat as barcode
                console.log('[POS] Treating as barcode:', scannedCode);
            }
            
            // Search for product by barcode or SKU
            const product = productsList.find(p => 
                p.barcode === scannedCode || 
                p.sku === scannedCode ||
                p.id === scannedCode
            );
            
            if (product) {
                console.log('[POS] Found product:', product);
                addToCart(product);
                showToast(`${product.name} added to cart`, 'success');
            } else {
                showToast('Product not found. Please add it to inventory first.', 'error');
            }
        }

        // Handle USB/keyboard barcode scanners
        document.addEventListener('keypress', function(e) {
            // Don't capture if user is typing in an input field
            if (document.activeElement.tagName === 'INPUT' || 
                document.activeElement.tagName === 'TEXTAREA') {
                return;
            }
            
            // Clear existing timeout
            if (scannerTimeout) {
                clearTimeout(scannerTimeout);
            }
            
            // Process Enter key
            if (e.key === 'Enter') {
                if (scannerBuffer.trim()) {
                    console.log('[POS] USB scanner input:', scannerBuffer);
                    handleScanResult(scannerBuffer.trim());
                    scannerBuffer = '';
                }
            } else if (e.key.length === 1) {
                // Add printable characters to buffer
                scannerBuffer += e.key;
            }
            
            // Clear buffer after 100ms of no input
            scannerTimeout = setTimeout(() => {
                scannerBuffer = '';
            }, 100);
        });

        // Add CSS for scanner active state
        const style = document.createElement('style');
        style.textContent = `
            .scanner-active {
                visibility: hidden;
            }
            
            #scanner-overlay, #web-scanner-modal {
                visibility: visible !important;
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- Crisp Chat Widget -->
    <script>
        // Initialize Crisp Chat
        (function() {
            // Crisp configuration
            window.$crisp = [];
            window.CRISP_WEBSITE_ID = "82ce1965-8acf-4c6e-b8c0-a543ead8004e";
            
            // Enable safe mode for Capacitor compatibility
            window.$crisp.push(["safe", true]);
            
            // Configure Crisp to display on the LEFT side
            window.$crisp.push(["config", "position:reverse", [false]]);
            window.$crisp.push(["config", "position:left"]);
            
            // Set custom CSS to ensure bottom-left positioning on mobile
            window.$crisp.push(["on", "chat:loaded", function() {
                // Ensure the chat widget stays in bottom left
                const style = document.createElement('style');
                style.textContent = `
                    /* Crisp Chat Mobile Positioning - LEFT SIDE */
                    .crisp-client .cc-l3zb .cc-10m9 {
                        bottom: 20px !important;
                        left: 20px !important;
                        right: auto !important;
                    }
                    
                    /* Ensure proper z-index */
                    .crisp-client {
                        z-index: 9999 !important;
                    }
                    
                    /* Adjust for mobile safe areas */
                    @supports (padding-bottom: env(safe-area-inset-bottom)) {
                        .crisp-client .cc-l3zb .cc-10m9 {
                            bottom: calc(20px + env(safe-area-inset-bottom)) !important;
                            left: calc(20px + env(safe-area-inset-left)) !important;
                        }
                    }
                    
                    /* Make sure chat bubble is visible */
                    .crisp-client .cc-l3zb {
                        display: block !important;
                    }
                    
                    /* Ensure chat window opens from left side */
                    .crisp-client .cc-kv6t {
                        left: 20px !important;
                        right: auto !important;
                    }
                `;
                document.head.appendChild(style);
                
                console.log('[Crisp] Chat widget loaded and positioned');
            }]);
            
            // Load Crisp script
            const d = document;
            const s = d.createElement("script");
            s.src = "https://client.crisp.chat/l.js";
            s.async = 1;
            d.getElementsByTagName("head")[0].appendChild(s);
            
            console.log('[Crisp] Chat widget initialized');
        })();
    </script>
</body>
</html>