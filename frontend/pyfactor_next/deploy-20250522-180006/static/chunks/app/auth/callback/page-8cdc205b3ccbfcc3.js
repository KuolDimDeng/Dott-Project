(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[86769],{16527:(e,t,o)=>{"use strict";o.r(t),o.d(t,{default:()=>b});var n=o(95155),s=o(12115),r=o(35695),i=o(55158),a=o(11024),c=o(42749),u=o(27494);let l=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;try{if(!e||!e.idToken||!e.accessToken)return c.vF.error("[cookieManager] Missing required tokens for auth setup"),!1;let n=e.idToken.toString();e.accessToken.toString();let s=(0,u.$n)(n),r=(null==s?void 0:s.exp)||0,i=Math.floor(Date.now()/1e3);c.vF.debug("[cookieManager] Setting auth data in Cognito",{tokenLifetime:"".concat(((r-i)/60).toFixed(1)," minutes"),hasAttributes:!!t});let a=new Date(1e3*r).toISOString();try{let{updateUserAttributes:e}=await Promise.resolve().then(o.bind(o,55158));await e({userAttributes:{"custom:token_expires":a}}),c.vF.debug("[cookieManager] Token expiration stored in Cognito")}catch(e){c.vF.warn("[cookieManager] Could not store token expiration in Cognito",{error:e.message})}return t&&await d(t),!0}catch(e){return c.vF.error("[cookieManager] Error setting auth data:",{error:e.message,stack:e.stack}),!1}},d=async e=>{try{if(!e)return c.vF.warn("[cookieManager] No attributes provided for onboarding data"),!1;c.vF.debug("[cookieManager] Setting onboarding data in Cognito");let t=e["custom:onboarding"]||e.onboarding||"PENDING",n="TRUE"===e["custom:business_info_done"]||"true"===e.businessInfoDone||!0===e.businessInfoDone,s="TRUE"===e["custom:subscription_done"]||"true"===e.subscriptionDone||!0===e.subscriptionDone,r="TRUE"===e["custom:payment_done"]||"true"===e.paymentDone||!0===e.paymentDone,i="true"===(e["custom:setupdone"]||"").toLowerCase()||"complete"===(e["custom:onboarding"]||"").toLowerCase(),{updateUserAttributes:a}=await Promise.resolve().then(o.bind(o,55158));await a({userAttributes:{"custom:onboarding":t,"custom:business_info_done":n?"TRUE":"FALSE","custom:subscription_done":s?"TRUE":"FALSE","custom:payment_done":r?"TRUE":"FALSE","custom:setupdone":i?"true":"false"}});let u=e["custom:tenant_ID"]||e.tenantId;return u&&await a({userAttributes:{"custom:tenant_ID":u,"custom:tenant_ID":u,"custom:businessid":u}}),!0}catch(e){return c.vF.error("[cookieManager] Error setting onboarding attributes:",{error:e.message,stack:e.stack}),!1}},h=e=>{if(!e)return"business-info";let t="TRUE"===e["custom:business_info_done"]||"true"===e.businessInfoDone||!0===e.businessInfoDone,o="TRUE"===e["custom:subscription_done"]||"true"===e.subscriptionDone||!0===e.subscriptionDone,n="TRUE"===e["custom:payment_done"]||"true"===e.paymentDone||!0===e.paymentDone,s="true"===(e["custom:setupdone"]||"").toLowerCase()||"complete"===(e["custom:onboarding"]||"").toLowerCase();return t?o?n?s?"complete":"setup":"payment":"subscription":"business-info"};function b(){let e=(0,r.useRouter)(),t=(0,r.useSearchParams)(),[o,u]=(0,s.useState)(null),[d,b]=(0,s.useState)("Processing authentication..."),[g,m]=(0,s.useState)(10);return((0,s.useEffect)(()=>{(async()=>{try{let e;c.vF.debug("[OAuth Callback] Auth callback page loaded, handling response"),b("Completing authentication..."),m(25);try{let t=await (0,i.handleAuthResponse)();e=null==t?void 0:t.tokens,c.vF.debug("[OAuth Callback] Auth response handled:",{hasTokens:!!e,isSignedIn:null==t?void 0:t.isSignedIn})}catch(e){c.vF.error("[OAuth Callback] Error handling auth response:",e),u("Authentication failed: "+(e.message||"Unknown error"));return}if(!e)throw Error("No tokens received from OAuth callback");c.vF.debug("[OAuth Callback] OAuth callback successful"),b("Checking account status..."),m(50);try{let t=await (0,a.T)();c.vF.debug("[OAuth Callback] User attributes:",{onboardingStatus:t["custom:onboarding"],businessId:t["custom:business_id"],subscription:t["custom:subscription_plan"]}),l(e,t);let o=h(t),n="/dashboard";m(75),"business-info"===o?n="/onboarding/business-info":"subscription"===o?n="/onboarding/subscription":"payment"===o?n="/onboarding/payment":"setup"===o?n="/onboarding/setup":"complete"!==o&&(n="/onboarding/business-info"),n+=(n.includes("?")?"&":"?")+"from=oauth",c.vF.debug("[OAuth Callback] Redirecting to:",n),b("Redirecting to ".concat(n,"...")),m(90),setTimeout(()=>{window.location.href=n},800)}catch(e){c.vF.error("[OAuth Callback] Error fetching user attributes:",e),u("Unable to determine account status. Redirecting to start of onboarding."),setTimeout(()=>{window.location.href="/onboarding/business-info?from=oauth&error=attributes"},2e3)}}catch(t){c.vF.error("[OAuth Callback] OAuth process failed:",t),u(t.message||"Authentication failed"),b("Authentication error. Redirecting to sign in..."),setTimeout(()=>{e.push("/auth/signin?error=oauth")},3e3)}})()},[e,t]),o)?(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-screen p-6 space-y-4",children:[(0,n.jsx)("div",{className:"bg-red-50 border-l-4 border-red-500 p-4 w-full max-w-md",children:(0,n.jsxs)("div",{className:"flex",children:[(0,n.jsx)("div",{className:"flex-shrink-0",children:(0,n.jsx)("svg",{className:"h-5 w-5 text-red-500",fill:"currentColor",viewBox:"0 0 20 20",children:(0,n.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),(0,n.jsx)("div",{className:"ml-3",children:(0,n.jsx)("p",{className:"text-sm text-red-700",children:o})})]})}),(0,n.jsx)("p",{className:"text-sm text-gray-600",children:d})]}):(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-screen space-y-6",children:[(0,n.jsxs)("div",{className:"relative h-16 w-16",children:[(0,n.jsxs)("svg",{className:"w-full h-full",viewBox:"0 0 100 100",children:[(0,n.jsx)("circle",{className:"text-gray-200",strokeWidth:"8",stroke:"currentColor",fill:"transparent",r:"46",cx:"50",cy:"50"}),(0,n.jsx)("circle",{className:"text-blue-600",strokeWidth:"8",strokeDasharray:289,strokeDashoffset:289-289*g/100,strokeLinecap:"round",stroke:"currentColor",fill:"transparent",r:"46",cx:"50",cy:"50"})]}),(0,n.jsx)("div",{className:"absolute top-0 left-0 flex items-center justify-center w-full h-full",children:(0,n.jsxs)("span",{className:"text-sm font-medium text-blue-700",children:[g,"%"]})})]}),(0,n.jsx)("p",{className:"text-gray-600",children:d})]})}},27494:(e,t,o)=>{"use strict";o.d(t,{$n:()=>r,KZ:()=>s,tg:()=>a});var n=o(42749);let s=()=>"req_"+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),r=e=>{try{let t=e.split(".")[1];if(!t)throw Error("Invalid token format");let o=t.replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(atob(o).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(n)}catch(e){return n.vF.error("[authUtils] Failed to parse JWT:",e),{}}},i=["/","/index","/home","/auth/signin","/auth/signup","/auth/forgot-password","/auth/reset-password","/auth/verify","/auth/verify-email","/about","/privacy","/terms","/auth/reset","/auth/reset/confirm","/auth/callback","/api/health","/api/public","/api/login","/api/signup","/login","/signup","/reset-password","/onboarding/business-info","/onboarding/subscription","/onboarding/payment","/onboarding/setup"],a=e=>{if("/"===e||""===e||"/index.html"===e)return n.vF.debug("[authUtils] Route ".concat(e," is public (root path)")),!0;if(e.startsWith("/onboarding/"))return n.vF.debug("[authUtils] Route ".concat(e," is treated as public for redirection purposes")),!0;let t=e.endsWith("/")?e.slice(0,-1):e;if(n.vF.debug("[authUtils] Checking if route is public: ".concat(e," (normalized: ").concat(t,")")),i.includes(t))return n.vF.debug("[authUtils] Route ".concat(e," is public (exact match)")),!0;let o=i.some(e=>t===e||t.startsWith(e+"/")&&"/"!==e);return n.vF.debug("[authUtils] Route ".concat(e," is ").concat(o?"public":"private"," (prefix match)")),o}},29402:(e,t,o)=>{Promise.resolve().then(o.bind(o,16527))},42749:(e,t,o)=>{"use strict";o.d(t,{vF:()=>i});let n={debug:0,info:1,warn:2,error:3},s="info",r=()=>!1,i={setLevel(e){void 0!==n[e]&&(s=e)},getLevel:()=>s,debug:(e,t)=>{},info:(e,t)=>{n[s]<=n.info&&(r()?void 0!==t?console.info("[SERVER INFO] ".concat(e),t):console.info("[SERVER INFO] ".concat(e)):void 0!==t?console.info(e,t):console.info(e))},warn:(e,t)=>{n[s]<=n.warn&&(r()?void 0!==t?console.warn("[SERVER WARN] ".concat(e),t):console.warn("[SERVER WARN] ".concat(e)):void 0!==t?console.warn(e,t):console.warn(e))},error:(e,t)=>{n[s]<=n.error&&(r()?void 0!==t?console.error("[SERVER ERROR] ".concat(e),t):console.error("[SERVER ERROR] ".concat(e)):void 0!==t?console.error(e,t):console.error(e))}}}},e=>{var t=t=>e(e.s=t);e.O(0,[54940,9296,79480,58430,84620,23639,38501,31861,36384,28441,31684,77358],()=>t(29402)),_N_E=e.O()}]);