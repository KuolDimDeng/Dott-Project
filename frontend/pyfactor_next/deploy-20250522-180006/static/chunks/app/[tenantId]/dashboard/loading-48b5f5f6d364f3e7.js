(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[16122],{15852:(e,r,o)=>{"use strict";o.r(r),o.d(r,{default:()=>a});var t=o(95155),n=o(47611);function a(){return(0,t.jsx)(n.A,{message:"Loading your dashboard..."})}},35695:(e,r,o)=>{"use strict";var t=o(18999);o.o(t,"useParams")&&o.d(r,{useParams:function(){return t.useParams}}),o.o(t,"usePathname")&&o.d(r,{usePathname:function(){return t.usePathname}}),o.o(t,"useRouter")&&o.d(r,{useRouter:function(){return t.useRouter}}),o.o(t,"useSearchParams")&&o.d(r,{useSearchParams:function(){return t.useSearchParams}})},47611:(e,r,o)=>{"use strict";o.d(r,{A:()=>s});var t=o(95155),n=o(12115),a=o(35695);function s(e){let{message:r="Loading your dashboard..."}=e,s=(0,a.useRouter)(),c=(0,a.usePathname)(),i=(0,a.useSearchParams)(),[d,l]=(0,n.useState)(0),[u,h]=(0,n.useState)(r),[w,g]=(0,n.useState)(null),m=(0,n.useRef)({refreshInProgress:!1,lastRefreshTime:0,recoveryInProgress:!1,lastRecoveryTime:0,redirectInProgress:!1}),P=(0,n.useCallback)(()=>{let e=Date.now()-m.current.lastRefreshTime;return e<15e3&&(console.log("[DashboardLoader] Auth refresh on cooldown (".concat(Math.round(e/1e3),"s elapsed of ").concat(15,"s cooldown)")),!0)},[]),_=(0,n.useCallback)(()=>{let e=Date.now()-m.current.lastRecoveryTime;return e<1e4&&(console.log("[DashboardLoader] Recovery on cooldown (".concat(Math.round(e/1e3),"s elapsed of ").concat(10,"s cooldown)")),!0)},[]),f=(0,n.useCallback)(()=>{var e,r;if(_()||m.current.recoveryInProgress)return void console.log("[DashboardLoader] Recovery already in progress or on cooldown, skipping");m.current.recoveryInProgress=!0,m.current.lastRecoveryTime=Date.now(),console.log("[DashboardLoader] Attempting to recover from network error"),((null==w?void 0:w.type)==="ChunkLoadError"||(null==w||null==(e=w.message)?void 0:e.includes("Loading chunk"))||(null==w||null==(r=w.message)?void 0:r.includes("Failed to fetch")))&&(console.log("[DashboardLoader] Clearing cache for chunk/network error"),"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(e=>{e.forEach(e=>e.unregister())}).catch(e=>{console.error("[DashboardLoader] Error unregistering service workers:",e)}),"caches"in window&&caches.keys().then(e=>{e.forEach(e=>caches.delete(e))}).catch(e=>{console.error("[DashboardLoader] Error clearing cache:",e)})),setTimeout(()=>{let e=new URL(window.location);e.searchParams.set("cb",Date.now()),e.searchParams.set("recovery","true"),window.location.href=e.toString(),setTimeout(()=>{m.current.recoveryInProgress=!1},5e3)},1500)},[w,_]),C=async()=>{if(P()||m.current.refreshInProgress)return console.log("[DashboardLoader] Auth refresh already in progress or on cooldown, skipping"),!1;m.current.refreshInProgress=!0,m.current.lastRefreshTime=Date.now();try{var e,r;console.log("[DashboardLoader] Refreshing auth session");let{fetchAuthSession:t}=await Promise.all([o.e(54940),o.e(9296),o.e(79480),o.e(58430),o.e(84620),o.e(23639),o.e(38501),o.e(31861),o.e(28786)]).then(o.bind(o,55158)),n=await t({forceRefresh:!0});return(null==(e=n.tokens)?void 0:e.accessToken)&&(window.__APP_CACHE=window.__APP_CACHE||{},window.__APP_CACHE.auth=window.__APP_CACHE.auth||{},window.__APP_CACHE.auth.accessToken=n.tokens.accessToken.toString(),window.__APP_CACHE.auth.idToken=n.tokens.idToken.toString(),window.__APP_CACHE.auth.refreshed=Date.now()),!!(null==(r=n.tokens)?void 0:r.accessToken)}catch(e){return console.error("[DashboardLoader] Error refreshing auth session:",e),!1}finally{m.current.refreshInProgress=!1}},A=async e=>{try{console.log("[DashboardLoader] Setting tenant ID in Cognito via API: ".concat(e));let r=0;window.__APP_CACHE=window.__APP_CACHE||{},window.__APP_CACHE.tenant=window.__APP_CACHE.tenant||{},window.__APP_CACHE.tenant.id=e;let o=async()=>{try{let r=await fetch("/api/tenant/attribute",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:e}),timeout:1e4});return r.ok||console.error("[DashboardLoader] Error setting tenant ID in Cognito via API"),r}catch(e){if(r<3)return r++,console.log("[DashboardLoader] Retrying tenant ID set (".concat(r,"/").concat(3,")")),await new Promise(e=>setTimeout(e,1e3*r)),o();throw e}};await o()}catch(e){console.error("[DashboardLoader] Failed to set tenant ID in Cognito:",e)}};return(0,n.useEffect)(()=>{let e=new URLSearchParams(window.location.search);if(e.get("recovery")){console.log("[DashboardLoader] This is a recovery attempt, ensuring clean state"),window.__APP_CACHE=window.__APP_CACHE||{},window.__APP_CACHE.operations={};let r=e.get("attempt");if(r){let e=parseInt(r,10);if(window.__APP_CACHE.recoveryAttempts=e,e>3){console.log("[DashboardLoader] Multiple recovery attempts detected, trying more aggressive cleanup");try{window.indexedDB&&["amplify-datastore-storage","aws.amplify.storage"].forEach(e=>{try{window.indexedDB.deleteDatabase(e),console.log("[DashboardLoader] Deleted database: "+e)}catch(e){}})}catch(e){}}}}else window.__APP_CACHE&&(window.__APP_CACHE.recoveryAttempts=0);let r=e=>{if(m.current.recoveryInProgress)return;let r=e.message||e.error&&e.error.message||"";r&&(r.includes("ChunkLoadError")||r.includes("Loading chunk")||r.includes("Failed to fetch")||r.includes("NetworkError")||r.includes("Network Error"))&&(console.error("[DashboardLoader] Detected loading error:",r),g({type:r.includes("ChunkLoadError")?"ChunkLoadError":"NetworkError",message:r,timestamp:Date.now()}),h("Error loading dashboard components. Attempting recovery..."),window.__APP_CACHE=window.__APP_CACHE||{},window.__APP_CACHE.lastError={type:r.includes("ChunkLoadError")?"ChunkLoadError":"NetworkError",message:r,timestamp:Date.now()},(r.includes("ChunkLoadError")||r.includes("NetworkError")||r.includes("Network Error"))&&!_()&&f())};return window.addEventListener("error",r),window.addEventListener("unhandledrejection",e=>{e.reason&&e.reason.message&&r({message:e.reason.message})}),()=>{window.removeEventListener("error",r),window.removeEventListener("unhandledrejection",r)}},[f,_,i]),(0,n.useEffect)(()=>{if(m.current.redirectInProgress)return;let e=e=>{let r=document.querySelector('meta[http-equiv="'.concat(e,'"]'));return r?r.content:null},r="true"===e("x-should-redirect"),o=e("x-redirect-path"),t="true"===e("x-dashboard-error"),n=e("x-tenant-id"),a="true"===e("x-auth-refresh-needed"),i=c.includes("fromAuth=true")||c.includes("direct=true")||c.includes("retry="),u=c.match(/^\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})\//i),h=u?u[1]:null;if(console.log("[DashboardLoader] Redirect info:",{shouldRedirect:r,redirectPath:o,dashboardError:t,tenantIdMeta:n,pathTenantId:h,hasAuthParam:i,attempts:d,currentPath:c,errorDetails:w}),w){let e=setTimeout(()=>{_()||f()},2e3);return()=>clearTimeout(e)}if(!a||m.current.refreshInProgress||P()||C().catch(e=>{console.error("[DashboardLoader] Auth refresh error:",e)}),r&&o&&d<5){m.current.redirectInProgress=!0,l(e=>e+1);let e=Math.min(500*d,2e3);console.log("[DashboardLoader] Redirecting to ".concat(o," in ").concat(e,"ms (attempt ").concat(d+1,")")),setTimeout(()=>{try{s.push(o),setTimeout(()=>{m.current.redirectInProgress=!1},5e3)}catch(e){console.error("[DashboardLoader] Redirect error:",e),m.current.redirectInProgress=!1}},e);return}n&&(window.__APP_CACHE=window.__APP_CACHE||{},window.__APP_CACHE.tenant=window.__APP_CACHE.tenant||{},window.__APP_CACHE.tenant.id=n,h||A(n).catch(e=>{console.error("[DashboardLoader] Error setting tenant attribute:",e)}))},[c,d,s,w,f,P,_,A]),(0,t.jsx)("div",{className:"fixed inset-0 flex items-center justify-center z-50 bg-gray-100 bg-opacity-70 backdrop-blur-sm",children:(0,t.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-lg w-full max-w-md mx-4 text-center",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mx-auto mb-4"}),(0,t.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:u}),w&&(0,t.jsx)("div",{className:"mt-3 bg-red-50 p-3 rounded-md",children:(0,t.jsx)("p",{className:"text-red-700 text-sm",children:"Error loading dashboard components. Attempting to recover..."})})]})})}},86371:(e,r,o)=>{Promise.resolve().then(o.bind(o,15852))}},e=>{var r=r=>e(e.s=r);e.O(0,[28441,31684,77358],()=>r(86371)),_N_E=e.O()}]);