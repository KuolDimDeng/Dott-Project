"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[64070],{64070:(e,t,n)=>{n.d(t,{OJ:()=>H,As:()=>U});var r=n(55166),i=n(68387),o=n(95155),u=n(12115),a=n(35695),s=n(42749),l=n(27494);window.__APP_CACHE=window.__APP_CACHE||{},window.__APP_CACHE.preferences=window.__APP_CACHE.preferences||{};var c=n(62376),d=n(60584),h=n(12499);let f=e=>e<1024?e+" bytes":e<1048576?(e/1024).toFixed(2)+" KB":(e/1048576).toFixed(2)+" MB",g=()=>{if(window.performance&&window.performance.memory){let e=window.performance.memory;return{totalJSHeapSize:f(e.totalJSHeapSize),usedJSHeapSize:f(e.usedJSHeapSize),jsHeapSizeLimit:f(e.jsHeapSizeLimit),percentUsed:(e.usedJSHeapSize/e.jsHeapSizeLimit*100).toFixed(2)+"%"}}return null},w=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"update",n=g();n&&console.log("[Memory] ".concat(e," ").concat(t,":"),n)},A=[],p=["before-sessionCheck","before-fetchAuthSession","after-fetchAuthSession","before-getCurrentUser","after-getCurrentUser","before-fetchUserAttributes","after-fetchUserAttributes","after-sessionCheck","context-value-creation"],m=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"update";if(p.includes(t))return;let n=g();if(n){let r={timestamp:new Date().toISOString(),component:e,action:t,usedJSHeapSize:n.usedJSHeapSize,percentUsed:n.percentUsed};("state-change"===t||"interval"===t||"mount"===t||"unmount"===t||parseFloat(n.percentUsed)>70)&&(A.push(r),A.length>50&&(A=A.slice(-50))),parseFloat(n.percentUsed)>80&&console.warn("[Memory Warning] High memory usage in ".concat(e," (").concat(t,"):"),n)}},v=()=>{A=[]},b=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;if(A.length<2)return null;let t=A[A.length-1],n=A[A.length-2];if(!t||!n)return null;let r=parseFloat(t.usedJSHeapSize),i=parseFloat(n.usedJSHeapSize);if(isNaN(r)||isNaN(i))return null;let o=(r-i)/i*100;return o>e?{from:n,to:t,percentIncrease:o.toFixed(2)+"%",absoluteIncrease:f(r-i)}:null};var _=n(51174),P=n(47856);let C={isLoading:!0,hasSession:!1,hasError:!1,user:null,session:null,employee:null},S=(0,h.FF)(C),k=(e,t,n,r,i,o)=>({isLoading:e,hasSession:t,hasError:n,user:r,session:i,employee:o}),y=(e,t)=>e?{username:e.username,userId:e.userId,attributes:{email:t.email,"custom:onboarding":t["custom:onboarding"],"custom:userrole":t["custom:userrole"]}}:null,F=e=>e?{idToken:e.idToken?{jwtToken:e.idToken.toString()}:null}:null,E=e=>e&&(e.startsWith("/dashboard")||e.includes("/tenant/")&&e.includes("/dashboard"));function H(e){let{children:t}=e,[n,h]=(0,u.useState)(C),f=(0,a.useRouter)(),g=(0,u.useRef)(!1),A=(0,u.useRef)(null),p=(0,u.useRef)(0);(0,u.useEffect)(()=>{w("AuthProvider","mount");let e=setInterval(()=>{m("AuthProvider","interval");let e=b(20);if(e&&(console.warn("[Memory Spike in AuthProvider]",e),window.gc))try{window.gc(),console.log("[Memory] Forced garbage collection")}catch(e){}},3e4);return()=>{clearInterval(e),w("AuthProvider","unmount"),v()}},[]);let H=(0,u.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(!g.current){m("AuthProvider","before-sessionCheck"),g.current=!0,p.current=e;try{let n;s.vF.debug("[Auth] Session check #".concat(e));let r=window.location.pathname,i=E(r);if((0,l.tg)(r)){s.vF.debug("[Auth] Skipping auth check for public route: ".concat(r)),h(k(!1,!1,!1,null,null,null)),g.current=!1;return}try{if(m("AuthProvider","before-fetchAuthSession"),(null==(n=(await (0,d.fetchAuthSession)()).tokens)?void 0:n.accessToken)&&(null==n?void 0:n.idToken)){(0,_.h_)(n),s.vF.debug("[Auth] Tokens stored in tenantUtils");try{await (0,P.Yc)(),s.vF.info("[Auth] Tenant context initialized after authentication")}catch(e){s.vF.error("[Auth] Error initializing tenant context:",e)}}if(m("AuthProvider","after-fetchAuthSession"),!(null==n?void 0:n.idToken)){h(k(!1,!1,!1,null,null,null)),g.current=!1,(0,l.tg)(r)?s.vF.debug("[Auth] No valid session found but on public route, continuing: ".concat(r)):(s.vF.debug("[Auth] No valid session found, redirecting to sign-in from: ".concat(r)),f.push("/auth/signin"));return}}catch(e){if(h(k(!1,!1,!1,null,null,null)),g.current=!1,(0,l.tg)(r))s.vF.debug("[Auth] Session error but on public route, continuing: ".concat(r));else{var t;s.vF.debug("[Auth] Session error, redirecting to sign-in from: ".concat(r));let n=(null==(t=e.message)?void 0:t.includes("expired"))||"NotAuthorizedException"===e.code;f.push(n?"/auth/signin?session=expired":"/auth/signin")}return}await new Promise(e=>setTimeout(e,500));try{m("AuthProvider","before-getCurrentUser");let e=await (0,d.getCurrentUser)();if(m("AuthProvider","after-getCurrentUser"),!e){h(k(!1,!1,!1,null,null,null)),g.current=!1;return}try{m("AuthProvider","before-fetchUserAttributes");let t=await (0,d.fetchUserAttributes)(),n=t["custom:onboarding"];m("AuthProvider","after-fetchUserAttributes");let{tokens:o}=await (0,d.fetchAuthSession)(),u=y(e,t),a=F(o);h(k(!1,!0,!1,u,{tokens:a},null));try{sessionStorage.setItem("had_auth_session","true")}catch(e){}i||"not_started"!==n||r.includes("/onboarding/business-info")||f.push(function(e){let t=function(){let e;try{(e=new URLSearchParams(window.location.search).get("lng"))?e&&1?(window.__APP_CACHE=window.__APP_CACHE||{},window.__APP_CACHE.preferences=window.__APP_CACHE.preferences||{},window.__APP_CACHE.preferences.language=e):e="en":(window.__APP_CACHE=window.__APP_CACHE||{},window.__APP_CACHE.preferences=window.__APP_CACHE.preferences||{},e=window.__APP_CACHE.preferences.language||"en")}catch(t){e="en",s.vF.error("[LanguageUtils] Error getting language parameter:",t)}return e}();return"".concat(e,"?lng=").concat(t)}("/onboarding/business-info"))}catch(t){if(i){h(k(!1,!1,!1,null,null,null)),g.current=!1;return}s.vF.warn("[Auth] Could not get Cognito attributes but not in dashboard; continuing"),h(k(!1,!0,!1,{username:e.username,userId:e.userId},{tokens:F(n)},null))}}catch(e){h(k(!1,!1,!1,null,null,null)),g.current=!1;return}}catch(n){if(e<3){let t=1e3*Math.pow(2,e);return await new Promise(e=>setTimeout(e,t)),g.current=!1,H(e+1)}h(k(!1,!1,!0,null,null,null));try{await (0,d.signOut)()}catch(e){s.vF.error("[Auth] Sign out error: ".concat(e.message))}let t=window.location.pathname;(0,l.tg)(t)||"/"===t||f.push("/auth/signin")}finally{g.current=!1,m("AuthProvider","after-sessionCheck")}}},[f]),U=(0,u.useCallback)(async e=>{let{payload:t}=e,n=t.event;switch(m("AuthProvider","auth-event-".concat(n)),n){case"signedIn":A.current&&clearTimeout(A.current),A.current=setTimeout(()=>H(),1e3);break;case"signedOut":h(k(!1,!1,!1,null,null,null));break;case"tokenRefresh":g.current||await H();break;case"tokenRefresh_failure":h(k(!1,!1,!0,null,null,null));try{await (0,d.signOut)();let e=window.location.pathname;if("/auth/verify-email"===e||e.startsWith("/auth/verify-email")){s.vF.debug("[Auth] Staying on verify-email page despite token refresh failure");break}if("/auth/signin"===e||e.startsWith("/auth/signin")){s.vF.debug("[Auth] Already on sign-in page, not redirecting");break}(0,l.tg)(e)||"/"===e||(s.vF.debug("[Auth] Redirecting to sign-in page after token refresh failure"),window.location.href="/auth/signin")}catch(e){s.vF.error("[Auth] Sign out error after token refresh failure:",e),(0,l.tg)(window.location.pathname)||"/"===window.location.pathname||(window.location.href="/auth/signin")}break;case"configured":await H();break;case"configurationError":h(k(!1,!1,!0,null,null,null))}m("AuthProvider","auth-event-".concat(n,"-end"))},[H,f]);(0,u.useEffect)(()=>{let e=d.Hub.listen("auth",U);return H(),()=>{e(),A.current&&clearTimeout(A.current)}},[U,H]);let z=(0,u.useRef)(Date.now());(0,u.useEffect)(()=>{let e=Date.now();e-z.current>1e3&&(m("AuthProvider","state-change"),z.current=e)},[n]);let x=(0,u.useMemo)(()=>(m("AuthProvider","context-value-creation"),n),[n]),T=(0,u.useCallback)(async()=>{if(!n.hasSession||!n.user)return null;try{s.vF.debug("[Auth] Fetching employee data");let e=await c.Rz.getCurrent();return h(t=>(0,i._)((0,r._)({},t),{employee:e})),s.vF.debug("[Auth] Employee data loaded"),e}catch(e){return e.response&&404!==e.response.status&&s.vF.error("[Auth] Error loading employee data:",e),null}},[n.hasSession,n.user]);return(0,u.useEffect)(()=>{n.hasSession&&n.user&&!n.employee&&T()},[n.hasSession,n.user,n.employee,T]),(0,o.jsx)(S.Provider,{value:x,children:t})}let U=function(){m("useAuthContext","call");let e=(0,h.yy)(S);if(!e)throw Error("useAuthContext must be used within an AuthProvider");return e}}}]);