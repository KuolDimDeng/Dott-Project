"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[24139],{24139:(e,t,n)=>{n.d(t,{oA:()=>p,sb:()=>c});var a=n(55166),r=n(68387),o=n(95155),i=n(12115),l=n(42749),s=n(11024),u=n(24818);let m=(0,i.createContext)(),c=()=>{let e=(0,i.useContext)(m);return e||(console.warn("useUserProfile is being used outside of UserProfileProvider. Using fallback implementation."),{profileData:null,loading:!1,error:null,timestamp:null,fetchProfile:()=>Promise.resolve(null),clearProfileCache:()=>{},isCacheValid:()=>!1})},d=(e,t)=>{let n;return function(){for(var a=arguments.length,r=Array(a),o=0;o<a;o++)r[o]=arguments[o];clearTimeout(n),n=setTimeout(()=>e(...r),t)}},f=()=>{let e=window.location.pathname,t=e.includes("/auth/signup")||e.includes("/auth/verify-email")||e.includes("/auth/create-password"),n=window.location.search.includes("signup=true")||window.location.search.includes("fromSignIn=true")||"true"===sessionStorage.getItem("signupInProgress");return t||n},g=e=>{if(!e)return null;l.vF.debug("[UserProfileContext] Raw Cognito attributes:",e);let t=t=>{if(e[t])return e[t];let n=t.toLowerCase(),a=Object.keys(e).find(e=>e.toLowerCase()===n);if(a)return e[a];if(!t.startsWith("custom:")){let n="custom:".concat(t);if(e[n])return e[n];let a=Object.keys(e).find(e=>e.toLowerCase()===n.toLowerCase());if(a)return e[a]}if(t.startsWith("custom:")){let n=t.substring(7);if(e[n])return e[n];let a=Object.keys(e).find(e=>e.toLowerCase()===n.toLowerCase());if(a)return e[a]}return null},n=t("custom:firstname")||t("given_name")||t("firstName")||t("first_name")||(e.name?e.name.split(" ")[0]:null),a=t("custom:lastname")||t("family_name")||t("lastName")||t("last_name")||(e.name&&e.name.includes(" ")?e.name.split(" ").slice(1).join(" "):null),r=t("custom:tenant_ID")||t("custom:businessid"),o=t("custom:businessname")||t("custom:tenant_name")||t("business_name")||t("businessName"),i=t("custom:businesstype"),s=t("custom:userrole"),u=t("custom:onboarding"),m=t("custom:setupdone"),c=t("custom:subplan");return l.vF.debug("[UserProfileContext] Case-insensitive attribute lookup:",{firstname:n,lastname:a,tenantId:r,businessName:o,role:s,allAttributes:Object.keys(e),customAttributes:Object.keys(e).filter(e=>e.startsWith("custom:"))}),{profile:{id:e.sub,email:e.email,name:"".concat(n||""," ").concat(a||"").trim(),firstName:n||"",lastName:a||"",first_name:n||"",last_name:a||"",fullName:"".concat(n||""," ").concat(a||"").trim(),tenantId:r||"",role:s||"client",onboardingStatus:u||"complete",setupComplete:"true"===m,businessName:o||"",businessType:i||"",subscriptionType:c||"free",subscription_type:c||"free",cognitoAttributes:e}}};function p(e){let{children:t}=e,[n,c]=(0,i.useState)({data:null,timestamp:null,tenantId:null,loading:!1,error:null}),[p,h]=(0,i.useState)({}),b=(0,i.useCallback)(()=>{c({data:null,timestamp:null,tenantId:null,loading:!1,error:null})},[]),w=(0,i.useCallback)(async()=>{try{l.vF.debug("[UserProfileContext] Fetching Cognito attributes directly"),c(e=>(0,r._)((0,a._)({},e),{loading:!0,error:null}));let e=f();try{let e=await (0,s.T)();if(l.vF.debug("[UserProfileContext] Cognito attributes:",e),!e)throw Error("No Cognito attributes available");let t=g(e);if(t){l.vF.info("[UserProfileContext] Profile populated from Cognito attributes");let n=e["custom:tenant_ID"]||e["custom:businessid"]||null;return c({data:t,timestamp:Date.now(),tenantId:n,loading:!1,error:null}),t}throw Error("Could not create profile from Cognito attributes")}catch(n){let t="UserUnAuthenticatedException"===n.name||"NotAuthorizedException"===n.name||"TokenExpiredException"===n.name;if(e||t){let t=window.location.pathname.includes("/auth/")||window.location.pathname.includes("/dashboard")||window.location.search.includes("fromSignIn=true");l.vF[t?"info":"warn"]("[UserProfileContext] Auth error during expected flow:",{name:n.name,message:n.message.substring(0,50),inSignUpFlow:e,path:window.location.pathname});let a={profile:{id:null,email:localStorage.getItem("emailForSignIn")||localStorage.getItem("email")||"",name:"",firstName:"",lastName:"",tenantId:localStorage.getItem("tenantId")||"",role:"client",businessName:localStorage.getItem("businessName")||"",isMinimalProfile:!0,authErrorType:n.name,preferences:{theme:"light",notificationsEnabled:!0}}};return c({data:a,timestamp:Date.now(),tenantId:localStorage.getItem("tenantId")||null,loading:!1,error:null}),a}throw n}}catch(t){if(f()||window.location.pathname.includes("/auth/"))return l.vF.info("[UserProfileContext] Error suppressed during expected flow:",{name:t.name,path:window.location.pathname}),c(e=>(0,r._)((0,a._)({},e),{loading:!1,error:null})),null;let e={name:t.name,message:t.message.substring(0,100)};return l.vF.error("[UserProfileContext] Error fetching Cognito attributes:",e),c(e=>(0,r._)((0,a._)({},e),{loading:!1,error:t.message})),null}},[]),C=(0,i.useCallback)(async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o="profile_".concat(e||"default","_").concat(Date.now()),i=f();if(i){l.vF.info("[UserProfileContext] Using minimal profile during sign-up flow");let t={profile:{id:null,email:localStorage.getItem("emailForSignIn")||"",name:"",firstName:"",lastName:"",tenantId:e||localStorage.getItem("tenantId")||"",role:"client",businessName:localStorage.getItem("businessName")||"",isSigningUp:!0,preferences:{theme:"light",notificationsEnabled:!0}}};return c({data:t,timestamp:Date.now(),tenantId:e||localStorage.getItem("tenantId")||null,loading:!1,error:null}),t}if(!t&&n.data&&n.tenantId===e&&n.timestamp&&Date.now()-n.timestamp<3e5)return l.vF.debug("[UserProfileContext] Using cached profile data for tenant:",e),n.data;if(p[e||"default"])return l.vF.debug("[UserProfileContext] Request already pending for tenant:",e),null;h(t=>(0,r._)((0,a._)({},t),{[e||"default"]:o})),c(e=>(0,r._)((0,a._)({},e),{loading:!0,error:null}));try{let t=e?"/api/user/profile?tenantId=".concat(encodeURIComponent(e)):"/api/user/profile";l.vF.debug("[UserProfileContext] Fetching profile data from:",t);let n=null;try{var s;let{tokens:e}=await (0,u.$)();n=null==e||null==(s=e.idToken)?void 0:s.toString()}catch(e){window.location.pathname.includes("/auth/")||window.location.pathname.includes("/dashboard")||window.location.search.includes("fromSignIn=true")?l.vF.info("[UserProfileContext] Auth error during authentication flow:",e.name):l.vF.warn("[UserProfileContext] Failed to get auth session:",e.message)}let r=await fetch(t,{headers:{"Content-Type":"application/json","Cache-Control":"no-cache",Authorization:n?"Bearer ".concat(n):"","X-Dashboard-Route":"true"}});if(!r.ok){if(401===r.status||403===r.status){l.vF.info("[UserProfileContext] Auth error (".concat(r.status,") accessing profile API"));let t=await w().catch(e=>(l.vF.debug("[UserProfileContext] Also failed to get Cognito attributes:",e.name),null));if(t)return l.vF.info("[UserProfileContext] Successfully retrieved profile from Cognito fallback"),h(t=>{let n=(0,a._)({},t);return delete n[e||"default"],n}),c({data:t,timestamp:Date.now(),tenantId:e,loading:!1,error:null}),t;let n={profile:{id:null,email:localStorage.getItem("email")||"",name:"",firstName:"",lastName:"",tenantId:e||"",role:"client",businessName:localStorage.getItem("businessName")||"",isMinimalProfile:!0,preferences:{theme:"light",notificationsEnabled:!0}}};return c({data:n,timestamp:Date.now(),tenantId:e,loading:!1,error:null}),h(t=>{let n=(0,a._)({},t);return delete n[e||"default"],n}),n}throw Error("HTTP error ".concat(r.status))}let o=await r.json();return l.vF.info("[UserProfileContext] Profile data fetched successfully"),c({data:o,timestamp:Date.now(),tenantId:e,loading:!1,error:null}),h(t=>{let n=(0,a._)({},t);return delete n[e||"default"],n}),o}catch(n){l.vF.error("[UserProfileContext] Error fetching profile data:",n.message),l.vF.info("[UserProfileContext] API request failed, trying to fetch from Cognito directly");let t=await w().catch(()=>null);if(t)return h(t=>{let n=(0,a._)({},t);return delete n[e||"default"],n}),t;if(i){l.vF.info("[UserProfileContext] Using minimal profile due to error during sign-up");let t={profile:{id:null,email:localStorage.getItem("emailForSignIn")||"",name:"",firstName:"",lastName:"",tenantId:e||localStorage.getItem("tenantId")||"",role:"client",businessName:localStorage.getItem("businessName")||"",isSigningUp:!0,preferences:{theme:"light",notificationsEnabled:!0}}};return c({data:t,timestamp:Date.now(),tenantId:e,loading:!1,error:null}),h(t=>{let n=(0,a._)({},t);return delete n[e||"default"],n}),t}return c(e=>(0,r._)((0,a._)({},e),{loading:!1,error:n.message})),h(t=>{let n=(0,a._)({},t);return delete n[e||"default"],n}),null}},[n,p,w]),I=(0,i.useMemo)(()=>d((e,t)=>C(e,t),300),[C]);(0,i.useEffect)(()=>{let e=localStorage.getItem("tenantId")||localStorage.getItem("businessid");n.data||n.loading||(l.vF.debug("[UserProfileContext] Initial profile fetch with tenantId:",e),I(e))},[I,n.data,n.loading]);let P=(0,i.useMemo)(()=>{var e;return{profileData:(null==(e=n.data)?void 0:e.profile)||null,loading:n.loading,error:n.error,timestamp:n.timestamp,fetchProfile:(e,t)=>I(e,t),clearProfileCache:b,isCacheValid:e=>n.data&&n.tenantId===e&&n.timestamp&&Date.now()-n.timestamp<3e5}},[n,I,b]);return(0,o.jsx)(m.Provider,{value:P,children:t})}}}]);