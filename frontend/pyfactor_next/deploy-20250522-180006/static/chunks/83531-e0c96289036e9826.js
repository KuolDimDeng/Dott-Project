"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[83531],{60005:(e,t,r)=>{r.d(t,{GC:()=>f,refreshUserSession:()=>m,w8:()=>g});var n=r(24818),o=r(42749),i=r(27494),s=r(60584),a=r(29670);try{window.__APP_CACHE||(window.__APP_CACHE={}),window.__APP_CACHE.auth||(window.__APP_CACHE.auth={}),(window.__APP_CACHE.auth.idToken||(0,a.gd)("idToken"))&&!window.__APP_CACHE.auth.token&&(o.vF.info("[Auth] Migrating from ID token to access token auth"),(0,n.$)().then(e=>{var t,r;(null==e||null==(t=e.tokens)?void 0:t.accessToken)&&(window.__APP_CACHE.auth.token=e.tokens.accessToken.toString(),(0,a.mm)("token",e.tokens.accessToken.toString()),(null==e||null==(r=e.tokens)?void 0:r.idToken)&&(window.__APP_CACHE.auth.idToken=e.tokens.idToken.toString(),(0,a.mm)("idToken",e.tokens.idToken.toString())),o.vF.info("[Auth] Successfully migrated to access token auth"))}).catch(e=>{o.vF.warn("[Auth] Failed to migrate to access token auth:",e)}))}catch(e){o.vF.error("[Auth] Error in token migration:",e)}let u=!1,c=0,d=null,l=0,h=0;function g(){if(!window.__hubProtectionInitialized){o.vF.debug("[Hub Protection] Setting up token refresh event deduplication");let e=s.Hub.dispatch,t=new Map;s.Hub.dispatch=function(r,n){if("auth"===r&&"tokenRefresh"===n.event){let e=Date.now(),r="".concat(n.event);if(t.has(r)){let i=t.get(r);if(e-i<2e3)return void o.vF.debug("[Hub Protection] Dropping duplicate event: ".concat(n.event," (").concat(e-i,"ms ago)"))}if(t.set(r,e),t.size>25){let e=Array.from(t.keys())[0];t.delete(e)}}return e.call(this,r,n)},window.__hubProtectionInitialized=!0,o.vF.debug("[Hub Protection] Hub event deduplication initialized")}}function f(){try{return window.__APP_CACHE||(window.__APP_CACHE={}),window.__APP_CACHE.auth||(window.__APP_CACHE.auth={}),window.__APP_CACHE.auth.provider||(o.vF.info('[Auth] Setting missing auth provider to "cognito" in APP_CACHE'),window.__APP_CACHE.auth.provider="cognito"),!0}catch(e){return o.vF.error("[Auth] Error ensuring auth provider:",e),!1}}g(),f(),setInterval(()=>{h=0},3e5);let m=async()=>{o.vF.info("[Auth] Attempting to refresh user session");try{if(u)return o.vF.info("[Auth] Another refresh is already in progress, waiting for it to complete"),d;let e=Date.now();if(e-c<2e4&&(o.vF.debug("[Auth] Refresh attempt too soon after previous attempt, using cached token"),e-l<9e5))return!0;return u=!0,c=e,d=(async()=>{try{var e,t,r,i,s,a;if(++h>3)return o.vF.warn("[Auth] Maximum refresh attempts (".concat(3,") reached")),await A();let u=null==(r=window)||null==(t=r.__APP_CACHE)||null==(e=t.auth)?void 0:e.provider;if(!u)return o.vF.warn("[Auth] No auth provider found in APP_CACHE"),await A();if("function"==typeof window.refreshAuthToken){o.vF.info("[Auth] Using refreshAuthToken function");let e=await window.refreshAuthToken();if(null==e?void 0:e.success)return o.vF.info("[Auth] Token refresh successful"),l=Date.now(),e.tokens&&w(e.tokens),!0}try{o.vF.info("[Auth] Attempting to refresh session using Amplify");let e=await (0,n.$)({forceRefresh:!0});if(null==e?void 0:e.tokens)return o.vF.info("[Auth] Amplify session refresh successful"),l=Date.now(),w({idToken:null==(i=e.tokens.idToken)?void 0:i.toString(),accessToken:null==(s=e.tokens.accessToken)?void 0:s.toString(),refreshToken:null==(a=e.tokens.refreshToken)?void 0:a.toString()}),!0}catch(e){o.vF.error("[Auth] Amplify refresh failed:",e)}if("cognito"===u&&window.AWS&&window.AWS.Cognito){o.vF.info("[Auth] Attempting Cognito session refresh");try{let e=window.AWS.Cognito.Auth;if(e&&"function"==typeof e.currentSession){let t=await e.currentSession();if(t)return l=Date.now(),w({idToken:t.getIdToken().getJwtToken(),accessToken:t.getAccessToken().getJwtToken(),refreshToken:t.getRefreshToken().getToken()}),o.vF.info("[Auth] Updated token in APP_CACHE via Cognito"),!0}}catch(e){o.vF.error("[Auth] Cognito refresh failed:",e)}}return await A()}finally{u=!1}})(),await d}catch(e){return o.vF.error("[Auth] Error refreshing session:",e),u=!1,await A()}};function w(e){try{if(window.__APP_CACHE||(window.__APP_CACHE={}),window.__APP_CACHE.auth||(window.__APP_CACHE.auth={}),e.accessToken){window.__APP_CACHE.auth.token=e.accessToken,(0,a.mm)("token",e.accessToken),window.__APP_CACHE.auth.provider="cognito";let t=(0,i.$n)(e.accessToken);t.exp&&(window.__APP_CACHE.auth.tokenExpiry=1e3*t.exp,(0,a.mm)("tokenExpiry",1e3*t.exp))}if(e.idToken){window.__APP_CACHE.auth.idToken=e.idToken,(0,a.mm)("idToken",e.idToken);let t=(0,i.$n)(e.idToken);t.sub&&(window.__APP_CACHE.auth.userId=t.sub,(0,a.mm)("userId",t.sub))}e.refreshToken&&(window.__APP_CACHE.auth.refreshToken=e.refreshToken,(0,a.mm)("refreshToken",e.refreshToken));let t=Date.now();return window.__APP_CACHE.auth.tokenTimestamp=t,(0,a.mm)("tokenTimestamp",t),window.__APP_CACHE.auth.hasSession=!0,(0,a.mm)("hasSession",!0),o.vF.debug("[RefreshSession] Stored tokens in APP_CACHE"),!0}catch(e){return o.vF.error("[AuthCache] Error storing tokens in APP_CACHE:",e),!1}}let A=async()=>{o.vF.warn("[Auth] Forcing relogin due to expired session");try{let e=window.location.pathname+window.location.search;return window.__APP_CACHE&&(window.__APP_CACHE.auth||(window.__APP_CACHE.auth={}),window.__APP_CACHE.auth.redirectAfterLogin=e,(0,a.mm)("redirectAfterLogin",e)),window.__APP_CACHE&&window.__APP_CACHE.auth&&(window.__APP_CACHE.auth.token=null,window.__APP_CACHE.auth.accessToken=null,window.__APP_CACHE.auth.refreshToken=null,window.__APP_CACHE.auth.hasSession=!1,window.__APP_CACHE.auth.tokenExpiry=null),window.toast&&"function"==typeof window.toast.error?window.toast.error("Your session has expired. Redirecting to login..."):alert("Your session has expired. Please log in again."),await new Promise(e=>setTimeout(e,2e3)),window.location.href="/login?expired=true&redirect="+encodeURIComponent(e),!1}catch(e){return o.vF.error("[Auth] Error in forceRelogin:",e),window.location.href="/login",!1}}},83531:(e,t,r)=>{r.d(t,{A:()=>v});var n=r(12115),o=r(35695),i=r(42749),s=r(60584),a=r(44367),u=r(60005),c=r(55166),d=r(68387),l=r(57247),h=r(21898),g=r(29670);let f={tenantId:null,lastUpdated:null},m=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{maxRetries:r=2,fallbackToAllowed:n=!0,criticalAttributes:o=["custom:tenant_ID","custom:subscription_plan"]}=t;if(!e||0===Object.keys(e).length)return{success:!1,error:"No attributes provided"};let s=(0,d._)((0,c._)({},e),{"custom:updated_at":new Date().toISOString()});try{if(i.vF.debug("[SafeAttributes] Updating attributes using resilient implementation"),await (0,h.rE)({userAttributes:s}),(0,g.mm)("user_attributes",s,{ttl:36e5}),e["custom:tenant_ID"]||e["custom:tenantId"]){let t=e["custom:tenant_ID"]||e["custom:tenantId"];f.tenantId=t,f.lastUpdated=Date.now(),(0,l.jJ)(t)}return{success:!0,updatedAttributes:Object.keys(e),partialSuccess:!1}}catch(t){if(i.vF.warn("[SafeAttributes] Error updating attributes using resilient implementation:",t),n){i.vF.warn("[SafeAttributes] Trying local storage fallbacks");let t={};if(o.forEach(r=>{e[r]&&(t[r]=e[r])}),Object.keys(t).length>0)return(0,g.mm)("user_attributes",(0,d._)((0,c._)({},(0,g.gd)("user_attributes")||{},t),{"custom:updated_at":new Date().toISOString(),"custom:recovery":"true"}),{ttl:2592e6}),t["custom:tenant_ID"]&&(0,l.jJ)(t["custom:tenant_ID"]),i.vF.info("[SafeAttributes] Stored critical attributes locally:",Object.keys(t)),{success:!0,partialSuccess:!0,updatedAttributes:Object.keys(t),storageType:"local"}}return{success:!1,error:t,message:(null==t?void 0:t.message)||"Unknown error updating attributes"}}};(0,u.w8)();let w={USER_PASSWORD:"ALLOW_USER_PASSWORD_AUTH"};function A(e){if(!e)return"An unknown error occurred";if(e.message){if("NotAuthorizedException"===e.code)return"Incorrect username or password";else if("UserNotFoundException"===e.code)return"Account not found";else if("InvalidParameterException"===e.code)return e.message.includes("password")?"Password does not meet requirements":e.message;else if("CodeMismatchException"===e.code)return"Incorrect verification code";else if("ExpiredCodeException"===e.code)return"Verification code has expired";else if("LimitExceededException"===e.code)return"Too many attempts, please try again later";else if("UnexpectedLambdaException"===e.name)return"There was a problem with the verification service. Please try again."}return e.message||"An error occurred"}function p(){return window.__APP_CACHE||(window.__APP_CACHE={}),window.__APP_CACHE.auth||(window.__APP_CACHE.auth={}),window.__APP_CACHE.auth}let v=()=>{let[e,t]=(0,n.useState)(!1),[c,d]=(0,n.useState)(!1),[l,h]=(0,n.useState)(null),[g,f]=(0,n.useState)(null),v=(0,o.useRouter)(),{refreshSession:_}=(0,a.w)(),P=(0,n.useRef)(!1),[k,C]=(0,n.useState)("");(0,n.useEffect)(()=>{if(c){let e=setTimeout(()=>{i.vF.debug("[Auth] Auto-resetting loading state after timeout"),d(!1)},15e3);return()=>clearTimeout(e)}let e=p();e&&e.auth_loading_state&&(i.vF.debug("[Auth] Detected previous loading state in app cache:",e.auth_loading_state),e.auth_loading_state=null)},[c]),(0,n.useEffect)(()=>{d(!1)},[]);let y=async e=>{try{return await m(e),!0}catch(e){return i.vF.error("[Auth] Error storing auth state in Cognito:",e),!1}},b=async e=>{try{i.vF.debug("[Auth] Creating user in backend:",{email:e.email,hasCognitoId:!!e.cognitoId});let t=await fetch("/api/auth/signup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e.email,first_name:e.firstName,last_name:e.lastName,cognito_id:e.cognitoId,confirmed:e.confirmed||!1,business_name:e.businessName,business_type:e.businessType,country:e.country,legal_structure:e.legalStructure})});if(!t.ok){let e=await t.json().catch(()=>({}));return i.vF.error("[Auth] Backend user creation failed:",{status:t.status,error:e.error||t.statusText}),!1}let r=await t.json();return i.vF.debug("[Auth] Backend user creation successful:",r),!0}catch(e){return i.vF.error("[Auth] Error creating backend user:",e),!1}},S=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;try{let t=await e();return i.vF.debug("[Auth] Operation completed successfully"),t}catch(r){if(i.vF.debug("[Auth] Operation failed (attempt ".concat(t+1,"/").concat(5,"):"),{error:r.message,code:r.code,name:r.name}),t<5&&(r.message.includes("network")||r.message.includes("timeout")||"NetworkError"===r.code)){let r=2e3*Math.pow(2,t);return i.vF.debug("[Auth] Retrying operation after ".concat(r,"ms (attempt ").concat(t+1,"/").concat(5,")")),await new Promise(e=>setTimeout(e,r)),S(e,t+1)}throw r}},E=async()=>{try{let e=0;for(let t of[async()=>{var e;i.vF.debug("[Auth] Trying validation method 1: fetchAuthSession");let t=await (0,s.fetchAuthSession)({forceRefresh:!0});return null!=t&&null!=(e=t.tokens)&&!!e.idToken},async()=>{i.vF.debug("[Auth] Trying validation method 2: getCurrentUser");let e=await (0,s.getCurrentUser)();return null!=e&&!!e.userId}]){e++;let r=0;for(;r<=2;){try{if(await t())return i.vF.debug("[Auth] Session validation successful via method ".concat(e," on attempt ").concat(r+1)),!0;i.vF.debug("[Auth] Method ".concat(e," returned false on attempt ").concat(r+1))}catch(t){i.vF.warn("[Auth] Method ".concat(e," failed on attempt ").concat(r+1,":"),t)}if(++r<=2){let t=500*Math.pow(2,r),n=Math.floor(300*Math.random()),o=t+n;i.vF.debug("[Auth] Retrying method ".concat(e," after ").concat(o,"ms")),await new Promise(e=>setTimeout(e,o))}}}let t=p();return null==t||t.bypassAuthValidation,i.vF.debug("[Auth] All authentication validation methods failed"),!1}catch(e){return i.vF.error("[Auth] Error during validation:",e),!1}},F=(0,n.useCallback)(async(e,r)=>{d(!0),h(null);try{let n=await S(async()=>{try{var t;return await (0,s.signIn)({username:e,password:r,options:{authFlowType:w.USER_PASSWORD,clientMetadata:{attempt_time:new Date().toISOString(),auth_flow:w.USER_PASSWORD,client_type:"web"}}}),i.vF.debug("[Auth] Sign in API call succeeded with result:",{authFlow:w.USER_PASSWORD,isSignedIn:n.isSignedIn,nextStep:null==(t=n.nextStep)?void 0:t.signInStep}),{success:!0,result:n}}catch(e){return i.vF.error("[Auth] Sign in API call error with flow ".concat(w.USER_PASSWORD,":"),{message:e.message,code:e.code,name:e.name}),{success:!1,error:e.message,code:e.code,name:e.name}}});if(n.hasNextStep&&"DONE"===n.nextStep)try{if(await E())t(!0);else throw i.vF.warn("[Auth] Sign-in appeared successful but session validation failed"),Error("Authentication failed. Please try again.")}catch(e){throw e}return h(null),d(!1),n.success&&(i.vF.debug("[handleSignIn] Sign in successful, redirecting to business info"),v.push("/onboarding/business-info")),n}catch(s){var n;let t=s.message||"Sign in failed",r=s.code||"unknown_error";i.vF.error("[Auth] Sign in failed:",{error:t,code:r,name:s.name,email:e,stack:null==(n=s.stack)?void 0:n.slice(0,500),timestamp:new Date().toISOString()});let o=t;return"NotAuthorizedException"===r?o="Incorrect username or password":"UserNotFoundException"===r?o="We couldn't find an account with this email address":"UserNotConfirmedException"===r?o="Please verify your email address before signing in":"PasswordResetRequiredException"===r?o="You need to reset your password":"TooManyRequestsException"===r||t.includes("too many")?o="Too many sign-in attempts. Please wait and try again later":t.includes("network")||"NetworkError"===r?o="Network error. Please check your internet connection and try again":"AbortError"===s.name||t.includes("timed out")?o="Sign in timed out. Please try again":t.includes("challenge")?o="Additional verification required. Please check your email":(t.includes("CAPTCHA")||t.includes("captcha"))&&(o="CAPTCHA verification failed. Please try again"),h(o),{success:!1,error:o,code:r,original:s.message}}finally{d(!1)}},[S,E]),T=(0,n.useCallback)(async()=>{i.vF.debug("[Auth] Signing out user...");try{let e=await (0,s.signOut)({global:!0});e&&e.success?i.vF.debug("[Auth] Sign out completed successfully"):i.vF.debug("[Auth] Sign out completed with unknown status"),t(!1),f(null);let r=p();r&&Object.keys(r).forEach(e=>{delete r[e]});try{i.vF.debug("[Auth] Clearing auth-related Cognito attributes"),await y({"custom:verificationInProgress":"false","custom:verificationCodeSent":"false","custom:signInInProgress":"false"})}catch(e){i.vF.warn("[Auth] Error clearing Cognito attributes during sign out:",e)}return window.location.href="/?signedOut=true",!0}catch(e){return i.vF.error("[Auth] Error signing out:",e),window.location.href="/?signedOut=error",!1}},[t,f]),I=(0,n.useCallback)(async e=>{i.vF.debug("[Auth] Starting signup process for user:",e.email),d(!0),h(null);try{i.vF.debug("[Auth] Starting sign up process",{email:e.email,hasPassword:!!e.password});let t={firstName:e.firstName,lastName:e.lastName,businessName:e.businessName,businessType:e.businessType,country:e.country,legalStructure:e.legalStructure,auto_confirm:"true"},{nextStep:r,signUpResponse:n}=await (0,s.signUp)({username:e.email,password:e.password,options:{userAttributes:{email:e.email,given_name:e.firstName,family_name:e.lastName},clientMetadata:t}});i.vF.debug("[Auth] Sign up API call completed",{nextStep:null==r?void 0:r.signUpStep,isSignUpComplete:!!(null==n?void 0:n.isSignUpComplete),hasUser:!!n});let o=(null==n?void 0:n.isSignUpComplete)===!0;try{i.vF.debug("[Auth] Auto-confirming user after signup:",e.email);let t=window.location.origin,r=await fetch("".concat(t,"/api/admin/confirm-user"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e.email})});if(r.ok){let t=await r.json();i.vF.debug("[Auth] User auto-confirmed successfully:",t);try{await y({"custom:userConfirmed":"true","custom:userEmail":e.email})}catch(e){i.vF.warn("[Auth] Error storing confirmation status in Cognito:",e)}}else try{let e,t=await r.text();try{e=JSON.parse(t)}catch(r){e={error:t||"Unknown error"}}i.vF.error("[Auth] Failed to auto-confirm user:",{status:r.status,statusText:r.statusText,errorDetails:e})}catch(e){i.vF.error("[Auth] Failed to auto-confirm user (parse error):",{status:r.status,statusText:r.statusText})}}catch(e){i.vF.error("[Auth] Error during auto-confirmation:",{error:e.message,stack:e.stack})}return await b({email:e.email,firstName:e.firstName,lastName:e.lastName,businessName:e.businessName,businessType:e.businessType,country:e.country,legalStructure:e.legalStructure,cognitoId:(null==n?void 0:n.userId)||"",confirmed:!0}),d(!1),{success:!0,nextStep:(null==r?void 0:r.signUpStep)||null,userId:null==n?void 0:n.userId,isComplete:o}}catch(e){return i.vF.error("[Auth] Sign up error:",e),h(e.message||"An error occurred during sign up"),{success:!1,error:e.message||"Failed to sign up",code:e.code}}finally{d(!1)}},[]),x=(0,n.useCallback)(async(e,t)=>{i.vF.debug("[Auth] handleConfirmSignUp called with:",{email:e,code:null==t?void 0:t.length});try{i.vF.debug("[Auth] Calling Amplify confirmSignUp with:",{username:e,confirmationCode:t});let r=await (0,s.confirmSignUp)({username:e,confirmationCode:t});i.vF.debug("[Auth] Amplify confirmation response:",r);let n=!0;try{i.vF.debug("[Auth] Creating user in backend after confirmation");let t=await S(async()=>{let t=await fetch("/api/auth/signup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,confirmed:!0,first_name:"",last_name:"",cognito_id:""})});if(401===t.status)return i.vF.debug("[Auth] Backend registration requires authentication, continuing with confirmation"),{success:!0,needsAuth:!0};if(!t.ok){let e=await t.json().catch(()=>({}));throw Error("Backend registration failed: ".concat(t.status," ").concat(e.message||t.statusText))}return await t.json()},3);i.vF.debug("[Auth] Backend user creation result:",t);try{sessionStorage.removeItem("pendingVerificationEmail"),sessionStorage.removeItem("verificationCodeSent");let e=p();e&&(e.verificationCodeSentAt&&delete e.verificationCodeSentAt,e.verificationInProgress&&delete e.verificationInProgress,e.verificationStartTime&&delete e.verificationStartTime)}catch(e){}}catch(e){i.vF.error("[Auth] Backend registration failed after successful confirmation:",e),n=!1}return{success:!0,backendSuccess:n}}catch(r){i.vF.error("[Auth] Confirmation error:",{message:r.message,code:r.code||"unknown"});let e=r.message||"An error occurred during confirmation",t=r.code||"unknown_error";return"CodeMismatchException"===t||e.includes("code mismatch")?e="The verification code is incorrect. Please try again.":"ExpiredCodeException"===t||e.includes("expired")?e="The verification code has expired. Please request a new code.":("TooManyRequestsException"===t||e.includes("too many attempts"))&&(e="Too many attempts. Please wait a moment and try again."),{success:!1,error:e,code:t}}},[S]);(0,n.useEffect)(()=>{(0,u.w8)();let e=async e=>{let{payload:t}=e;switch(i.vF.debug("[Auth] Auth event received:",t.event),t.event){case"signedIn":try{var n,o;let e=await (0,s.fetchAuthSession)({forceRefresh:!0});i.vF.debug("[Auth] Session fetched after sign in:",e),e.success&&(null==(o=e.session)||null==(n=o.tokens)?void 0:n.idToken)&&(f(e.session),P.current||await _(),i.vF.debug("[Auth] Session established after sign in"))}catch(e){i.vF.error("[Auth] Error handling sign in:",e)}break;case"signedOut":f(null),i.vF.debug("[Auth] Session cleared after sign out");break;case"tokenRefresh":try{let e=0,t=0;try{let{fetchUserAttributes:n}=await Promise.resolve().then(r.bind(r,60584)),o=await n();e=parseInt(o["custom:tokenRefreshCount"]||"0",10),t=parseInt(o["custom:lastTokenRefreshTime"]||"0",10)}catch(e){i.vF.warn("[Auth] Error getting refresh attributes from Cognito:",e)}let n=Date.now(),o=p();if(o&&o.tokenRefreshInProgress)return void i.vF.debug("[Auth] Token refresh already in progress, skipping");if(e>=3&&n-t<3e4){i.vF.error("[Auth] Too many token refresh attempts in short period, stopping refresh cycle"),await y({"custom:tokenRefreshCount":"0"}),o&&(o.tokenRefreshCooldown=n+6e4);return}if(o&&o.tokenRefreshCooldown&&n<o.tokenRefreshCooldown)return void i.vF.warn("[Auth] Token refresh in cooldown period, skipping");o&&(o.tokenRefreshInProgress=!0);try{await y({"custom:tokenRefreshCount":(e+1).toString(),"custom:lastTokenRefreshTime":n.toString()}),i.vF.debug("[Auth] Handling token refresh, attempt:",e+1),e>0&&await new Promise(e=>setTimeout(e,1e3));let t=await (0,s.fetchAuthSession)({forceRefresh:!0});i.vF.debug("[Auth] Session fetched after token refresh:",t)}finally{o&&(o.tokenRefreshInProgress=!1)}}catch(t){i.vF.error("[Auth] Error during token refresh:",t);let e=p();e&&(e.tokenRefreshInProgress=!1)}break;case"tokenRefresh_failure":i.vF.error("[Auth] Token refresh failed:",t.data),f(null),v.push("/auth/signin")}},t=s.Hub.listen("auth",e);return()=>t()},[v,_]);let H=(0,n.useCallback)(async e=>{i.vF.debug("[Auth] Attempting to resend verification code for:",e);let t=p();if(t&&t.verificationInProgress)return i.vF.debug("[Auth] Verification already in progress, preventing duplicate"),{success:!0,message:"Verification code is being sent. Please wait...",code:"InProgress"};t&&(t.verificationInProgress=!0,setTimeout(()=>{t&&(t.verificationInProgress=!1)},1e4));try{let n=!1,o=null;try{let{fetchUserAttributes:e}=await Promise.resolve().then(r.bind(r,60584)),t=await e();n="true"===t["custom:verificationInProgress"],o=t["custom:verificationStartTime"]}catch(e){i.vF.warn("[Auth] Error checking verification attributes:",e)}let a=Date.now();if(n&&o&&a-parseInt(o)<5e3)return i.vF.debug("[Auth] Verification in progress, preventing duplicate send"),window._verificationInProgress=!1,clearTimeout(window._verificationLockTimeout),{success:!0,message:"Verification code is being sent. Please wait...",code:"InProgress"};try{await y({"custom:verificationInProgress":"true","custom:verificationStartTime":a.toString()})}catch(e){i.vF.warn("[Auth] Failed to set verification status in Cognito:",e)}try{let e=null;if(t&&(e=t.verificationCodeSentAt,t.verificationCodeSent),!e)try{let{fetchUserAttributes:t}=await Promise.resolve().then(r.bind(r,60584)),n=await t();e=n["custom:verificationCodeSentAt"],n["custom:verificationCodeSent"]}catch(e){i.vF.warn("[Auth] Error checking code sent attributes:",e)}let n=Date.now();if(e&&n-parseInt(e)<3e4){i.vF.debug("[Auth] Code recently sent (last 30 seconds), preventing duplicate");try{await y({"custom:verificationInProgress":"false"})}catch(e){i.vF.warn("[Auth] Failed to clear verification status in Cognito:",e)}return t&&(t.verificationInProgress=!1),{success:!0,message:"Verification code was just sent. Please check your email inbox.",code:"RecentlySent"}}}catch(e){i.vF.debug("[Auth] Error checking recent verification code:",e)}i.vF.debug("[Auth] Resending sign up code for:",e);let u=await S(async()=>{try{let r=await (0,s.resendSignUpCode)({username:e});i.vF.debug("[Auth] Resend code API response:",r);try{let r=Date.now().toString();await y({"custom:verificationCodeSentAt":r,"custom:pendingVerificationEmail":e,"custom:verificationCodeSent":"true"}),t&&(t.verificationCodeSentAt=r,t.pendingVerificationEmail=e,t.verificationCodeSent="true")}catch(e){i.vF.warn("[Auth] Failed to store verification timestamp in Cognito:",e)}return{success:!0,destination:r.destination,deliveryMedium:r.deliveryMedium,attributeName:r.attributeName}}catch(e){var r,n;if(i.vF.error("[Auth] Error resending verification code:",{message:e.message,code:e.code,name:e.name}),"LimitExceededException"===e.code)return{success:!1,error:"You've reached the limit for verification code requests. Please try again later.",code:"LimitExceededException"};if((null==(r=e.message)?void 0:r.includes("already confirmed"))||"NotAuthorizedException"===e.code&&(null==(n=e.message)?void 0:n.includes("confirmed")))return{success:!1,error:"This account is already confirmed. Please try signing in.",code:"AlreadyConfirmed"};return{success:!1,error:A(e),code:e.code}}});if(i.vF.debug("[Auth] Resend code operation completed with result:",u),t&&(t.verificationInProgress=!1),!u.success)throw Error(u.error||"Failed to resend verification code");return i.vF.debug("[Auth] Operation completed successfully"),u}catch(t){i.vF.error("[Auth] Error in resendVerificationCode:",{message:t.message,code:t.code,name:t.name});let e=p();return e&&(e.verificationInProgress=!1),{success:!1,error:A(t),code:t.code||"UnknownError"}}},[S]);return{isAuthenticated:e,isLoading:c,authError:l,user:g,userData:g,signIn:F,signOut:T,signUp:I,confirmSignUp:x,resendVerificationCode:H,resetPassword:(0,n.useCallback)(async e=>{d(!0),h(null);try{i.vF.debug("[Auth] Starting password reset for:",e);let t=await S(async()=>{try{var t;let r=await (0,s.resetPassword)({username:e});return i.vF.debug("[Auth] Reset password code sent successfully:",{nextStep:null==(t=r.nextStep)?void 0:t.resetPasswordStep}),{success:!0,result:r}}catch(e){return i.vF.error("[Auth] API error sending reset password code:",{message:e.message,code:e.code,name:e.name}),{success:!1,error:e.message,code:e.code,name:e.name}}});if(!t.success)throw Error(t.error||"Failed to send reset code");return v.push("/auth/reset-password?email=".concat(encodeURIComponent(e))),{success:!0}}catch(o){let t=o.message||"Failed to send reset code",r=o.code||"unknown_error";i.vF.error("[Auth] Reset password request failed:",{error:t,code:r,email:e,name:o.name,stack:o.stack});let n=t;return"LimitExceededException"===r?n="Too many reset password attempts. Please try again later.":"UserNotFoundException"===r?n="We couldn't find an account with this email address.":t.includes("network")||"NetworkError"===r?n="Network error. Please check your internet connection and try again.":"InvalidParameterException"===r&&(n="Please enter a valid email address."),h(n),{success:!1,error:n,code:r}}finally{d(!1)}},[v,S]),confirmPasswordReset:(0,n.useCallback)(async(e,t,r)=>{d(!0),h(null);try{i.vF.debug("[Auth] Confirming password reset for:",e);let n=await S(async()=>{try{return await (0,s.confirmResetPassword)({username:e,confirmationCode:t,newPassword:r}),i.vF.debug("[Auth] Password reset confirmed successfully"),{success:!0}}catch(e){return i.vF.error("[Auth] API error confirming password reset:",{message:e.message,code:e.code,name:e.name}),{success:!1,error:e.message,code:e.code,name:e.name}}});if(!n.success)throw Error(n.error||"Failed to confirm password reset");return v.push("/auth/signin"),{success:!0}}catch(o){let t=o.message||"Failed to reset password",r=o.code||"unknown_error";i.vF.error("[Auth] Confirm password reset failed:",{error:t,code:r,email:e,name:o.name,stack:o.stack});let n=t;return"CodeMismatchException"===r?n="The verification code is incorrect. Please check and try again.":"ExpiredCodeException"===r?n="The verification code has expired. Please request a new code.":"LimitExceededException"===r?n="Too many attempts. Please try again later.":t.includes("network")||"NetworkError"===r?n="Network error. Please check your internet connection and try again.":("InvalidPasswordException"===r||t.includes("password"))&&(n="Password does not meet requirements. Please ensure it has at least 8 characters including uppercase, lowercase, numbers, and special characters."),h(n),{success:!1,error:n,code:r}}finally{d(!1)}},[v,S]),validateAuthentication:E,updateUserAttributes:m}}}}]);