"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[87887],{87887:(t,e,o)=>{o.d(e,{completeOnboarding:()=>i});var n=o(24818),a=o(42749);async function i(){var t,e,i,c,r,l,d,s,u,p,m;let g=Math.random().toString(36).substring(2,15),b=!1;a.vF.info("[completeOnboarding:".concat(g,"] Starting onboarding completion process"));let w={"custom:onboarding":"complete","custom:setupdone":"true","custom:updated_at":new Date().toISOString(),"custom:onboardingCompletedAt":new Date().toISOString()};try{window.__APP_CACHE=window.__APP_CACHE||{},window.__APP_CACHE.onboarding=window.__APP_CACHE.onboarding||{},window.__APP_CACHE.onboarding.status="complete",window.__APP_CACHE.onboarding.setupDone=!0,window.__APP_CACHE.onboarding.completedAt=new Date().toISOString(),window.__APP_CACHE.onboarding.lastUpdated=new Date().toISOString()}catch(t){a.vF.warn("[completeOnboarding:".concat(g,"] Failed to set app cache:"),t.message)}try{a.vF.debug("[completeOnboarding:".concat(g,"] Attempting direct Amplify update"));let{updateUserAttributes:c}=await Promise.all([o.e(31861),o.e(55158)]).then(o.bind(o,55158));await c({userAttributes:w}),a.vF.info("[completeOnboarding:".concat(g,"] Successfully updated via Amplify direct call")),b=!0;try{let o=await (0,n.$)(),c=null==o||null==(e=o.tokens)||null==(t=e.idToken)?void 0:t.payload,r=null==c||null==(i=c["custom:onboarding"])?void 0:i.toLowerCase();"complete"===r?a.vF.info("[completeOnboarding:".concat(g,"] Verified onboarding is now complete")):(a.vF.warn("[completeOnboarding:".concat(g,"] Attribute update succeeded but verification shows onboarding status is still: ").concat(r)),b=!1)}catch(t){a.vF.warn("[completeOnboarding:".concat(g,"] Could not verify attribute update:"),t.message)}}catch(t){a.vF.warn("[completeOnboarding:".concat(g,"] Direct Amplify update failed:"),t.message)}if(!b)try{a.vF.debug("[completeOnboarding:".concat(g,"] Attempting API update with token"));let t=await (0,n.$)(),e=null==t||null==(r=t.tokens)||null==(c=r.accessToken)?void 0:c.toString();if(!e)throw Error("No access token available");let o=await fetch("/api/user/update-attributes",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e),"X-Request-ID":g},body:JSON.stringify({attributes:w,forceUpdate:!0})});if(!o.ok)throw Error("API call failed with status: ".concat(o.status));let i=await o.json();a.vF.info("[completeOnboarding:".concat(g,"] API update successful:"),i),b=!0;try{await (0,n.$)({forceRefresh:!0});let t=await (0,n.$)(),e=null==t||null==(d=t.tokens)||null==(l=d.idToken)?void 0:l.payload,o=null==e||null==(s=e["custom:onboarding"])?void 0:s.toLowerCase();"complete"===o?a.vF.info("[completeOnboarding:".concat(g,"] Verified onboarding is complete with fresh session")):(a.vF.warn("[completeOnboarding:".concat(g,"] Attribute still not updated after API call. Status: ").concat(o)),b=!1)}catch(t){a.vF.warn("[completeOnboarding:".concat(g,"] Could not verify with fresh session:"),t.message)}}catch(t){a.vF.warn("[completeOnboarding:".concat(g,"] API update failed:"),t.message)}if(!b)try{a.vF.debug("[completeOnboarding:".concat(g,"] Attempting admin API endpoint"));let t=await fetch("/api/onboarding/setup/complete",{method:"POST",headers:{"Content-Type":"application/json","X-Force-Update":"true","X-Request-ID":g},body:JSON.stringify({forceComplete:!0,attributes:w})});if(!t.ok)throw Error("Admin API failed with status: ".concat(t.status));let e=await t.json();a.vF.info("[completeOnboarding:".concat(g,"] Admin API successful:"),e),b=!0}catch(t){a.vF.error("[completeOnboarding:".concat(g,"] Admin API failed:"),t.message);try{let t=await fetch("/api/onboarding/complete",{method:"POST",headers:{"Content-Type":"application/json","X-Request-ID":g},body:JSON.stringify({attributes:w})});if(!t.ok)throw Error("Backup API failed with status: ".concat(t.status));let e=await t.json();a.vF.info("[completeOnboarding:".concat(g,"] Backup API successful:"),e),b=!0}catch(t){a.vF.error("[completeOnboarding:".concat(g,"] All onboarding update methods failed:"),t.message)}}if(!b)try{let t=await (0,n.$)(),e=null==t||null==(p=t.tokens)||null==(u=p.idToken)?void 0:u.payload,o=null==e||null==(m=e["custom:onboarding"])?void 0:m.toLowerCase();"complete"===o&&(a.vF.info("[completeOnboarding:".concat(g,"] Found onboarding already complete despite update failures")),b=!0)}catch(t){a.vF.error("[completeOnboarding:".concat(g,"] Final verification check failed:"),t.message)}return a.vF.info("[completeOnboarding:".concat(g,"] Process completed with success=").concat(b)),b}}}]);