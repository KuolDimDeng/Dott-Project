// Tenant-specific dashboard page
// Uses the same dashboard content as the root dashboard

import { Suspense } from 'react';
import { redirect } from 'next/navigation';
import { serverLogger } from '@/utils/serverLogger';
import DashboardLoader from '@/components/DashboardLoader';
import MiddlewareHeaderHandler from '@/components/MiddlewareHeaderHandler';

// Export metadata
export const metadata = {
  title: 'Tenant Dashboard | Dott Business Management',
  description: 'Your tenant-specific dashboard',
};

// Simple tenant dashboard wrapper
export default function TenantDashboard({ params }) {
  try {
    const { tenantId } = params;
    
    if (!tenantId) {
      serverLogger.warn('[TenantDashboard] No tenant ID in params, redirecting to root dashboard');
      redirect('/dashboard');
    }
    
    serverLogger.info(`[TenantDashboard] Rendering for tenant: ${tenantId}`);
    
    return (
      <div>
        <MiddlewareHeaderHandler />
        {/* Onboarding fix script */}
        <script
          src={'/scripts/Version0003_fix_dashboard_cognito_onboarding.js'}
          defer
          async
          id="dashboard-onboarding-fix"
        />
        <Suspense fallback={<DashboardLoader message="Loading tenant dashboard..." />}>
          <div className="min-h-screen">
            <DashboardLoader message={`Loading dashboard for tenant ${tenantId}...`} />
            <script 
              dangerouslySetInnerHTML={{
                __html: `
                  // Ensure dashboard loads correctly with tenant ID
                  window.__TENANT_ID = "${tenantId}";
                  
                  // If there are any chunk loading errors, retry with a clean URL
                  window.addEventListener('error', function(e) {
                    if (e && e.message && e.message.includes('ChunkLoadError')) {
                      console.error('Caught chunk load error, trying to recover for tenant', "${tenantId}");
                      setTimeout(() => {
                        window.location.href = '/${tenantId}/dashboard?refresh=true&ts=' + Date.now();
                      }, 1000);
                    }
                  });
                  
                  // Attempt to load the dashboard content
                  document.addEventListener('DOMContentLoaded', function() {
                    // Check if we already have a dashboard content element
                    if (!document.getElementById('dashboard-content-loaded')) {
                      // Import the dashboard content script
                      const script = document.createElement('script');
                      script.src = '/dashboard-content.js';
                      script.defer = true;
                      script.id = 'dashboard-content-loaded';
                      document.body.appendChild(script);
                    }
                  });
                `
              }}
            />
          </div>
        </Suspense>
      </div>
    );
  } catch (error) {
    serverLogger.error('[TenantDashboard] Error rendering tenant dashboard:', error);
    return (
      <div>
        <DashboardLoader message="Recovering from error..." />
        <meta httpEquiv="x-dashboard-error" content="true" />
        <meta httpEquiv="x-error-message" content={error.message} />
      </div>
    );
  }
} 