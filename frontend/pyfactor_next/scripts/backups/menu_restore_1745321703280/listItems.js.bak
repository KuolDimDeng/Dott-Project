/**
 * @component MainListItems
 * @description 
 * IMPORTANT: THIS IS THE FINAL DESIGN AND LAYOUT FOR THE MAIN LIST MENU.
 * DO NOT MAKE ANY CHANGES TO THIS COMPONENT WITHOUT EXPRESS PERMISSION FROM THE OWNER.
 * This design was finalized on 2025-04-06 with the following specifications:
 * - Complete navigation menu system for the dashboard with collapsible sections
 * - Support for both expanded and icon-only views
 * - Custom SVG icons for all menu items
 * - Mobile and desktop responsive behavior
 * - Smooth animations and hover effects
 * 
 * Any changes require explicit approval from the project owner.
 */

'use client';

import React, { useState, useRef, useEffect, useCallback } from 'react';
import Image from 'next/image';
import { getCacheValue, setCacheValue } from '@/utils/appCache';
import { logger } from '@/utils/logger';
import { hasMenuAccess as checkMenuAccess, verifyTenantOwnership } from '@/utils/menuPrivileges';

// SVG Icons for menu items
const NavIcons = {
  AddCircle: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
  ),
  Dashboard: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
    </svg>
  ),
  Sales: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
    </svg>
  ),
  Contacts: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
    </svg>
  ),
  Inventory: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
    </svg>
  ),
  Shipping: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" />
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
    </svg>
  ),
  Payments: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
    </svg>
  ),
  Cart: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
    </svg>
  ),
  Bank: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
    </svg>
  ),
  Wallet: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
    </svg>
  ),
  Reports: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
  ),
  Analytics: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
    </svg>
  ),
  Receipt: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
  ),
  ChevronDown: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
    </svg>
  ),
  ChevronUp: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 15l7-7 7 7" />
    </svg>
  ),
  Home: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
    </svg>
  ),
  People: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
    </svg>
  ),
  Description: (props) => (
    <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
    </svg>
  )
};

// Helper icons for the inventory menu items (replacing MUI icons)
const InventoryIcons = {
  Dashboard: (props) => (
    <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
    </svg>
  ),
  People: (props) => (
    <svg className={props.className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
    </svg>
  )
};

const MENU_WIDTH = 258; // Increased to match the drawer width (260px, leaving 2px for borders)

// Add function to check menu access privileges
const hasMenuAccess = (menuName) => {
  try {
    // Use the more robust implementation from menuPrivileges.js
    return checkMenuAccess(menuName);
  } catch (error) {
    // Log error but default to restricting access for security
    logger.error(`[listItems] Error checking access for menu ${menuName}:`, error);
    return false;
  }
};

const MainListItems = ({
  handleMainDashboardClick,
  handleHomeClick,
  handleSalesClick,
  handlePaymentsClick,
  handlePurchasesClick,
  handleAccountingClick,
  handleBankingClick,
  handlePayrollClick,
  handleInventoryClick,
  handleReportClick,
  handleAnalysisClick,
  handleTaxesClick,
  handleCRMClick,
  handleTransportClick,
  handleHRClick,
  handleEmployeeManagementClick,
  handleShowCreateOptions,
  handleShowCreateMenu,
  handleDrawerClose,
  handleBillingClick = () => console.log('Billing clicked (default handler)'),
  isIconOnly = false,
  borderRightColor = 'transparent',
  borderRightWidth = '0px',
}) => {
  const [openMenu, setOpenMenu] = useState('');
  const [buttonWidth, setButtonWidth] = useState(0);
  const paperRef = useRef(null);
  const [hoveredItem, setHoveredItem] = useState(null);
  const [hoveredCreateOption, setHoveredCreateOption] = useState(null);
  const isMobile = useRef(window.innerWidth < 640);
  const [activeItem, setActiveItem] = useState(null);
  const [openTooltip, setOpenTooltip] = useState(null);
  // Add state for menu privileges
  const [userMenuPrivileges, setUserMenuPrivileges] = useState([]);
  const [privilegesLoaded, setPrivilegesLoaded] = useState(false);

  // Check if we're on mobile/small screens
  useEffect(() => {
    if (typeof window === 'undefined') return;
    
    const checkMobile = () => {
      isMobile.current = window.innerWidth < 640;
    };
    
    window.addEventListener('resize', checkMobile);
    checkMobile();
    
    return () => {
      window.removeEventListener('resize', checkMobile);
    };
  }, []);

  // Reset open menu when switching to icon-only mode
  useEffect(() => {
    if (isIconOnly) {
      setOpenMenu('');
    }
  }, [isIconOnly]);

  // Custom colors for menu items - these match the theme.js colors
  const navyBlue = '#0a3977';      // primary.main
  const hoverBgColor = '#f0f3f9';  // Very light blue-gray

  useEffect(() => {
    if (paperRef.current) {
      const paperWidth = paperRef.current.offsetWidth;
      setButtonWidth(paperWidth - 40); // 16px for left and right margin
    }
  }, []);

  // Load menu privileges when component mounts
  useEffect(() => {
    // Get initial privileges from cache
    const isOwner = getCacheValue('isBusinessOwner');
    
    // For owners, they have access to everything
    if (isOwner === true) {
      setUserMenuPrivileges('ALL');
      setPrivilegesLoaded(true);
    } else {
      // For employees, get their specific privileges
      const cachedPrivileges = getCacheValue('currentUserMenuPrivileges') || [];
      setUserMenuPrivileges(cachedPrivileges);
      setPrivilegesLoaded(true);
    }
    
    // Listen for privileges updates
    const handlePrivilegesLoaded = (event) => {
      const { menuPrivileges, isOwner } = event.detail;
      
      if (isOwner === true) {
        // Owner gets full access
        setUserMenuPrivileges('ALL');
        // Update cache as well
        setCacheValue('isBusinessOwner', true);
      } else {
        // Employee gets restricted access
        setUserMenuPrivileges(menuPrivileges || []);
        // Update cache as well
        setCacheValue('isBusinessOwner', false);
      }
    };
    
    if (typeof window !== 'undefined') {
      window.addEventListener('userMenuPrivilegesLoaded', handlePrivilegesLoaded);
      
      return () => {
        window.removeEventListener('userMenuPrivilegesLoaded', handlePrivilegesLoaded);
      };
    }
  }, []);

  const handleMenuToggle = (menuName) => {
    // If in icon-only mode, always open the drawer first
    if (isIconOnly && handleDrawerClose) {
      handleDrawerClose();
      return;
    }
    
    setOpenMenu((prevOpenMenu) => (prevOpenMenu === menuName ? '' : menuName));
    
    // Add a setTimeout to allow the DOM to update before scrolling
    setTimeout(() => {
      // Find the clicked menu item
      const menuItem = document.querySelector(`[data-menu-label="${menuName}"]`);
      if (menuItem) {
        // Scroll the menu item into view to ensure submenu is visible
        menuItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 100);
  };

  const handleItemClick = useCallback((item, e) => {
    setOpenTooltip && setOpenTooltip(null);
    if (e) e.stopPropagation();
    
    // Reset any active component state before navigating
    setActiveItem && setActiveItem(item);
    
    // Standardize the item key for routing
    const routeKey = item.toLowerCase().replace(/\s+/g, '-');
    
    // Create a unique navigation key to force component unmounting/remounting
    const navigationKey = `nav-${Date.now()}`;
    try {
      window.sessionStorage.setItem('lastNavKey', navigationKey);
    } catch (error) {
      console.warn('[listItems] Error setting navigation key in sessionStorage:', error);
    }
    
    // Create consistent event payload 
    const payload = { 
      item: routeKey, 
      navigationKey,
      // Include original item name for debugging
      originalItem: item
    };
    
    // Dispatch a custom event for navigation - both formats for compatibility
    window.dispatchEvent(new CustomEvent('menuNavigation', { detail: payload }));
    window.dispatchEvent(new CustomEvent('navigationChange', { detail: payload }));
    
    console.log(`[listItems] Navigating to ${item} (${routeKey}) with key ${navigationKey}`);
    
    // Cleanup previous state before navigating
    try {
      if (item.toLowerCase().includes('inventory')) {
        window.sessionStorage.removeItem('inventoryState');
        window.sessionStorage.removeItem('inventoryFilters');
      } else if (item.toLowerCase().includes('billing') || item.toLowerCase().includes('invoice')) {
        window.sessionStorage.removeItem('billingState');
        window.sessionStorage.removeItem('invoiceFilters');
      }
    } catch (error) {
      console.warn('[listItems] Error cleaning up previous state:', error);
    }
    
    // Handle different menu options
    if (item === 'inventory' || item === 'Inventory') {
      handleInventoryClick && handleInventoryClick('inventorydashboard');
    } else if (item === 'billing' || item === 'Billing') {
      handleBillingClick && handleBillingClick('invoices'); 
    } else if ((item === 'Dashboard' || item === 'dashboard') && handleMainDashboardClick) {
      handleMainDashboardClick();
    } else if ((item === 'Sales' || item === 'sales') && handleSalesClick) {
      handleSalesClick('dashboard');
    } else if ((item === 'CRM' || item === 'crm') && handleCRMClick) {
      handleCRMClick('dashboard');
    }
    // Add other handlers as needed
  }, [
    setOpenTooltip, 
    setActiveItem, 
    handleInventoryClick, 
    handleBillingClick, 
    handleMainDashboardClick,
    handleSalesClick,
    handleCRMClick
  ]);

  const handleMouseEnter = (menuName) => {
    setHoveredItem(menuName);
  };

  const handleMouseLeave = () => {
    setHoveredItem(null);
  };

  const menuItems = [
    {
      icon: <NavIcons.AddCircle className="w-5 h-5" />,
      label: 'Create New',
      onClick: handleShowCreateMenu,
      isSpecial: true,
    },
    {
      icon: <NavIcons.Dashboard className="w-5 h-5" />,
      label: 'Dashboard',
      onClick: handleMainDashboardClick,
    },
    {
      icon: <NavIcons.Wallet className="w-5 h-5" />,
      label: 'Billing',
      subItems: [
        { label: 'Invoices', onClick: handleBillingClick, value: 'invoices' },
        { label: 'Payments', onClick: handleBillingClick, value: 'payments' },
        { label: 'Subscriptions', onClick: handleBillingClick, value: 'subscriptions' },
        { label: 'Payment Methods', onClick: handleBillingClick, value: 'payment-methods' },
        { label: 'Reports', onClick: handleBillingClick, value: 'reports' },
      ],
    },
    {
      icon: <NavIcons.Sales className="w-5 h-5" />,
      label: 'Sales',
      subItems: [
        { label: 'Dashboard', onClick: handleSalesClick, value: 'dashboard' },
        { label: 'Products', onClick: handleSalesClick, value: 'products' },
        { label: 'Services', onClick: handleSalesClick, value: 'services' },
        { label: 'Estimates', onClick: handleSalesClick, value: 'estimates' },
        { label: 'Orders', onClick: handleSalesClick, value: 'orders' },
        { label: 'Invoices', onClick: handleSalesClick, value: 'invoices' },
        { label: 'Reports', onClick: handleSalesClick, value: 'reports' },
      ],
    },
    {
      icon: <NavIcons.Contacts className="w-5 h-5" />,
      label: 'CRM',
      subItems: [
        { label: 'Dashboard', onClick: handleCRMClick, value: 'dashboard' },
        { label: 'Customers', onClick: handleCRMClick, value: 'customers' },
        { label: 'Contacts', onClick: handleCRMClick, value: 'contacts' },
        { label: 'Leads', onClick: handleCRMClick, value: 'leads' },
        { label: 'Opportunities', onClick: handleCRMClick, value: 'opportunities' },
        { label: 'Deals', onClick: handleCRMClick, value: 'deals' },
        { label: 'Activities', onClick: handleCRMClick, value: 'activities' },
        { label: 'Campaigns', onClick: handleCRMClick, value: 'campaigns' },
        { label: 'Reports', onClick: handleCRMClick, value: 'reports' },
      ],
    },
    {
      icon: <NavIcons.Inventory className="w-5 h-5" />,
      label: 'Inventory',
      subItems: [
        { label: 'Dashboard', onClick: handleInventoryClick, value: 'inventorydashboard' },
        { label: 'Products', onClick: handleInventoryClick, value: 'items' },
        { label: 'Stock Adjustments', onClick: handleInventoryClick, value: 'stock-adjustments' },
        { label: 'Locations', onClick: handleInventoryClick, value: 'locations' },
        { label: 'Suppliers', onClick: handleInventoryClick, value: 'suppliers' },
        { label: 'Transactions', onClick: handleInventoryClick, value: 'transactions' },
        { label: 'Reports', onClick: handleInventoryClick, value: 'reports' },
      ],
    },
    {
      icon: <NavIcons.Shipping className="w-5 h-5" />,
      label: 'Transport',
      subItems: [
        { label: 'Dashboard', onClick: handleTransportClick, value: 'dashboard' },
        { label: 'Loads/Jobs', onClick: handleTransportClick, value: 'loads' },
        { label: 'Vehicle', onClick: handleTransportClick, value: 'equipment' },
        { label: 'Routes', onClick: handleTransportClick, value: 'routes' },
        { label: 'Expenses', onClick: handleTransportClick, value: 'expenses' },
        { label: 'Maintenance', onClick: handleTransportClick, value: 'maintenance' },
        { label: 'Compliance', onClick: handleTransportClick, value: 'compliance' },
        { label: 'Reports', onClick: handleTransportClick, value: 'reports' },
      ],
    },
    {
      icon: <NavIcons.Payments className="w-5 h-5" />,
      label: 'Payments',
      subItems: [
        { label: 'Dashboard', onClick: handlePaymentsClick, value: 'dashboard' },
        { label: 'Receive Payments', onClick: handlePaymentsClick, value: 'receive-payments' },
        { label: 'Make Payments', onClick: handlePaymentsClick, value: 'make-payments' },
        { label: 'Payment Methods', onClick: handlePaymentsClick, value: 'payment-methods' },
        { label: 'Recurring Payments', onClick: handlePaymentsClick, value: 'recurring-payments' },
        { label: 'Refunds', onClick: handlePaymentsClick, value: 'refunds' },
        { label: 'Payment Reconciliation', onClick: handlePaymentsClick, value: 'reconciliation' },
        { label: 'Payment Gateways', onClick: handlePaymentsClick, value: 'payment-gateways' },
        { label: 'Payment Plans', onClick: handlePaymentsClick, value: 'payment-plans' },
        { label: 'Reports', onClick: handlePaymentsClick, value: 'reports' },
      ],
    },
    {
      icon: <NavIcons.Cart className="w-5 h-5" />,
      label: 'Purchases',
      subItems: [
        { label: 'Dashboard', onClick: handlePurchasesClick, value: 'dashboard' },
        { label: 'Vendors', onClick: handlePurchasesClick, value: 'vendors' },
        { label: 'Purchase Orders', onClick: handlePurchasesClick, value: 'purchase-orders' },
        { label: 'Bills', onClick: handlePurchasesClick, value: 'bills' },
        { label: 'Expenses', onClick: handlePurchasesClick, value: 'expenses' },
        { label: 'Purchase Returns', onClick: handlePurchasesClick, value: 'purchase-returns' },
        { label: 'Procurement', onClick: handlePurchasesClick, value: 'procurement' },
        { label: 'Reports', onClick: handlePurchasesClick, value: 'reports' },
      ],
    },
    {
      icon: <NavIcons.Bank className="w-5 h-5" />,
      label: 'Accounting',
      subItems: [
        { label: 'Dashboard', onClick: handleAccountingClick, value: 'dashboard' },
        { label: 'Chart of Accounts', onClick: handleAccountingClick, value: 'chart-of-accounts' },
        { label: 'Journal Entries', onClick: handleAccountingClick, value: 'journal-entries' },
        { label: 'General Ledger', onClick: handleAccountingClick, value: 'general-ledger' },
        { label: 'Reconciliation', onClick: handleAccountingClick, value: 'reconciliation' },
        {
          label: 'Financial Statements',
          onClick: handleAccountingClick,
          value: 'financial-statements',
        },
        { label: 'Fixed Assets', onClick: handleAccountingClick, value: 'fixed-assets' },
        { label: 'Reports', onClick: handleAccountingClick, value: 'reports' },
      ],
    },
    {
      icon: <NavIcons.Wallet className="w-5 h-5" />,
      label: 'Banking',
      subItems: [
        { label: 'Dashboard', onClick: handleBankingClick, value: 'dashboard' },
        { label: 'Connect to Bank', onClick: handleBankingClick, value: 'connect' },
        { label: 'Bank Transactions', onClick: handleBankingClick, value: 'transactions' },
        { label: 'Bank Reconciliation', onClick: handleBankingClick, value: 'reconciliation' },
        { label: 'Reports', onClick: handleBankingClick, value: 'bank-reports' },
      ],
    },
    {
      icon: <NavIcons.People className="w-5 h-5" />,
      label: 'HR',
      subItems: [
        { label: 'Dashboard', onClick: handleHRClick, value: 'dashboard' },
        { 
          label: 'Employees', 
          onClick: () => {
            console.log('[listItems] Employees menu item clicked');
            // Dispatch a standardized navigation event
            const navigationKey = `nav-${Date.now()}`;
            const payload = { 
              item: 'employees', 
              navigationKey
            };
            
            // Dispatch navigation events for all listeners
            window.dispatchEvent(new CustomEvent('menuNavigation', { detail: payload }));
            
            // Call the handler directly if it exists
            if (typeof handleEmployeeManagementClick === 'function') {
              handleEmployeeManagementClick();
            } else if (typeof handleHRClick === 'function') {
              // Fallback to handleHRClick with employees section
              handleHRClick('employees');
            }
          }
        },
        { label: 'Timesheets', onClick: handleHRClick, value: 'timesheets' },
        { label: 'Taxes', onClick: handleHRClick, value: 'taxes' },
        { label: 'Benefits', onClick: handleHRClick, value: 'benefits' },
        { label: 'Reports', onClick: handleHRClick, value: 'reports' },
        { label: 'Performance', onClick: handleHRClick, value: 'performance' },
      ],
    },
    {
      icon: <NavIcons.Payments className="w-5 h-5" />,
      label: 'Payroll',
      subItems: [
        { label: 'Dashboard', onClick: handlePayrollClick, value: 'dashboard' },
        { label: 'Run Payroll', onClick: handlePayrollClick, value: 'run' },
        { label: 'Payroll Transactions', onClick: handlePayrollClick, value: 'transactions' },
        { label: 'Reports', onClick: handlePayrollClick, value: 'reports' },
      ],
    },
    {
      icon: <NavIcons.Receipt className="w-5 h-5" />,
      label: 'Taxes',
      subItems: [
        { label: 'Dashboard', onClick: handleTaxesClick, value: 'dashboard' },
        { label: 'Sales Tax', onClick: handleTaxesClick, value: 'sales-tax' },
        { label: 'Income Tax', onClick: handleTaxesClick, value: 'income-tax' },
        { label: 'Payroll Tax', onClick: handleTaxesClick, value: 'payroll-tax' },
        { label: 'Tax Payments', onClick: handleTaxesClick, value: 'tax-payments' },
        { label: 'Tax Forms', onClick: handleTaxesClick, value: 'tax-forms' },
        { label: 'Reports', onClick: handleTaxesClick, value: 'reports' },
      ],
    },
    {
      icon: <NavIcons.Reports className="w-5 h-5" />,
      label: 'Reports',
      subItems: [
        { label: 'Profit & Loss Statement', onClick: handleReportClick, value: 'income_statement' },
        { label: 'Balance Sheet', onClick: handleReportClick, value: 'balance_sheet' },
        { label: 'Cash Flow', onClick: handleReportClick, value: 'cash_flow' },
        { label: 'Sales Tax ', onClick: handleReportClick, value: 'sales_tax_report' },
        { label: 'Payroll Wage Tax', onClick: handleReportClick, value: 'payroll_wage_tax_report' },
        { label: 'Income by Customer', onClick: handleReportClick, value: 'income_by_customer' },
        { label: 'Aged Receivables', onClick: handleReportClick, value: 'aged_receivables' },
        { label: 'Purchases by Vendor', onClick: handleReportClick, value: 'purchases_by_vendor' },
        { label: 'Aged Payables', onClick: handleReportClick, value: 'aged_payables' },
        { label: 'Account Balances', onClick: handleReportClick, value: 'account_balances' },
        { label: 'Trial Balances', onClick: handleReportClick, value: 'trial_balance' },
        { label: 'General Ledger', onClick: handleReportClick, value: 'general_ledger' },
      ],
    },
    {
      icon: <NavIcons.Analytics className="w-5 h-5" />,
      label: 'Analytics',
      subItems: [
        { label: 'Dashboard', onClick: handleAnalysisClick, value: 'kpi-data' },
        { label: 'A.I Query', onClick: handleAnalysisClick, value: 'ai-query' },
      ],
    },
  ];

  const createOptions = [
    {
      label: 'Create New',
      description: 'Create a new transaction, invoice, or entity',
      icon: (props) => (
        <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
      ),
      onClick: (isIconOnly, handleDrawerClose, handleShowCreateMenu) => {
        console.log('Create New button clicked');
        if (isIconOnly) {
          handleDrawerClose();
        }
        // Use handleShowCreateMenu instead of showing a local dropdown
        if (typeof handleShowCreateMenu === 'function') {
          handleShowCreateMenu();
        } else {
          console.error('handleShowCreateMenu is not a function');
        }
      }
    },
    {
      label: 'Transaction',
      description: 'Create a new transaction',
      icon: (props) => (
        <svg className={props.className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
      ),
      onClick: (isIconOnly, handleDrawerClose, handleShowCreateMenu, handleShowCreateOptions) => {
        if (typeof handleShowCreateOptions === 'function') {
          handleShowCreateOptions('Transaction');
        }
      }
    },
    {
      label: 'Product',
      icon: <NavIcons.Inventory className="w-4 h-4" />,
      onClick: (isIconOnly, handleDrawerClose, handleShowCreateMenu, handleShowCreateOptions) => {
        if (typeof handleShowCreateOptions === 'function') {
          handleShowCreateOptions('Product');
        }
      },
      value: 'Product'
    },
    {
      label: 'Service',
      icon: <NavIcons.Receipt className="w-4 h-4" />,
      onClick: (isIconOnly, handleDrawerClose, handleShowCreateMenu, handleShowCreateOptions) => {
        if (typeof handleShowCreateOptions === 'function') {
          handleShowCreateOptions('Service');
        }
      },
      value: 'Service'
    },
    {
      label: 'Invoice',
      icon: <NavIcons.Description className="w-4 h-4" />,
      onClick: (isIconOnly, handleDrawerClose, handleShowCreateMenu, handleShowCreateOptions) => {
        if (typeof handleShowCreateOptions === 'function') {
          handleShowCreateOptions('Invoice');
        }
      },
      value: 'Invoice'
    },
    {
      label: 'Bill',
      icon: <NavIcons.Cart className="w-4 h-4" />,
      onClick: (isIconOnly, handleDrawerClose, handleShowCreateMenu, handleShowCreateOptions) => {
        if (typeof handleShowCreateOptions === 'function') {
          handleShowCreateOptions('Bill');
        }
      },
      value: 'Bill'
    },
    {
      label: 'Estimate',
      icon: <NavIcons.Reports className="w-4 h-4" />,
      onClick: (isIconOnly, handleDrawerClose, handleShowCreateMenu, handleShowCreateOptions) => {
        if (typeof handleShowCreateOptions === 'function') {
          handleShowCreateOptions('Estimate');
        }
      },
      value: 'Estimate'
    },
    {
      label: 'Customer',
      icon: <NavIcons.People className="w-4 h-4" />,
      onClick: (isIconOnly, handleDrawerClose, handleShowCreateMenu, handleShowCreateOptions) => {
        if (typeof handleShowCreateOptions === 'function') {
          handleShowCreateOptions('Customer');
        }
      },
      value: 'Customer'
    },
    {
      label: 'Vendor',
      icon: <NavIcons.Contacts className="w-4 h-4" />,
      onClick: (isIconOnly, handleDrawerClose, handleShowCreateMenu, handleShowCreateOptions) => {
        if (typeof handleShowCreateOptions === 'function') {
          handleShowCreateOptions('Vendor');
        }
      },
      value: 'Vendor'
    },
  ];

  // Create a Tailwind CSS based collapsible menu component to replace MUI Collapse
  const CollapsibleMenu = ({ isOpen, children }) => (
    <div className={`overflow-hidden transition-all duration-300 ease-in-out ${isOpen ? 'max-h-96' : 'max-h-0'}`}>
      {children}
    </div>
  );

  // Render the sub-menu using Tailwind instead of MUI components
  const renderSubMenu = (items, parentMenu) => (
    <CollapsibleMenu isOpen={openMenu === parentMenu}>
      <ul className="pl-10 mt-1">
        {items.map((item, index) => (
          <li key={index}>
            <button
              className={`flex items-center w-full text-left px-4 py-2 text-sm rounded-md
                ${hoveredItem === `${parentMenu}-${item.value}` ? 'bg-gray-100' : ''}
                hover:bg-gray-100 text-primary-main
              `}
              onClick={(event) => {
                if (item.subItems) {
                  handleMenuToggle(item.label);
                } else if (item.onClick && item.value) {
                  // For handlers that take a value parameter
                  if (typeof item.onClick === 'function') {
                    item.onClick(item.value);
                  }
                  // Also update our active item state
                  setActiveItem && setActiveItem(`${parentMenu}-${item.value}`);
                } else if (item.onClick) {
                  // For handlers without parameters
                  if (typeof item.onClick === 'function') {
                    item.onClick();
                  }
                  // Also update our active item state
                  setActiveItem && setActiveItem(item.label);
                }
              }}
              onMouseEnter={() => handleMouseEnter(`${parentMenu}-${item.value}`)}
              onMouseLeave={handleMouseLeave}
            >
              {item.label}
            </button>
          </li>
        ))}
      </ul>
    </CollapsibleMenu>
  );

  // Listen for navigation events from other components
  useEffect(() => {
    if (typeof window === 'undefined') return;
    
    const handleNavigationChange = (event) => {
      const { item, navigationKey } = event.detail;
      
      // Update active item if one is provided
      if (item && setActiveItem) {
        console.log(`[listItems] Navigation change detected for ${item}, updating active item`);
        setActiveItem(item);
      }
    };
    
    window.addEventListener('navigationChange', handleNavigationChange);
    
    return () => {
      window.removeEventListener('navigationChange', handleNavigationChange);
    };
  }, [setActiveItem]);
  
  // Listen for drawer state changes to reset menu state when drawer closes
  useEffect(() => {
    if (typeof window === 'undefined') return;
    
    const handleDrawerStateChange = () => {
      // Close any open menus when drawer state changes
      if (isIconOnly) {
        setOpenMenu('');
        setHoveredItem(null);
      }
    };
    
    window.addEventListener('drawerStateChanged', handleDrawerStateChange);
    
    return () => {
      window.removeEventListener('drawerStateChanged', handleDrawerStateChange);
    };
  }, [isIconOnly]);

  // Filter menuItems based on privileges before rendering
  const renderFilteredMenuItem = (item, index) => {
    // Owner users (with ALL privileges) can access everything
    if (userMenuPrivileges === 'ALL') {
      // Render the menu item as usual for owners
      return (
        <li
          key={`${item.key}-${index}`}
          className={`mb-1 ${isIconOnly ? '' : 'pr-3'}`}
          data-menu-item={item.key}
        >
          <button
            className={`flex items-center w-full rounded-md text-left ${
              isIconOnly ? 'justify-center py-3 px-0' : 'px-4 py-2'
            } ${
              hoveredItem === item.key
                ? 'text-white bg-blue-600 hover:bg-blue-700'
                : 'text-gray-700 hover:bg-gray-100'
            }`}
            onClick={(e) => handleItemClick(item.key, e)}
            onMouseEnter={() => handleMouseEnter(item.key)}
            onMouseLeave={handleMouseLeave}
          >
            <span className={`${isIconOnly ? '' : 'mr-3'}`}>
              {item.icon}
            </span>
            {!isIconOnly && <span>{item.text}</span>}
          </button>
        </li>
      );
    }
    
    // For regular employees, check if this user has access to this menu item
    if (!hasMenuAccess(item.key)) {
      return null;
    }
    
    // Otherwise render the menu item as usual
    return (
      <li
        key={`${item.key}-${index}`}
        className={`mb-1 ${isIconOnly ? '' : 'pr-3'}`}
        data-menu-item={item.key}
      >
        <button
          className={`flex items-center w-full rounded-md text-left ${
            isIconOnly ? 'justify-center py-3 px-0' : 'px-4 py-2'
          } ${
            hoveredItem === item.key
              ? 'text-white bg-blue-600 hover:bg-blue-700'
              : 'text-gray-700 hover:bg-gray-100'
          }`}
          onClick={(e) => handleItemClick(item.key, e)}
          onMouseEnter={() => handleMouseEnter(item.key)}
          onMouseLeave={handleMouseLeave}
        >
          <span className={`${isIconOnly ? '' : 'mr-3'}`}>
            {item.icon}
          </span>
          {!isIconOnly && <span>{item.text}</span>}
        </button>
      </li>
    );
  };

  return (
    <div className="relative">
      <div
        id="main-menu-container"
        className="w-full h-full overflow-x-hidden overflow-y-auto"
        style={{ borderRight: `${borderRightWidth} solid ${borderRightColor}` }}
      >
        <div
          ref={paperRef}
          className="w-full pt-4 bg-transparent"
          style={{ width: isIconOnly ? '60px' : MENU_WIDTH + 'px' }}
        >
          <nav className="w-full" aria-label="Main Navigation">
            <ul className="w-full space-y-0.5">
              {/* Create New button - Only call handleShowCreateMenu */}
              <li className={isIconOnly ? "px-[10px] py-2" : "px-3 py-2"}>
                <button
                  onClick={() => {
                    console.log("Create New button clicked");
                    // If in icon-only mode, also close the drawer
                    if (isIconOnly && typeof handleDrawerClose === 'function') {
                      handleDrawerClose();
                    }
                    // Call the external handleShowCreateMenu function to show the main menu
                    if (typeof handleShowCreateMenu === 'function') {
                      handleShowCreateMenu();
                    } else {
                      console.error("handleShowCreateMenu is not defined or not a function");
                    }
                  }}
                  className={`
                    flex items-center 
                    ${isIconOnly ? 'justify-center w-10 h-10 p-0 mx-auto' : 'w-full text-left py-3 px-4'}
                    bg-white text-primary-main font-medium
                    rounded-lg transition-all duration-200 border border-gray-200
                    hover:bg-blue-50 active:bg-blue-100
                    shadow-sm hover:shadow-md
                  `}
                  title={isIconOnly ? "Create New" : undefined}
                >
                  <span className={`${isIconOnly ? '' : 'w-7'} text-primary-main flex items-center justify-center`}>
                    <NavIcons.AddCircle className="w-5 h-5" />
                  </span>
                  {!isIconOnly && <span className="flex-1">Create New</span>}
                  {!isIconOnly && (
                    <svg className="w-4 h-4 ml-1 text-primary-main" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" />
                    </svg>
                  )}
                </button>
              </li>
              
              {/* Modified menu rendering to use filtered items */}
              <ul className="mb-4">
                {menuItems.map((item, index) => renderFilteredMenuItem(item, index))}
              </ul>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  );
};

export default MainListItems;