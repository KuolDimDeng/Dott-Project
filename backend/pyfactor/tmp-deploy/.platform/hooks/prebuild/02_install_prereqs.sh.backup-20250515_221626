#!/bin/bash
# Prebuild script updated by Version0011_ultimate_dependency_fix.py
# This script enforces compatible dependency versions before deployment

set -e   # Exit on error
set -x   # Print commands for debugging

echo "==== PREPARING ENVIRONMENT FOR CLEAN DEPLOY ===="
echo "Starting time: $(date)"

# Create a constraints file to enforce package versions
cat > /tmp/pip-constraints.txt << EOL
urllib3==1.26.16
boto3==1.26.164
botocore==1.29.164
s3transfer==0.6.2
EOL

echo "==== CONSTRAINTS FILE CREATED ===="
cat /tmp/pip-constraints.txt

# First, upgrade pip itself
echo "==== UPGRADING PIP ===="
pip install --upgrade pip==23.3.1 setuptools==69.0.3

# Force uninstall problematic packages
echo "==== REMOVING ANY CONFLICTING PACKAGES ===="
pip uninstall -y urllib3 boto3 botocore s3transfer awscli textract boto || true

# Install urllib3 first with no-dependencies to avoid conflicts
echo "==== INSTALLING URLLIB3 ===="
pip install urllib3==1.26.16 --no-dependencies

# Install AWS SDK components at compatible versions
echo "==== INSTALLING AWS SDK COMPONENTS ===="
pip install boto3==1.26.164 botocore==1.29.164 s3transfer==0.6.2 --no-dependencies

# Install critical packages explicitly with their exact versions
echo "==== INSTALLING CRITICAL PACKAGES ===="
pip install Django==4.2.10 gunicorn==21.2.0 psycopg2-binary==2.9.9

# Finally, install the rest of the requirements with constraints
echo "==== INSTALLING REMAINING REQUIREMENTS ===="
if [ -f "requirements-simple.txt" ]; then
    echo "Using simplified requirements file"
    pip install -r requirements-simple.txt --constraint /tmp/pip-constraints.txt
elif [ -f "requirements-eb.txt" ]; then
    echo "Using EB requirements file"
    pip install -r requirements-eb.txt --constraint /tmp/pip-constraints.txt
else
    echo "Using standard requirements file"
    pip install -r requirements.txt --constraint /tmp/pip-constraints.txt
fi

# Verify the installed versions
echo "==== VERIFYING INSTALLED VERSIONS ===="
pip list | grep -E 'urllib3|boto3|botocore|s3transfer'

echo "Prebuild prerequisites installed successfully at: $(date)"
