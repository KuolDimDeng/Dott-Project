#!/bin/bash
# Install PostgreSQL dependencies for Amazon Linux 2023
set -e

echo "Running PostgreSQL dependency installer for AL2023..."

# Install system packages if yum is available
if command -v yum &> /dev/null || command -v dnf &> /dev/null; then
    echo "Installing system packages using dnf/yum..."
    if command -v dnf &> /dev/null; then
        dnf -y update
        dnf -y install gcc-c++ python3-devel libpq-devel wget unzip make
        dnf -y install postgresql || echo "PostgreSQL client not available in main repos"
    else
        yum -y update
        yum -y install gcc-c++ python3-devel libpq-devel wget unzip make
        yum -y install postgresql || echo "PostgreSQL client not available in main repos"
    fi
else
    echo "dnf/yum not found. Skipping system package installation."
fi

# Set up PostgreSQL repository if needed
if ! command -v psql &> /dev/null; then
    echo "PostgreSQL client not installed. Attempting alternative installation..."
    
    # Try amazon-linux-extras for AL2
    if command -v amazon-linux-extras &> /dev/null; then
        echo "Using amazon-linux-extras to install PostgreSQL..."
        amazon-linux-extras enable postgresql14 || echo "Could not enable postgresql with amazon-linux-extras"
        yum -y install postgresql || echo "Failed to install postgresql with yum"
    fi
    
    # Check if we have PostgreSQL client now
    if ! command -v psql &> /dev/null; then
        echo "Still no PostgreSQL client. Using direct download as fallback..."
        
        # Create a temp directory
        TEMP_DIR=$(mktemp -d)
        cd $TEMP_DIR
        
        # Download PostgreSQL binaries
        wget -q https://ftp.postgresql.org/pub/binary/v14.9/linux-x86_64/postgresql-14.9-linux-x86_64.tar.gz
        tar -xzf postgresql-14.9-linux-x86_64.tar.gz
        
        # Install to /usr/local
        cd postgresql-14.9-1-linux-x86_64
        cp -r bin/* /usr/local/bin/
        cp -r lib/* /usr/local/lib/ || echo "Could not copy lib files, continuing..."
        cp -r include/* /usr/local/include/ || echo "Could not copy include files, continuing..."
        
        # Clean up
        cd /
        rm -rf $TEMP_DIR
        
        echo "Alternative PostgreSQL client installation completed."
    fi
fi

# Create symbolic links for library detection if needed
if [ -d "/usr/pgsql-14" ]; then
    echo "Creating symlinks for PostgreSQL libraries..."
    ln -sf /usr/pgsql-14/lib/libpq.so /usr/lib/libpq.so || echo "Failed to create libpq.so symlink"
    ln -sf /usr/pgsql-14/lib/libpq.so.5 /usr/lib/libpq.so.5 || echo "Failed to create libpq.so.5 symlink"
    ln -sf /usr/pgsql-14/include /usr/include/postgresql || echo "Failed to create include symlink"
fi

# Set environment variables for psycopg2 build
export LDFLAGS="-L/usr/lib -L/usr/local/lib -L/usr/pgsql-14/lib"
export CPPFLAGS="-I/usr/include -I/usr/local/include -I/usr/pgsql-14/include"

echo "PostgreSQL dependency setup completed successfully!"
exit 0
