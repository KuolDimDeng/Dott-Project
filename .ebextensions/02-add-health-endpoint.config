container_commands:
  01_add_root_health_endpoint:
    command: |
      # Add root health endpoint to current Django URLs
      URLS_FILE="/opt/python/current/app/pyfactor/urls.py"
      if [ -f "$URLS_FILE" ]; then
        # Create backup
        cp "$URLS_FILE" "$URLS_FILE.backup.$(date +%s)"
        
        # Check if root health endpoint already exists
        if ! grep -q "path('', " "$URLS_FILE"; then
          # Add a simple root health endpoint
          sed -i "/path('health\/', health_check/a\\    path('', health_check, name='root_health')," "$URLS_FILE"
          echo "Added root health endpoint to Django URLs"
        else
          echo "Root health endpoint already exists"
        fi
        
        # Also ensure /health/ path works
        if ! grep -q "path('health\/', health_check" "$URLS_FILE"; then
          # Add health endpoint if missing
          sed -i "/# Add health check endpoints for AWS/a\\    path('health/', health_check, name='health_check')," "$URLS_FILE"
          echo "Added /health/ endpoint to Django URLs"
        fi
        
        echo "Current Django URLs after modification:"
        tail -20 "$URLS_FILE"
      else
        echo "Django URLs file not found at $URLS_FILE"
      fi
  
  02_restart_django_wsgi:
    command: "touch /opt/python/current/app/pyfactor/wsgi.py"
    
  03_verify_django_health:
    command: |
      sleep 10
      echo "Testing Django health endpoints..."
      curl -f http://localhost:8000/ || echo "Root endpoint test failed"
      curl -f http://localhost:8000/health/ || echo "Health endpoint test failed"
      echo "Django health endpoint tests completed"
