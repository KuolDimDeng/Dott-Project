files:
  "/opt/python/current/app/simple_health.py":
    mode: "000644"
    owner: wsgi
    group: wsgi
    content: |
      # Simple health endpoint for ALB
      from django.http import HttpResponse
      
      def health_check(request):
          """Simple health check that always returns 200 OK"""
          return HttpResponse("OK", content_type="text/plain", status=200)

  "/opt/python/current/app/health_urls.py":
    mode: "000644"
    owner: wsgi
    group: wsgi
    content: |
      # Health URLs for ALB
      from django.urls import path
      from simple_health import health_check
      
      urlpatterns = [
          path('health/', health_check, name='health'),
      ]

container_commands:
  01_update_main_urls:
    command: |
      cat >> /opt/python/current/app/pyfactor/urls.py << 'URLS_EOF'
      
      # Add simple health endpoint for ALB
      from django.urls import path, include
      try:
          from simple_health import health_check
          # Add health endpoint to main urlpatterns
          if any('health' not in str(pattern) for pattern in urlpatterns):
              urlpatterns.append(path('health/', health_check, name='simple_health'))
      except ImportError:
          pass
      URLS_EOF
  
  02_restart_wsgi:
    command: "touch /opt/python/current/app/pyfactor/wsgi.py"
    
  03_test_health_endpoint:
    command: |
      sleep 5
      curl -f http://localhost:8000/health/ || echo "Health endpoint not ready yet"
